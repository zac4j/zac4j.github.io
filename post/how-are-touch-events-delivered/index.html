<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    
    <title>How Are Touch Events Delivered | Zac&#39;s Blog</title>
    <meta name="description" content="Android developer blog">
    <meta name="author" content="">
    
    <link rel="apple-touch-icon" sizes="180x180" href=https://zacash.cn/apple-touch-icon.png>
    <link rel="icon" type="image/png" sizes="32x32" href=https://zacash.cn/favicon-32x32.png>
    <link rel="icon" type="image/png" sizes="16x16" href=https://zacash.cn/favicon-16x16.png>
    <link rel="manifest" href=https://zacash.cn/site.webmanifest>
    <link rel="mask-icon" href=https://zacash.cn/safari-pinned-tab.svg color="#00416a">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="me" href="mailto:zac_ju@163.com">
    <link rel="me" href="https://github.com/zac4j">
    
    
    
    <link rel="authorization_endpoint" href=https://indieauth.com/auth />
    <link rel="token_endpoint" href=https://tokens.indieauth.com/token />
    
    
    
    
    
    <link rel="stylesheet" href=https://zacash.cn/css/fonts.css />
    <link rel="stylesheet" href=https://zacash.cn/css/style.css />
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="sitelogo">
        <a class="glyph" alt="Home" href="https://zacash.cn"><img src=https://zacash.cn/images/site-logo.svg alt="Site Logo" height="64px" width="64px"></a>
    </div>
    <header>
        <nav>
    
    <div id="page-nav">
        <div class="page-nav-item">
            <a href="https://zacash.cn">Home</a>
        </div>
        
            <div class="page-nav-item">
                <a href="/tags">
                    
                    <span>Tag</span>
                </a>
            </div>
        
            <div class="page-nav-item">
                <a href="/categories">
                    
                    <span>Category</span>
                </a>
            </div>
        
    </div>
</nav>
        
    </header>




<div id="content">
    <article class="h-entry">
        <header>
            <h1 class="post-title p-name">How Are Touch Events Delivered</h1>
            
            <p class="post-date">Posted on
                <time class="dt-published" datetime="2020-07-11T08:37:45&#43;08:00">
                    11 July, 2020 at 08:37 CST
                </time>  by <a href="https://zacash.cn" class="p-author h-card"
                    rel="author">Zac</a>
            </p>
            
            
        </header>
        <section class="content e-content">
            <p>根据例子来理解 Android 的事件传递</p>
<p>页面的布局结构</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span style="color:#f92672">&lt;layout</span> <span style="color:#a6e22e">xmlns:android=</span><span style="color:#e6db74">&#34;http://schemas.android.com/apk/res/android&#34;</span>
  <span style="color:#a6e22e">xmlns:app=</span><span style="color:#e6db74">&#34;http://schemas.android.com/apk/res-auto&#34;</span><span style="color:#f92672">&gt;</span>

  <span style="color:#f92672">&lt;data&gt;</span>
    <span style="color:#f92672">&lt;variable</span>
      <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;viewModel&#34;</span>
      <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;com.zac4j.system.data.TouchViewModel&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/data&gt;</span>

  <span style="color:#f92672">&lt;com.zac4j.system.ui.widget.CustomLayout</span>
    <span style="color:#a6e22e">android:id=</span><span style="color:#e6db74">&#34;@id/touch_sample_container&#34;</span>
    <span style="color:#a6e22e">android:layout_width=</span><span style="color:#e6db74">&#34;match_parent&#34;</span>
    <span style="color:#a6e22e">android:layout_height=</span><span style="color:#e6db74">&#34;match_parent&#34;</span><span style="color:#f92672">&gt;</span>

    <span style="color:#f92672">&lt;Button</span>
      <span style="color:#a6e22e">android:id=</span><span style="color:#e6db74">&#34;@id/touch_sample_btn&#34;</span>
      <span style="color:#a6e22e">style=</span><span style="color:#e6db74">&#34;@style/Widget.AppCompat.Button.Colored&#34;</span>
      <span style="color:#a6e22e">android:layout_width=</span><span style="color:#e6db74">&#34;match_parent&#34;</span>
      <span style="color:#a6e22e">android:layout_height=</span><span style="color:#e6db74">&#34;wrap_content&#34;</span>
      <span style="color:#a6e22e">android:text=</span><span style="color:#e6db74">&#34;Touch Me&#34;</span>
      <span style="color:#a6e22e">app:layout_constraintEnd_toEndOf=</span><span style="color:#e6db74">&#34;parent&#34;</span>
      <span style="color:#a6e22e">app:layout_constraintStart_toStartOf=</span><span style="color:#e6db74">&#34;parent&#34;</span>
      <span style="color:#a6e22e">app:layout_constraintTop_toTopOf=</span><span style="color:#e6db74">&#34;parent&#34;</span> <span style="color:#f92672">/&gt;</span>

  <span style="color:#f92672">&lt;/com.zac4j.system.ui.widget.CustomLayout&gt;</span>
<span style="color:#f92672">&lt;/layout&gt;</span>
</code></pre></div><h2 id="touchevent-的传递">TouchEvent 的传递</h2>
<p>我们通常对 Button 创建点击事件:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">touchSampleBtn.setOnClickListener {
    Logger.i(TAG, <span style="color:#e6db74">&#34;setOnClickListener&#34;</span>, <span style="color:#e6db74">&#34;sampleBtn clicked&#34;</span>)
}
</code></pre></div><p>可以先看下 View.dispatchTouchEvent() 的实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">public</span> boolean dispatchTouchEvent(MotionEvent event) {
    ...
    <span style="color:#66d9ef">if</span> (onFilterTouchEventForSecurity(event)) {
        <span style="color:#66d9ef">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) {
            result = <span style="color:#66d9ef">true</span>;
        }
        <span style="color:#75715e">//noinspection SimplifiableIfStatement
</span><span style="color:#75715e"></span>        ListenerInfo li = mListenerInfo;
        <span style="color:#66d9ef">if</span> (li != <span style="color:#66d9ef">null</span> &amp;&amp; li.mOnTouchListener != <span style="color:#66d9ef">null</span>
                &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED
                &amp;&amp; li.mOnTouchListener.onTouch(<span style="color:#66d9ef">this</span>, event)) {
            result = <span style="color:#66d9ef">true</span>;
        }

        <span style="color:#66d9ef">if</span> (!result &amp;&amp; onTouchEvent(event)) {
            result = <span style="color:#66d9ef">true</span>;
        }
    }
    ...
}
</code></pre></div><p>可以看到 <code>View.mOnTouchListener.onTouch()</code> 会在 <code>View.onTouchEvent()</code> 前判断是否执行，假如 <code>View.mOnTouchListener.onTouch()</code> 返回 true(消费该事件) 的话，<code>View.onTouchEvent()</code> 将不会执行。</p>
<p><code>View.mTouchListener.onTouch()</code> 的执行条件是:</p>
<ul>
<li>mTouchListener 不为空(即设置 <code>View.setOnTouchListener()</code> 方法)</li>
<li>View 是 enable 状态(未设置 <code>View.setEnable(false)</code> 方法)</li>
</ul>
<h2 id="viewgrouponintercepttouchevent">ViewGroup.onInterceptTouchEvent</h2>
<p>设置 <code>CustomLayout.onInterceptTouchEvent()</code> 返回 false，点击 touchSamleBtn 按钮.</p>
<pre><code class="language-log" data-lang="log"># MotionEvent.ACTION_DOWN 事件
I/ZacLog: Page -&gt; TouchFragment, View -&gt; CustomLayout, Method -&gt; dispatchTouchEvent, Msg -&gt; MotionEvent::ACTION_DOWN
I/ZacLog: Page -&gt; TouchFragment, View -&gt; CustomLayout, Method -&gt; onInterceptTouchEvent, Msg -&gt; MotionEvent::ACTION_DOWN
I/ZacLog: Page -&gt; TouchFragment, View -&gt; touchSampleBtn::AppCompatButton, Method -&gt; setOnTouchListener, Msg -&gt; MotionEvent::ACTION_DOWN
# MotionEvent.ACTION_UP 事件
I/ZacLog: Page -&gt; TouchFragment, View -&gt; CustomLayout, Method -&gt; dispatchTouchEvent, Msg -&gt; MotionEvent::ACTION_UP
I/ZacLog: Page -&gt; TouchFragment, View -&gt; CustomLayout, Method -&gt; onInterceptTouchEvent, Msg -&gt; MotionEvent::ACTION_UP
I/ZacLog: Page -&gt; TouchFragment, View -&gt; touchSampleBtn::AppCompatButton, Method -&gt; setOnTouchListener, Msg -&gt; MotionEvent::ACTION_UP
# View.onClick 事件
I/ZacLog: Page -&gt; TouchFragment, View -&gt; touchSampleBtn::AppCompatButton, Method -&gt; setOnClickListener, Msg -&gt; clicked
</code></pre><p>事件的传递: CustomLayout.dispatchTouchEvent() -&gt; CustomLayout.onInterceptTouchEvent() -&gt; View.mOnTouchListener.onTouch()</p>
<p>同时 MotionEvent.ACTION_DOWN + MotionEvent.ACTION_DOWN -&gt; View.mOnClickListener.onClick()</p>
<p>设置 <code>CustomLayout.onInterceptTouchEvent()</code> 返回 true，点击 touchSampleBtn.</p>
<pre><code class="language-log" data-lang="log">I/ZacLog: Page -&gt; TouchFragment, View -&gt; CustomLayout, Method -&gt; onInterceptTouchEvent, Msg -&gt; MotionEvent::ACTION_DOWN
I/ZacLog: Page -&gt; TouchFragment, View -&gt; touchSampleContainer::CustomLayout, Method -&gt; setOnTouchListener, Msg -&gt; MotionEvent::ACTION_DOWN
</code></pre><p>我们看下 ViewGroup.dispatchTouchEvent() 的实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">dispatchTouchEvent</span><span style="color:#f92672">(</span>MotionEvent ev<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInputEventConsistencyVerifier <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mInputEventConsistencyVerifier<span style="color:#f92672">.</span><span style="color:#a6e22e">onTouchEvent</span><span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// If the event targets the accessibility focused view and this is it, start
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// normal event dispatch. Maybe a descendant is what will handle the click.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ev<span style="color:#f92672">.</span><span style="color:#a6e22e">isTargetAccessibilityFocus</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> isAccessibilityFocusedViewOrHost<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">boolean</span> handled <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>onFilterTouchEventForSecurity<span style="color:#f92672">(</span>ev<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> action <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getAction</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> actionMasked <span style="color:#f92672">=</span> action <span style="color:#f92672">&amp;</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_MASK</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Handle an initial down.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_DOWN</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Throw away all previous state when starting a new touch gesture.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// The framework may have dropped the up or cancel event for the previous gesture
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// due to an app switch, ANR, or some other state change.
</span><span style="color:#75715e"></span>            cancelAndClearTouchTargets<span style="color:#f92672">(</span>ev<span style="color:#f92672">);</span>
            resetTouchState<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Check for interception.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> intercepted<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_DOWN</span>
                <span style="color:#f92672">||</span> mFirstTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> disallowIntercept <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mGroupFlags <span style="color:#f92672">&amp;</span> FLAG_DISALLOW_INTERCEPT<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>disallowIntercept<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                intercepted <span style="color:#f92672">=</span> onInterceptTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">);</span>
                ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setAction</span><span style="color:#f92672">(</span>action<span style="color:#f92672">);</span> <span style="color:#75715e">// restore action in case it was changed
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                intercepted <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// There are no touch targets and this action is not an initial down
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// so this view group continues to intercept touches.
</span><span style="color:#75715e"></span>            intercepted <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If intercepted, start normal event dispatch. Also if there is already
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// a view that is handling the gesture, do normal event dispatch.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>intercepted <span style="color:#f92672">||</span> mFirstTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Check for cancelation.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> canceled <span style="color:#f92672">=</span> resetCancelNextUpFlag<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_CANCEL</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Update list of touch targets for pointer down, if needed.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> split <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mGroupFlags <span style="color:#f92672">&amp;</span> FLAG_SPLIT_MOTION_EVENTS<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
        TouchTarget newTouchTarget <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> alreadyDispatchedToNewTouchTarget <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>canceled <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>intercepted<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

            <span style="color:#75715e">// If the event is targeting accessibility focus we give it to the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// view that has accessibility focus and if it does not handle it
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// we clear the flag and dispatch the event to all children as usual.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// We are looking up the accessibility focused host to avoid keeping
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// state since these events are very rare.
</span><span style="color:#75715e"></span>            View childWithAccessibilityFocus <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">isTargetAccessibilityFocus</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">?</span> findChildWithAccessibilityFocus<span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_DOWN</span>
                    <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>split <span style="color:#f92672">&amp;&amp;</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_POINTER_DOWN</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_HOVER_MOVE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> actionIndex <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getActionIndex</span><span style="color:#f92672">();</span> <span style="color:#75715e">// always 0 for down
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> idBitsToAssign <span style="color:#f92672">=</span> split <span style="color:#f92672">?</span> 1 <span style="color:#f92672">&lt;&lt;</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getPointerId</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">)</span>
                        <span style="color:#f92672">:</span> TouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">ALL_POINTER_IDS</span><span style="color:#f92672">;</span>

                <span style="color:#75715e">// Clean up earlier touch targets for this pointer id in case they
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// have become out of sync.
</span><span style="color:#75715e"></span>                removePointersFromTouchTargets<span style="color:#f92672">(</span>idBitsToAssign<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childrenCount <span style="color:#f92672">=</span> mChildrenCount<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newTouchTarget <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> childrenCount <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">float</span> x <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getX</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">float</span> y <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getY</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">);</span>
                    <span style="color:#75715e">// Find a child that can receive the event.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// Scan children from front to back.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">final</span> ArrayList<span style="color:#f92672">&lt;</span>View<span style="color:#f92672">&gt;</span> preorderedList <span style="color:#f92672">=</span> buildTouchDispatchChildList<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> customOrder <span style="color:#f92672">=</span> preorderedList <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                            <span style="color:#f92672">&amp;&amp;</span> isChildrenDrawingOrderEnabled<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">final</span> View<span style="color:#f92672">[]</span> children <span style="color:#f92672">=</span> mChildren<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> childrenCount <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span> i <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">;</span> i<span style="color:#f92672">--)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childIndex <span style="color:#f92672">=</span> getAndVerifyPreorderedIndex<span style="color:#f92672">(</span>
                                childrenCount<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> customOrder<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">final</span> View child <span style="color:#f92672">=</span> getAndVerifyPreorderedView<span style="color:#f92672">(</span>
                                preorderedList<span style="color:#f92672">,</span> children<span style="color:#f92672">,</span> childIndex<span style="color:#f92672">);</span>

                        <span style="color:#75715e">// If there is a view that has accessibility focus we want it
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// to get the event first and if not handled we will perform a
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// normal dispatch. We may do a double iteration but this is
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// safer given the timeframe.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childWithAccessibilityFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childWithAccessibilityFocus <span style="color:#f92672">!=</span> child<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                            childWithAccessibilityFocus <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                            i <span style="color:#f92672">=</span> childrenCount <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>

                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>child<span style="color:#f92672">.</span><span style="color:#a6e22e">canReceivePointerEvents</span><span style="color:#f92672">()</span>
                                <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>isTransformedTouchPointInView<span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> y<span style="color:#f92672">,</span> child<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                            ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>

                        newTouchTarget <span style="color:#f92672">=</span> getTouchTarget<span style="color:#f92672">(</span>child<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#75715e">// Child is already receiving touch within its bounds.
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// Give it the new pointer in addition to the ones it is handling.
</span><span style="color:#75715e"></span>                            newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">pointerIdBits</span> <span style="color:#f92672">|=</span> idBitsToAssign<span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>

                        resetCancelNextUpFlag<span style="color:#f92672">(</span>child<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dispatchTransformedTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> child<span style="color:#f92672">,</span> idBitsToAssign<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                            <span style="color:#75715e">// Child wants to receive touch within its bounds.
</span><span style="color:#75715e"></span>                            mLastTouchDownTime <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getDownTime</span><span style="color:#f92672">();</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preorderedList <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#75715e">// childIndex points into presorted list, find original index
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;</span> childrenCount<span style="color:#f92672">;</span> j<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>children<span style="color:#f92672">[</span>childIndex<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> mChildren<span style="color:#f92672">[</span>j<span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
                                        mLastTouchDownIndex <span style="color:#f92672">=</span> j<span style="color:#f92672">;</span>
                                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                                    <span style="color:#f92672">}</span>
                                <span style="color:#f92672">}</span>
                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                                mLastTouchDownIndex <span style="color:#f92672">=</span> childIndex<span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                            mLastTouchDownX <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getX</span><span style="color:#f92672">();</span>
                            mLastTouchDownY <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getY</span><span style="color:#f92672">();</span>
                            newTouchTarget <span style="color:#f92672">=</span> addTouchTarget<span style="color:#f92672">(</span>child<span style="color:#f92672">,</span> idBitsToAssign<span style="color:#f92672">);</span>
                            alreadyDispatchedToNewTouchTarget <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>

                        <span style="color:#75715e">// The accessibility focus didn&#39;t handle the event, so clear
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// the flag and do a normal dispatch to all children.
</span><span style="color:#75715e"></span>                        ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preorderedList <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> preorderedList<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newTouchTarget <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mFirstTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Did not find a child to receive the event.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// Assign the pointer to the least recently added target.
</span><span style="color:#75715e"></span>                    newTouchTarget <span style="color:#f92672">=</span> mFirstTouchTarget<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        newTouchTarget <span style="color:#f92672">=</span> newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">pointerIdBits</span> <span style="color:#f92672">|=</span> idBitsToAssign<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Dispatch to touch targets.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFirstTouchTarget <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// No touch targets so treat this as an ordinary view.
</span><span style="color:#75715e"></span>            handled <span style="color:#f92672">=</span> dispatchTransformedTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> canceled<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                    TouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">ALL_POINTER_IDS</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Dispatch to touch targets, excluding the new touch target if we already
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// dispatched to it.  Cancel touch targets if necessary.
</span><span style="color:#75715e"></span>            TouchTarget predecessor <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            TouchTarget target <span style="color:#f92672">=</span> mFirstTouchTarget<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> TouchTarget next <span style="color:#f92672">=</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>alreadyDispatchedToNewTouchTarget <span style="color:#f92672">&amp;&amp;</span> target <span style="color:#f92672">==</span> newTouchTarget<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    handled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> cancelChild <span style="color:#f92672">=</span> resetCancelNextUpFlag<span style="color:#f92672">(</span>target<span style="color:#f92672">.</span><span style="color:#a6e22e">child</span><span style="color:#f92672">)</span>
                            <span style="color:#f92672">||</span> intercepted<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dispatchTransformedTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> cancelChild<span style="color:#f92672">,</span>
                            target<span style="color:#f92672">.</span><span style="color:#a6e22e">child</span><span style="color:#f92672">,</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">pointerIdBits</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        handled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cancelChild<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>predecessor <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            mFirstTouchTarget <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                            predecessor<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        target<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
                        target <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                predecessor <span style="color:#f92672">=</span> target<span style="color:#f92672">;</span>
                target <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Update list of touch targets for pointer up or cancel, if needed.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>canceled
                <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_UP</span>
                <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_HOVER_MOVE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            resetTouchState<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>split <span style="color:#f92672">&amp;&amp;</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_POINTER_UP</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> actionIndex <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getActionIndex</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> idBitsToRemove <span style="color:#f92672">=</span> 1 <span style="color:#f92672">&lt;&lt;</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getPointerId</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">);</span>
            removePointersFromTouchTargets<span style="color:#f92672">(</span>idBitsToRemove<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>handled <span style="color:#f92672">&amp;&amp;</span> mInputEventConsistencyVerifier <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mInputEventConsistencyVerifier<span style="color:#f92672">.</span><span style="color:#a6e22e">onUnhandledEvent</span><span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> handled<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div>
        </section>
        <footer>
            <a class="permalink u-url" href="https://zacash.cn/post/how-are-touch-events-delivered/">🔗</a>
            
        </footer>
    </article>
</div>

    
    <div class="h-card">
      <img class="u-photo" src="https://zacash.cn/images/android-os.png" />
      <div class="card-content">
        <h2 class="card-name"><a class="p-name u-url" href="https://zacash.cn" rel="me">Zac</a></h2>
        <p class="card-subhead">
          <span class="p-locality">Shanghai</span>,
          <span class="p-country-name">China</span><br />
          <a class="u-email" href="mailto:zac_ju@163.com">Email me</a>
        </p>
      </div>
      <p class="p-note">🐭</p>
    </div>
    
    <div id="footer">
      
      <nav id="article-skip">
        <div class="next">
          
          <a alt="Newer article" href="https://zacash.cn/post/intro-to-hashmap/">&larr; Newer</a>
          
        </div>
        <div class="top">
          <a alt="Top of page" href="#">Top</a>
        </div>
        <div class="prev">
          
          <a alt="Older article" href="https://zacash.cn/post/intro-to-hybrid-app/">Older &rarr;</a>
          
        </div>
      </nav>
      
      <aside id="social">
  <div id="social-icons">
    
    
    
    
    <div class="icon-24x24">
      <a class="glyph" alt="GitHub profile" href="https://github.com/zac4j"><img src=https://zacash.cn/icons/github.svg height="24px" width="24px"></a>
    </div>
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
</aside>

      
      <p class="copyright">
          Copyright © 2020, Copyright Zac
      </p>
      
    </div>


</body>
</html>