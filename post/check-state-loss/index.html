<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    
    <title>Check State Loss | Zac&#39;s Blog</title>
    <meta name="description" content="Fragment state loss">
    <meta name="author" content="">
    
    <link rel="apple-touch-icon" sizes="180x180" href=https://zacash.cn/apple-touch-icon.png>
    <link rel="icon" type="image/png" sizes="32x32" href=https://zacash.cn/favicon-32x32.png>
    <link rel="icon" type="image/png" sizes="16x16" href=https://zacash.cn/favicon-16x16.png>
    <link rel="manifest" href=https://zacash.cn/site.webmanifest>
    <link rel="mask-icon" href=https://zacash.cn/safari-pinned-tab.svg color="#00416a">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="me" href="mailto:zac_ju@163.com">
    <link rel="me" href="https://github.com/zac4j">
    
    
    
    <link rel="authorization_endpoint" href=https://indieauth.com/auth />
    <link rel="token_endpoint" href=https://tokens.indieauth.com/token />
    
    
    
    
    
    <link rel="stylesheet" href=https://zacash.cn/css/fonts.css />
    <link rel="stylesheet" href=https://zacash.cn/css/style.css />
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="sitelogo">
        <a class="glyph" alt="Home" href="https://zacash.cn"><img src=https://zacash.cn/images/site-logo.svg alt="Site Logo" height="64px" width="64px"></a>
    </div>
    <header>
        <nav>
    
    <div id="page-nav">
        <div class="page-nav-item">
            <a href="https://zacash.cn">Home</a>
        </div>
        
    </div>
</nav>
        
    </header>




<div id="content">
    <article class="h-entry">
        <header>
            <h1 class="post-title p-name">Check State Loss</h1>
            
            <p class="post-date">Posted on
                <time class="dt-published" datetime="2020-02-11T16:30:26&#43;08:00">
                    11 February, 2020 at 16:30 CST
                </time>  by <a href="https://zacash.cn" class="p-author h-card"
                    rel="author">Zac</a>
            </p>
            
            
            <p class="post-tag">Category:
                
                <a href="https://zacash.cn/categories/fragment" class="post-tag p-category">Fragment</a>
                
            </p>
            <hr class="post-underline">
            
        </header>
        <section class="content e-content">
            <h4 id="èƒŒæ™¯">èƒŒæ™¯</h4>
<p>æœ€è¿‘åšçš„ä¸€ä¸ª DialogFragment åœ¨å°‘æ•°è®¾å¤‡ä¸Šä¼šå¶å‘é—ªé€€ï¼ŒFabric ä¸Šçš„ Stacktrace ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Fatal Exception<span style="color:#f92672">:</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IllegalStateException</span><span style="color:#f92672">:</span> Can not perform <span style="color:#66d9ef">this</span> action after onSaveInstanceState
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FragmentManagerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">checkStateLoss</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FragmentManagerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">enqueueAction</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BackStackRecord</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitInternal</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BackStackRecord</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commit</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DialogFragment</span><span style="color:#f92672">.</span><span style="color:#a6e22e">show</span><span style="color:#f92672">(</span>SourceFile<span style="color:#960050;background-color:#1e0010">ï¼‰</span>
</code></pre></div><p>çœ‹èµ·æ¥æ˜¯å¼¹çª—åœ¨ show çš„æ—¶å€™ï¼Œå‘ç”Ÿäº† state lossï¼Œç²—ç•¥ copy äº†ä¸‹ StackOverflow ä¸Šçš„å›ç­”ï¼Œåšäº†å¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">fun <span style="color:#a6e22e">show</span><span style="color:#f92672">(</span>manager<span style="color:#f92672">:</span> FragmentManager<span style="color:#f92672">?)</span> <span style="color:#f92672">{</span>
 <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
   val ft <span style="color:#f92672">=</span> manager<span style="color:#f92672">?.</span><span style="color:#a6e22e">beginTransaction</span><span style="color:#f92672">()</span>
   ft<span style="color:#f92672">?.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;tag of dialog&#34;</span><span style="color:#f92672">)</span>
   ft<span style="color:#f92672">?.</span><span style="color:#a6e22e">commitAllowingStateLoss</span><span style="color:#f92672">()</span>
 <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>e<span style="color:#f92672">:</span> Exception<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

 <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>é‡å†™äº† show æ–¹æ³•ï¼Œå…è®¸ state lossï¼Œå¹¶åŠ äº†å¼‚å¸¸æ•æ‰ï¼Œåç»­è§‚å¯Ÿ Fabricï¼Œ show çš„æ—¶å€™çš„ç¡®æ²¡å†å‡ºç°å¼‚å¸¸æƒ…å†µï¼Œä½† dismiss çš„æ—¶å€™è¿˜æ˜¯æœ‰é—ªé€€å‡ºç°ï¼Œå¼‚å¸¸ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Fatal Exception<span style="color:#f92672">:</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IllegalStateException</span><span style="color:#f92672">:</span> Can not perform <span style="color:#66d9ef">this</span> action after onSaveInstanceState
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FragmentManagerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">checkStateLoss</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FragmentManagerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">enqueueAction</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BackStackRecord</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitInternal</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BackStackRecord</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commit</span><span style="color:#f92672">(</span>SourceFile<span style="color:#f92672">)</span>
       at android<span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">v4</span><span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DialogFragment</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dismiss</span><span style="color:#f92672">(</span>SourceFile<span style="color:#960050;background-color:#1e0010">ï¼‰</span>  
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ä¸ show å‡ºç°çš„é—ªé€€å¦‚å‡ºä¸€è¾™ï¼Œåªæ˜¯é—ªé€€è§¦å‘çš„ä½ç½®æ¢æˆäº† dismissï¼ŒæŒ‰ç…§ä¹‹å‰å¯¹ show çš„ä¿®æ”¹ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥æŠŠ dismiss æ–¹æ³•ä¹Ÿæ”¹ä¸‹å‘¢ï¼Œå®é™…ä¸Šè¿˜çœŸæœ‰ <code>dismissAllowingStateLoss()</code> æ–¹æ³•ã€‚ã€‚ã€‚ä½†æ˜¯çœŸçš„å¯ä»¥è¿™æ ·å†™ä¹ˆï¼Ÿæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ state lossï¼Ÿå¦‚ä½•æ‰èƒ½æœ‰æ•ˆé¿å…è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</p>
<p>ä»”ç»†çœ‹äº†ä¸‹ Stack Overflow é—®é¢˜ä¸‹çš„è¯„è®ºï¼Œå‘ç° <a href="https://twitter.com/alexjlockwood">Alex Lockwood</a> å†™çš„<a href="https://www.androiddesignpatterns.com/2013/08/fragment-transaction-commit-state-loss.html">ä¸€ç¯‡æ–‡ç« </a>åˆ†æçš„å¾ˆå…¨é¢ï¼Œä¸‹é¢å¯¹é‡ç‚¹å†…å®¹ç¿»è¯‘ä¸€ä¸‹ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆä¼šæŠ›å¼‚å¸¸">ä¸ºä»€ä¹ˆä¼šæŠ›å¼‚å¸¸</h4>
<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä½ åœ¨ Activity state saved åï¼Œä»æ—§ commit ä¸€ä¸ª FragmentTransactionï¼Œä»è€Œå¯¼è‡´å‡ºç°äº†æ‰€è°“çš„ <code>Activity state loss</code> ç°è±¡ã€‚æ‰€ä»¥ <code>onSaveInstanceState()</code> æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<h5 id="onsaveinstancestate">onSaveInstanceState</h5>
<p>Android ç³»ç»Ÿå¯ä»¥éšæ—¶ç»ˆæ­¢è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œå› æ­¤ç½®äºåå°çš„ Activity éšæ—¶å¯èƒ½ä¼šè¢«æ¸…ç†ã€‚Android framework æä¾›ç»™æ¯ä¸ª Activity åœ¨è¢«ç³»ç»Ÿé”€æ¯å‰è°ƒç”¨ <code>onSaveInstanceState</code> ä»¥ä¿å­˜å…¶çŠ¶æ€(state)çš„æœºä¼šï¼Œåœ¨éšåæ¢å¤(restore)è¢«ä¿å­˜çš„çŠ¶æ€æ—¶ï¼Œç”¨æˆ·ä¼šæ„Ÿè§‰åœ¨æ— ç¼åˆ‡æ¢å‰/åå°Activityï¼Œè€Œä¸ä¼šå¯Ÿè§‰ Activity ä¼šç³»ç»Ÿæ¸…ç†è¿‡ã€‚</p>
<p>å½“è°ƒç”¨ <code>onSaveInstanceState</code> æ–¹æ³•æ—¶ï¼ŒAndroid Framework å°†ä¸º Acitvity æä¾›ä¸€ä¸ª Bundle å¯¹è±¡ä¿å­˜å…¶çŠ¶æ€ï¼ŒActivity å°†è®°å½• dialogs, fragments, views çš„çŠ¶æ€ã€‚åœ¨è¿™ä¸ªæ–¹æ³•è¿”å›æ—¶ï¼Œç³»ç»Ÿé€šè¿‡ Binder æ¥å£å°† Bundle å¯¹è±¡æ‰“åŒ…(parcel)åˆ° System Server è¿›ç¨‹ã€‚éšåå½“ç³»ç»Ÿå†³å®šé‡å»º(recreate) Activity æ—¶ï¼Œå®ƒå°†ä¹‹å‰ä¿å­˜çš„ Bundle å‘å› Appï¼Œæ¥æ¢å¤ Activity æ—§çš„çŠ¶æ€ã€‚</p>
<p>æ‰€ä»¥ä¸ºä»€ä¹ˆå›æŠ›å¼‚å¸¸ï¼ŸåŸå› å°±æ˜¯åœ¨ <code>onSaveInstanceState</code> è°ƒç”¨åï¼Œä½ è°ƒç”¨äº† <code>FragmentTransaction#commit()</code>ï¼Œå› æ­¤ <code>onSaveInstanceState</code> æ–¹æ³•è¿”å›çš„ <code>Bundle</code> å¯¹è±¡å¹¶ä¸åŒ…å«è¯¥äº‹åŠ¡(transaction)ã€‚åœ¨ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œäº‹åŠ¡è¢«å¿½ç•¥ï¼ŒUI çŠ¶æ€ä¸¢å¤±ï¼ŒAndroid ä¸ºäº†é¿å…è¿™ç§æƒ…å†µ,åªè¦å‘ç”ŸçŠ¶æ€ä¸¢å¤±(state loss)ä¾¿ç«‹å³æŠ›å‡º <code>IllegalStateException</code>ã€‚</p>
<h4 id="ä½•æ—¶æŠ›å‡ºå¼‚å¸¸">ä½•æ—¶æŠ›å‡ºå¼‚å¸¸</h4>
<p>ä» Honeycomb å¼€å§‹ï¼Œ<code>onSaveInstanceState()</code> åœ¨ç”Ÿå‘½å‘¨æœŸ <code>onStop()</code> æ–¹æ³•ä¹‹å‰è°ƒç”¨ï¼Œè€Œä¸æ˜¯ <code>pre-Honeycomb</code>æ—¶çš„ <code>onPause()</code> ä¹‹å‰ã€‚</p>
<h4 id="å¦‚ä½•é¿å…å¼‚å¸¸">å¦‚ä½•é¿å…å¼‚å¸¸</h4>
<p>è¿™é‡Œæœ‰ä¸€äº›å…³äºåœ¨ App ä¸­ä½¿ç”¨ <code>FragmentTransaction</code> çš„å»ºè®®ï¼š</p>
<ul>
<li>
<p><strong>æ³¨æ„</strong> åœ¨ Activity çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³• <em>æäº¤äº‹åŠ¡(commit transaction)</em>ï¼š
å½“ä½ åœ¨ <code>onCreate()</code> æ–¹æ³• commit äº‹åŠ¡å¯èƒ½ä»æ¥ä¸ä¼šç¢°åˆ°é—®é¢˜ï¼Œä½†å½“ä½ åœ¨ <code>onActivityResult()</code>ã€<code>onStart()</code>ã€<code>onResume</code> commit æ—¶ï¼Œäº‹æƒ…å˜å¾—æœ‰è¶£äº†èµ·æ¥ã€‚æ¯”å¦‚ï¼Œä½ ä¸åº”è¯¥åœ¨ <code>FragmentActivity#onResume()</code> æ–¹æ³•é‡Œ commit äº‹åŠ¡ï¼Œå› ä¸ºåœ¨<a href="http://developer.android.com/reference/android/support/v4/app/FragmentActivity.html#onResume()">æŸäº›æƒ…å†µ</a>ä¸‹ï¼ŒActivity ä¼šåœ¨æ¢å¤çŠ¶æ€(restore state)ä¹‹å‰è°ƒç”¨ <code>onResume()</code> æ–¹æ³•ã€‚å¦‚æœä½ çš„ App éœ€è¦åœ¨ <code>onCreate()</code> æ–¹æ³•ä»¥å¤– commit äº‹åŠ¡ï¼Œå°è¯•åœ¨ <code>FragmentActivity#onResumeFragments()</code> æˆ– <code>Activity#onPostResume()</code> æ–¹æ³•å†… commitï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¼šç¡®ä¿åœ¨ Activity restore state åè°ƒç”¨ï¼Œå› æ­¤é¿å…äº† state loss çš„å¯èƒ½ã€‚å¯¹äºè¿™ä¸ªä¾‹å­çš„æè¿°ï¼Œå¯ä»¥å‚è€ƒ StackOverflow ä¸Šè¿™ä¸ª<a href="http://stackoverflow.com/q/16265733/844882">å›ç­”</a>ã€‚</p>
</li>
<li>
<p><strong>é¿å…</strong> åœ¨å¼‚æ­¥å›è°ƒæ–¹æ³•ä¸­æ“ä½œäº‹åŠ¡:
ä¸»è¦åŸå› æ˜¯ï¼Œåœ¨å¼‚æ­¥å›è°ƒæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå¹¶ä¸äº†è§£ Activity å½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œå› æ­¤å¾ˆå¯èƒ½åœ¨ <code>onStop()</code> è°ƒç”¨æ—¶ commit äº‹åŠ¡ï¼Œä»è€ŒæŠ›å‡ºå¼‚å¸¸ã€‚è¿™ç§æƒ…å†µå¯ä»¥å‚è€ƒ StackOverflow ä¸Š<a href="http://stackoverflow.com/q/8040280/844882">è¿™ä¸ªå›ç­”</a>å’Œ<a href="http://stackoverflow.com/q/7992496/844882">è¿™ä¸ªå›ç­”</a>ã€‚</p>
</li>
<li>
<p><code>commitAllowingStateLoss()</code> ä»…ä½œä¸ºæœ€åçš„æ‰‹æ®µï¼š
<code>commitAllowingStateLoss()</code> ä¸ <code>commit()</code> æ–¹æ³•å”¯ä¸€çš„åŒºåˆ«ä¾¿æ˜¯è¯¥æ–¹æ³•åœ¨çŠ¶æ€ä¸¢å¤±æ—¶ä¸ä¼šæŠ›å¼‚å¸¸ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œä¸€ç§æ›´å¥½çš„æ–¹å¼ï¼Œä¾¿æ˜¯ç¡®ä¿åœ¨ Activity save state ä¹‹å‰ commit äº‹åŠ¡ã€‚</p>
</li>
</ul>
<h4 id="æœ€å">æœ€å</h4>
<p>å›å½’åˆ°æˆ‘çš„ DialogFragment ä¸ºä½•å‡ºç°å¼‚å¸¸ï¼ŒåŸå› æ˜¯æˆ‘ commit transaction ä½ç½®æ˜¯åœ¨ <code>FragmentActivity#onResume()</code>æ–¹æ³•å†…:-)</p>

        </section>
        <footer>
            <a class="permalink u-url" href="https://zacash.cn/post/check-state-loss/">ğŸ”—</a>
            
            <hr class="post-underline">
            <p class="post-tag">Tags for this post:
                
                <a href="https://zacash.cn/tags/fragment" class="post-tag p-category">Fragment</a>
                
                <a href="https://zacash.cn/tags/dialogfragment" class="post-tag p-category">DialogFragment</a>
                
                <a href="https://zacash.cn/tags/state-loss" class="post-tag p-category">State Loss</a>
                
            </p>
            
        </footer>
    </article>
</div>

    
    <div class="h-card">
      <img class="u-photo" src="https://zacash.cn/images/android-os.png" />
      <div class="card-content">
        <h2 class="card-name"><a class="p-name u-url" href="https://zacash.cn" rel="me">Zac</a></h2>
        <p class="card-subhead">
          <span class="p-locality">Shanghai</span>,
          <span class="p-country-name">China</span><br />
          <a class="u-email" href="mailto:zac_ju@163.com">Email me</a>
        </p>
      </div>
      <p class="p-note">ğŸ­</p>
    </div>
    
    <div id="footer">
      
      <nav id="article-skip">
        <div class="next">
          
          <a alt="Newer article" href="https://zacash.cn/post/hugo-basic/">&larr; Newer</a>
          
        </div>
        <div class="top">
          <a alt="Top of page" href="#">Top</a>
        </div>
        <div class="prev">
          
          <a alt="Older article" href="https://zacash.cn/post/when-to-use-lazy-or-lateinit/">Older &rarr;</a>
          
        </div>
      </nav>
      
      <aside id="social">
  <div id="social-icons">
    
    
    
    
    <div class="icon-24x24">
      <a class="glyph" alt="GitHub profile" href="https://github.com/zac4j"><img src=https://zacash.cn/icons/github.svg height="24px" width="24px"></a>
    </div>
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
</aside>

      
      <p class="copyright">
          Copyright Â© 2020, Copyright Zac
      </p>
      
    </div>


</body>
</html>