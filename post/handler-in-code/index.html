<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    
    <title>Handler in Code | Zac&#39;s Blog</title>
    <meta name="description" content="Handler æ¶ˆæ¯æœºåˆ¶çš„å®ç°">
    <meta name="author" content="">
    
    <link rel="apple-touch-icon" sizes="180x180" href=https://zacash.cn/apple-touch-icon.png>
    <link rel="icon" type="image/png" sizes="32x32" href=https://zacash.cn/favicon-32x32.png>
    <link rel="icon" type="image/png" sizes="16x16" href=https://zacash.cn/favicon-16x16.png>
    <link rel="manifest" href=https://zacash.cn/site.webmanifest>
    <link rel="mask-icon" href=https://zacash.cn/safari-pinned-tab.svg color="#00416a">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="me" href="mailto:zac_ju@163.com">
    <link rel="me" href="https://github.com/zac4j">
    
    
    
    <link rel="authorization_endpoint" href=https://indieauth.com/auth />
    <link rel="token_endpoint" href=https://tokens.indieauth.com/token />
    
    
    
    
    
    <link rel="stylesheet" href=https://zacash.cn/css/fonts.css />
    <link rel="stylesheet" href=https://zacash.cn/css/style.css />
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="sitelogo">
        <a class="glyph" alt="Home" href="https://zacash.cn"><img src=https://zacash.cn/images/site-logo.svg alt="Site Logo" height="64px" width="64px"></a>
    </div>
    <header>
        <nav>
    
    <div id="page-nav">
        <div class="page-nav-item">
            <a href="https://zacash.cn">Home</a>
        </div>
        
            <div class="page-nav-item">
                <a href="/tags">
                    
                    <span>Tag</span>
                </a>
            </div>
        
            <div class="page-nav-item">
                <a href="/categories">
                    
                    <span>Category</span>
                </a>
            </div>
        
    </div>
</nav>
        
    </header>






<div id="content">
    <article class="h-entry">
        <header>
            <h1 class="post-title p-name">Handler in Code</h1>
            
            <p class="post-date">Posted on
                <time class="dt-published" datetime="2020-04-12T20:36:33&#43;08:00">
                    12 April, 2020 at 20:36 CST
                </time>  by <a href="https://zacash.cn" class="p-author h-card"
                    rel="author">Zac</a>
            </p>
            
            
            <p class="post-tag">Category:
                
                <a href="https://zacash.cn/categories/handler" class="post-tag p-category">Handler</a>
                
            </p>
            <hr class="post-underline">
            
        </header>
        <section class="content e-content">
            <h3 id="handler-çš„åˆ›å»º">Handler çš„åˆ›å»º</h3>
<ul>
<li>åœ¨ä¸»çº¿ç¨‹(UI Thread)ä¸­ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MainActivity</span> : Activity {
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> mLeakedHandler = <span style="color:#66d9ef">object</span> <span style="color:#960050;background-color:#1e0010">: </span><span style="color:#a6e22e">Handler</span>() {
        <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">handleMessage</span>(msg: Message) {
            <span style="color:#66d9ef">super</span>.handleMessage(msg)
        }
    }
}

</code></pre></div><ul>
<li>åœ¨å­çº¿ç¨‹ä¸­ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> thread = <span style="color:#66d9ef">object</span> <span style="color:#960050;background-color:#1e0010">: </span><span style="color:#a6e22e">Thread</span>() {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">run</span>() {
        Looper.prepare()
        <span style="color:#66d9ef">val</span> handler = <span style="color:#66d9ef">object</span> <span style="color:#960050;background-color:#1e0010">: </span><span style="color:#a6e22e">Handler</span>() {
            <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">handleMessage</span>(msg: Message) {
                <span style="color:#66d9ef">super</span>.handleMessage(msg)
            }
        }
        Looper.loop()
    }
}
</code></pre></div><h4 id="ä¸ºä»€ä¹ˆåœ¨å­çº¿ç¨‹åˆ›å»º-handler-éœ€è¦å‡†å¤‡-looperè€Œä¸»çº¿ç¨‹å´ä¸ç”¨">ä¸ºä»€ä¹ˆåœ¨å­çº¿ç¨‹åˆ›å»º Handler éœ€è¦å‡†å¤‡ Looperï¼Œè€Œä¸»çº¿ç¨‹å´ä¸ç”¨</h4>
<p>å› ä¸º ActivityThread ä¸­çš„ <code>main()</code> æ–¹æ³•å·²ç»ä¸ºæˆ‘ä»¬åˆå§‹åŒ–äº† Looper</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">// Install selective syscall interception
</span><span style="color:#75715e"></span>    AndroidOs<span style="color:#f92672">.</span><span style="color:#a6e22e">install</span><span style="color:#f92672">();</span>

    <span style="color:#f92672">...</span>

    Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareMainLooper</span><span style="color:#f92672">();</span>

    <span style="color:#f92672">...</span>
    ActivityThread thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ActivityThread<span style="color:#f92672">();</span>
    thread<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> startSeq<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sMainThreadHandler <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sMainThreadHandler <span style="color:#f92672">=</span> thread<span style="color:#f92672">.</span><span style="color:#a6e22e">getHandler</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setMessageLogging</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span>
                LogPrinter<span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ActivityThread&#34;</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">loop</span><span style="color:#f92672">();</span>

    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Main thread loop unexpectedly exited&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="handler-å’Œ-looper">Handler å’Œ Looper</h3>
<h4 id="ä¸ºä»€ä¹ˆä½¿ç”¨-handler-å°±éœ€è¦æ˜¾å¼çš„è°ƒç”¨-looperprepare-å’Œ-looperloop-å‘¢">ä¸ºä»€ä¹ˆä½¿ç”¨ Handler å°±éœ€è¦æ˜¾å¼çš„è°ƒç”¨ <code>Looper.prepare()</code> å’Œ <code>Looper.loop()</code> å‘¢</h4>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è§‚å¯Ÿ Handler çš„æ„é€ æ–¹æ³•ç†è§£ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Handler</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nullable</span> Callback callback<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> async<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>

    mLooper <span style="color:#f92672">=</span> Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLooper <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Can&#39;t create handler inside thread &#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; that has not called Looper.prepare()&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    mQueue <span style="color:#f92672">=</span> mLooper<span style="color:#f92672">.</span><span style="color:#a6e22e">mQueue</span><span style="color:#f92672">;</span>
    mCallback <span style="color:#f92672">=</span> callback<span style="color:#f92672">;</span>
    mAsynchronous <span style="color:#f92672">=</span> async<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>Looper.myLooper()</code> çš„å®ç°åˆ™æ˜¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">@Nullable</span> Looper <span style="color:#a6e22e">myLooper</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> sThreadLocal<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>é‚£ä¹ˆ sThreadLocal åœ¨å“ªé‡Œ set çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <code>Looper.prepare()</code> æ–¹æ³•:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepare</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> quitAllowed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sThreadLocal<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Only one Looper may be created per thread&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    sThreadLocal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Looper<span style="color:#f92672">(</span>quitAllowed<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ° Handler å’Œ Looper æ˜¯ç»‘å®šçš„å…³ç³»ï¼Œæ¯ä¸ª Handler åªä¼šå­˜åœ¨ä¸€ä¸ªçº¿ç¨‹å’Œ Looperï¼ŒLooper å†…çš„ ThreadLocal æ ‡è¯†å¯¹åº”çš„çº¿ç¨‹ã€‚</p>
<h3 id="handler-çš„ä½¿ç”¨">Handler çš„ä½¿ç”¨</h3>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ï¼ŒHandler é€šå¸¸æœ‰2ç§ç”¨æ³•ï¼š</p>
<ul>
<li>Schedule to be executed at some point in the future:
Schedule Message å’Œ Runnable æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼ŒHandler æä¾›äº†å¦‚ <code>sendMessageAtTime(Message, long)</code> å’Œ <code>postAtTime(Runnable, long)</code> æ–¹æ³•ï¼Œå¯ä»¥è®¾å®šåœ¨æœªæ¥æŸä¸ªæ—¶åˆ»æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>Enqueue an action to be performed on a different thread than your own:
åœ¨åˆ«çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œæˆ‘ä»¬é€šå¸¸çš„åº”ç”¨å°±æ˜¯åœ¨å­çº¿ç¨‹å¤„ç†è€—æ—¶ä»»åŠ¡åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>Handler(getMainLooper())</code> æ¥æ‰§è¡Œæ›´æ–° UI çš„æ“ä½œã€‚</li>
</ul>
<h3 id="handler-å’Œ-messagequeue">Handler å’Œ MessageQueue</h3>
<p>è§‚å¯Ÿæºç å¯ä»¥å‘ç° handler çš„ <code>sendMessage(msg)</code>ã€<code>sendMessageDelayed(msg, timeMillis)</code>ã€<code>post(runnable)</code> æ–¹æ³•æœ€åéƒ½æ˜¯é€šè¿‡è°ƒç”¨ <code>sendMessageAtTime(msg, uptimeMillis)</code> å®ç°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">sendMessageAtTime</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> uptimeMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    MessageQueue queue <span style="color:#f92672">=</span> mQueue<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>queue <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        RuntimeException e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                <span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; sendMessageAtTime() called with no mQueue&#34;</span><span style="color:#f92672">);</span>
        Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Looper&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> enqueueMessage<span style="color:#f92672">(</span>queue<span style="color:#f92672">,</span> msg<span style="color:#f92672">,</span> uptimeMillis<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿™é‡Œ <code>Handler.mQueue</code> æ˜¯åœ¨ Handler æ„é€ æ–¹æ³•é‡Œé€šè¿‡ <code>mLooper.mQueue</code> è·å–ï¼Œè€Œ <code>Looper.mQueue</code> æ˜¯åœ¨ Looper åˆå§‹åŒ–æ—¶åˆ›å»º:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// android/os/Handler.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Handler</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nullable</span> Callback callback<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> async<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
    mLooper <span style="color:#f92672">=</span> Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLooper <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Can&#39;t create handler inside thread &#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; that has not called Looper.prepare()&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    mQueue <span style="color:#f92672">=</span> mLooper<span style="color:#f92672">.</span><span style="color:#a6e22e">mQueue</span><span style="color:#f92672">;</span>
    mCallback <span style="color:#f92672">=</span> callback<span style="color:#f92672">;</span>
    mAsynchronous <span style="color:#f92672">=</span> async<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// android/os/Looper.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Looper</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> quitAllowed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    mQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageQueue<span style="color:#f92672">(</span>quitAllowed<span style="color:#f92672">);</span>
    mThread <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°åƒå®˜æ–¹æ–‡æ¡£æè¿°çš„é‚£æ ·ï¼Œæ¯ä¸ª Handler å®ä¾‹éƒ½å…³è”ç€ä¸€æ¡çº¿ç¨‹ä»¥åŠè¿™æ¡çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—(Each Handler instance is associated with a single thread and that thread&rsquo;s message queue)ã€‚</p>
<h4 id="æ¶ˆæ¯å¦‚ä½•å…¥åˆ—">æ¶ˆæ¯å¦‚ä½•å…¥åˆ—</h4>
<p>åœ¨ <code>sendMessageAtTime()</code> æ–¹æ³•æœ€åè¿”å›äº† <code>Handler.enqueueMessage()</code> çš„å€¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">enqueueMessage</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> MessageQueue queue<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NonNull</span> Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> uptimeMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">workSourceUid</span> <span style="color:#f92672">=</span> ThreadLocalWorkSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getUid</span><span style="color:#f92672">();</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAsynchronous<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setAsynchronous</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> queue<span style="color:#f92672">.</span><span style="color:#a6e22e">enqueueMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> uptimeMillis<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>Handler.enqueueMessage()</code> è°ƒç”¨çš„ <code>MessageQueue.enqueueMessage()</code> å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">enqueueMessage</span><span style="color:#f92672">(</span>Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> when<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Message must have a target.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isInUse</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span>msg <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; This message is already in use.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mQuitting<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            IllegalStateException e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span>
                    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; sending message to a Handler on a dead thread&#34;</span><span style="color:#f92672">);</span>
            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">markInUse</span><span style="color:#f92672">();</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span> <span style="color:#f92672">=</span> when<span style="color:#f92672">;</span>
        Message p <span style="color:#f92672">=</span> mMessages<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> needWake<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">==</span> 0 <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// New head, wake up the event queue if blocked.
</span><span style="color:#75715e"></span>            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
            mMessages <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
            needWake <span style="color:#f92672">=</span> mBlocked<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Inserted within the middle of the queue.  Usually we don&#39;t have to wake
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// up the event queue unless there is a barrier at the head of the queue
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// and the message is the earliest asynchronous message in the queue.
</span><span style="color:#75715e"></span>            needWake <span style="color:#f92672">=</span> mBlocked <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">();</span>
            Message prev<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
                prev <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needWake <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    needWake <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span> <span style="color:#75715e">// invariant: p == prev.next
</span><span style="color:#75715e"></span>            prev<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// We can assume mPtr != 0 because mQuitting is false.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needWake<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            nativeWake<span style="color:#f92672">(</span>mPtr<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬åˆ†å¼€æ¥çœ‹ï¼Œè¿™é‡Œ <code>msg.target</code> å³æ¶ˆæ¯å¯¹åº”çš„ handler, åœ¨ <code>Handler.enqueueMessage()</code> æ–¹æ³•æœ‰èµ‹å€¼ã€‚</p>
<p>MessageQueue å¹¶æ²¡æœ‰é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ä»¥å•é“¾è¡¨çš„å½¢å¼å­˜å‚¨ msgï¼Œ<code>mMessages</code> ä¸ºå½“å‰é“¾è¡¨å¤´éƒ¨çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬ç§°ä¸º head_msgï¼Œå½“å‰ä¼ å…¥çš„æ¶ˆæ¯ç§°ä¸º current_msgï¼Œ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">==</span> 0 <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// New head, wake up the event queue if blocked.
</span><span style="color:#75715e"></span>    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
    mMessages <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
    needWake <span style="color:#f92672">=</span> mBlocked<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>if</code> çš„åˆ¤æ–­æ˜¯ï¼Œå¦‚æœ:</p>
<ul>
<li>1).å½“å‰é˜Ÿåˆ—æ²¡æœ‰ head_msg</li>
<li>2).current_msg æ˜¯éœ€è¦ç«‹å³æ‰§è¡Œ</li>
<li>3).current_msg çš„æ‰§è¡Œæ—¶é—´åœ¨ head_msg æ‰§è¡Œæ—¶é—´ä¹‹å‰</li>
</ul>
<p>åˆ™å°† head_msg æ ‡è®°ä¸º current_msg çš„ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œcurrent_msg æ ‡è®°ä¸ºå¤´éƒ¨æ¶ˆæ¯ï¼Œå¹¶ä¸”å”¤é†’å½“å‰é˜»å¡çš„é˜Ÿåˆ—ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">...</span>
<span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Inserted within the middle of the queue.  Usually we don&#39;t have to wake
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// up the event queue unless there is a barrier at the head of the queue
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// and the message is the earliest asynchronous message in the queue.
</span><span style="color:#75715e"></span>    needWake <span style="color:#f92672">=</span> mBlocked <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">();</span>
    Message prev<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        prev <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
        p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needWake <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            needWake <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span> <span style="color:#75715e">// invariant: p == prev.next
</span><span style="color:#75715e"></span>    prev<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>else</code> å†…çš„é€»è¾‘æ˜¯ï¼Œæ ¹æ® current_msg çš„æ‰§è¡Œæ—¶é—´åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰¾åˆ°å¯¹åº”çš„ä½ç½®å…¥åˆ—ã€‚</p>
<h4 id="ä½•æ—¶æ‰§è¡Œå…¥åˆ—çš„æ¶ˆæ¯">ä½•æ—¶æ‰§è¡Œå…¥åˆ—çš„æ¶ˆæ¯</h4>
<p>ç­”æ¡ˆå°±æ˜¯åœ¨å­çº¿ç¨‹ä½¿ç”¨ handler æ—¶æ˜¾å¼è°ƒç”¨çš„ <code>Looper.loop()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// android/os/Looper.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> Looper me <span style="color:#f92672">=</span> myLooper<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>me <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No Looper; Looper.prepare() wasn&#39;t called on this thread.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">final</span> MessageQueue queue <span style="color:#f92672">=</span> me<span style="color:#f92672">.</span><span style="color:#a6e22e">mQueue</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        Message msg <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span> <span style="color:#75715e">// might block
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// No message indicates that the message queue is quitting.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
            <span style="color:#f92672">...</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exception<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">...</span>
            <span style="color:#66d9ef">throw</span> exception<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">...</span>
        <span style="color:#f92672">}</span>
        <span style="color:#f92672">...</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">recycleUnchecked</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>Looper.loop()</code> çš„å®ç°å°±æ˜¯åœ¨æ— é™å¾ªç¯ä¸­ä¸æ–­ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡º msgï¼Œå¹¶åœ¨ <code>msg.target</code>å³ handler ä¸­ <code>dispatchMessage</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchMessage</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> Message msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">callback</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        handleCallback<span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCallback <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCallback<span style="color:#f92672">.</span><span style="color:#a6e22e">handleMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        handleMessage<span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>msg.callback</code> å¯¹åº”çš„æ˜¯ <code>Handler.post(runnable)</code> ä¼ é€’çš„ Runnable å¯¹è±¡ï¼Œè€Œ <code>mCallback.handleMessage(msg)</code> æˆ– <code>handleMessage(msg)</code> åˆ™æ˜¯å®ä¾‹è¯ Handler å¯¹è±¡æ—¶å¤å†™çš„æ–¹æ³•ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>Handler å¸®åŠ©æˆ‘ä»¬å¤„ç† Message å’Œ Runnable å¯¹è±¡ï¼Œæ¯ä¸ª Handler å®ä¾‹éƒ½å…³è”ç€ä¸€ä¸ªçº¿ç¨‹ä»¥åŠè¿™ä¸ªçº¿ç¨‹çš„ MessageQueueã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„ Handler å¯¹è±¡æ—¶ï¼Œå®ƒå°†ä¸å½“å‰æ‰€åœ¨çš„çº¿ç¨‹(UI/Work Thread)å’Œ MessageQueue ç»‘å®šåœ¨ä¸€èµ·ï¼Œé€šè¿‡ Handler å‘å‡ºçš„ Message æˆ–è€… Runnable(msg.callback) ä¼šæ ¹æ®æ‰§è¡Œæ—¶é—´æ’å…¥ MessageQueueï¼ŒLooper ä¼šæŒç»­ä¸æ–­çš„ä» MessageQueue å–å‡ºå¯æ‰§è¡Œçš„ Message é€šè¿‡ Handler.handleMessage(msg) å¤„ç†ã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="https://i1.wp.com/tutorial.eyehunts.com/wp-content/uploads/2018/08/Android-Handler-Background-Thread-Communicate-with-UI-thread-1.png?resize=1024%2C621&amp;ssl=1" alt="handler"></p>

        </section>
        <footer>
            <a class="permalink u-url" href="https://zacash.cn/post/handler-in-code/">ğŸ”—</a>
            
            <hr class="post-underline">
            <p class="post-tag">Tags for this post:
                
                <a href="https://zacash.cn/tags/handler" class="post-tag p-category">Handler</a>
                
                <a href="https://zacash.cn/tags/messagequeue" class="post-tag p-category">MessageQueue</a>
                
                <a href="https://zacash.cn/tags/looper" class="post-tag p-category">Looper</a>
                
            </p>
            
        </footer>
    </article>
</div>

    
    <div class="h-card">
      <img class="u-photo" src="https://zacash.cn/images/android-os.png" />
      <div class="card-content">
        <h2 class="card-name"><a class="p-name u-url" href="https://zacash.cn" rel="me">Zac</a></h2>
        <p class="card-subhead">
          <span class="p-locality">Shanghai</span>,
          <span class="p-country-name">China</span><br />
          <a class="u-email" href="mailto:zac_ju@163.com">Email me</a>
        </p>
      </div>
      <p class="p-note">ğŸ­</p>
    </div>
    
    <div id="footer">
      
      <nav id="article-skip">
        <div class="next">
          
          <a alt="Newer article" href="https://zacash.cn/post/handler-in-action/">&larr; Newer</a>
          
        </div>
        <div class="top">
          <a alt="Top of page" href="#">Top</a>
        </div>
        <div class="prev">
          
          <a alt="Older article" href="https://zacash.cn/post/hugo-basic/">Older &rarr;</a>
          
        </div>
      </nav>
      
      <aside id="social">
  <div id="social-icons">
    
    
    
    
    <div class="icon-24x24">
      <a class="glyph" alt="GitHub profile" href="https://github.com/zac4j"><img src=https://zacash.cn/icons/github.svg height="24px" width="24px"></a>
    </div>
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
</aside>

      
      <p class="copyright">
          Copyright Â© 2020, Copyright Zac
      </p>
      
    </div>


</body>
</html>