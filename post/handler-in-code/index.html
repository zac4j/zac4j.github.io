<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    
    <title>Handler in Code | Zac&#39;s Blog</title>
    <meta name="description" content="Handler 消息机制的实现">
    <meta name="author" content="">
    
    <link rel="apple-touch-icon" sizes="180x180" href=https://zacash.cn/apple-touch-icon.png>
    <link rel="icon" type="image/png" sizes="32x32" href=https://zacash.cn/favicon-32x32.png>
    <link rel="icon" type="image/png" sizes="16x16" href=https://zacash.cn/favicon-16x16.png>
    <link rel="manifest" href=https://zacash.cn/site.webmanifest>
    <link rel="mask-icon" href=https://zacash.cn/safari-pinned-tab.svg color="#00416a">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="me" href="mailto:zac_ju@163.com">
    <link rel="me" href="https://github.com/zac4j">
    
    
    
    <link rel="authorization_endpoint" href=https://indieauth.com/auth />
    <link rel="token_endpoint" href=https://tokens.indieauth.com/token />
    
    
    
    
    
    <link rel="stylesheet" href=https://zacash.cn/css/fonts.css />
    <link rel="stylesheet" href=https://zacash.cn/css/style.css />
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="sitelogo">
        <a class="glyph" alt="Home" href="https://zacash.cn"><img src=https://zacash.cn/images/site-logo.svg alt="Site Logo" height="64px" width="64px"></a>
    </div>
    <header>
        <nav>
    
    <div id="page-nav">
        <div class="page-nav-item">
            <a href="https://zacash.cn">Home</a>
        </div>
        
            <div class="page-nav-item">
                <a href="/tags">
                    
                    <span>Tag</span>
                </a>
            </div>
        
            <div class="page-nav-item">
                <a href="/categories">
                    
                    <span>Category</span>
                </a>
            </div>
        
    </div>
</nav>
        
    </header>






<div id="content">
    <article class="h-entry">
        <header>
            <h1 class="post-title p-name">Handler in Code</h1>
            
            <p class="post-date">Posted on
                <time class="dt-published" datetime="2020-04-12T20:36:33&#43;08:00">
                    12 April, 2020 at 20:36 CST
                </time>  by <a href="https://zacash.cn" class="p-author h-card"
                    rel="author">Zac</a>
            </p>
            
            
            <p class="post-tag">Category:
                
                <a href="https://zacash.cn/categories/handler" class="post-tag p-category">Handler</a>
                
            </p>
            <hr class="post-underline">
            
        </header>
        <section class="content e-content">
            <h3 id="handler-的创建">Handler 的创建</h3>
<ul>
<li>在主线程(UI Thread)中：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MainActivity</span> : Activity {
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> mLeakedHandler = <span style="color:#66d9ef">object</span> <span style="color:#960050;background-color:#1e0010">: </span><span style="color:#a6e22e">Handler</span>() {
        <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">handleMessage</span>(msg: Message) {
            <span style="color:#66d9ef">super</span>.handleMessage(msg)
        }
    }
}

</code></pre></div><ul>
<li>在子线程中：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> thread = <span style="color:#66d9ef">object</span> <span style="color:#960050;background-color:#1e0010">: </span><span style="color:#a6e22e">Thread</span>() {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">run</span>() {
        Looper.prepare()
        <span style="color:#66d9ef">val</span> handler = <span style="color:#66d9ef">object</span> <span style="color:#960050;background-color:#1e0010">: </span><span style="color:#a6e22e">Handler</span>() {
            <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">handleMessage</span>(msg: Message) {
                <span style="color:#66d9ef">super</span>.handleMessage(msg)
            }
        }
        Looper.loop()
    }
}
</code></pre></div><h4 id="为什么在子线程创建-handler-需要准备-looper而主线程却不用">为什么在子线程创建 Handler 需要准备 Looper，而主线程却不用</h4>
<p>因为 ActivityThread 中的 <code>main()</code> 方法已经为我们初始化了 Looper</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">// Install selective syscall interception
</span><span style="color:#75715e"></span>    AndroidOs<span style="color:#f92672">.</span><span style="color:#a6e22e">install</span><span style="color:#f92672">();</span>

    <span style="color:#f92672">...</span>

    Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareMainLooper</span><span style="color:#f92672">();</span>

    <span style="color:#f92672">...</span>
    ActivityThread thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ActivityThread<span style="color:#f92672">();</span>
    thread<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> startSeq<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sMainThreadHandler <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sMainThreadHandler <span style="color:#f92672">=</span> thread<span style="color:#f92672">.</span><span style="color:#a6e22e">getHandler</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setMessageLogging</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span>
                LogPrinter<span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ActivityThread&#34;</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">loop</span><span style="color:#f92672">();</span>

    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Main thread loop unexpectedly exited&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="handler-和-looper">Handler 和 Looper</h3>
<h4 id="为什么使用-handler-就需要显式的调用-looperprepare-和-looperloop-呢">为什么使用 Handler 就需要显式的调用 <code>Looper.prepare()</code> 和 <code>Looper.loop()</code> 呢</h4>
<p>我们可以通过观察 Handler 的构造方法理解：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Handler</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nullable</span> Callback callback<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> async<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>

    mLooper <span style="color:#f92672">=</span> Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLooper <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Can&#39;t create handler inside thread &#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; that has not called Looper.prepare()&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    mQueue <span style="color:#f92672">=</span> mLooper<span style="color:#f92672">.</span><span style="color:#a6e22e">mQueue</span><span style="color:#f92672">;</span>
    mCallback <span style="color:#f92672">=</span> callback<span style="color:#f92672">;</span>
    mAsynchronous <span style="color:#f92672">=</span> async<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>Looper.myLooper()</code> 的实现则是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">@Nullable</span> Looper <span style="color:#a6e22e">myLooper</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> sThreadLocal<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>那么 sThreadLocal 在哪里 set 的呢？答案是 <code>Looper.prepare()</code> 方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepare</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> quitAllowed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sThreadLocal<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Only one Looper may be created per thread&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    sThreadLocal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Looper<span style="color:#f92672">(</span>quitAllowed<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看到 Handler 和 Looper 是绑定的关系，每个 Handler 只会存在一个线程和 Looper，Looper 内的 ThreadLocal 标识对应的线程。</p>
<h3 id="handler-的使用">Handler 的使用</h3>
<p>根据官方文档的介绍，Handler 通常有2种用法：</p>
<ul>
<li>Schedule to be executed at some point in the future:
Schedule Message 和 Runnable 比较容易理解，Handler 提供了如 <code>sendMessageAtTime(Message, long)</code> 和 <code>postAtTime(Runnable, long)</code> 方法，可以设定在未来某个时刻执行任务。</li>
<li>Enqueue an action to be performed on a different thread than your own:
在别的线程执行任务，我们通常的应用就是在子线程处理耗时任务后，我们可以通过 <code>Handler(getMainLooper())</code> 来执行更新 UI 的操作。</li>
</ul>
<h3 id="handler-和-messagequeue">Handler 和 MessageQueue</h3>
<p>观察源码可以发现 handler 的 <code>sendMessage(msg)</code>、<code>sendMessageDelayed(msg, timeMillis)</code>、<code>post(runnable)</code> 方法最后都是通过调用 <code>sendMessageAtTime(msg, uptimeMillis)</code> 实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">sendMessageAtTime</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> uptimeMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    MessageQueue queue <span style="color:#f92672">=</span> mQueue<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>queue <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        RuntimeException e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                <span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; sendMessageAtTime() called with no mQueue&#34;</span><span style="color:#f92672">);</span>
        Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Looper&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> enqueueMessage<span style="color:#f92672">(</span>queue<span style="color:#f92672">,</span> msg<span style="color:#f92672">,</span> uptimeMillis<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里 <code>Handler.mQueue</code> 是在 Handler 构造方法里通过 <code>mLooper.mQueue</code> 获取，而 <code>Looper.mQueue</code> 是在 Looper 初始化时创建:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// android/os/Handler.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Handler</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nullable</span> Callback callback<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> async<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
    mLooper <span style="color:#f92672">=</span> Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLooper <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Can&#39;t create handler inside thread &#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; that has not called Looper.prepare()&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    mQueue <span style="color:#f92672">=</span> mLooper<span style="color:#f92672">.</span><span style="color:#a6e22e">mQueue</span><span style="color:#f92672">;</span>
    mCallback <span style="color:#f92672">=</span> callback<span style="color:#f92672">;</span>
    mAsynchronous <span style="color:#f92672">=</span> async<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// android/os/Looper.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Looper</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> quitAllowed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    mQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageQueue<span style="color:#f92672">(</span>quitAllowed<span style="color:#f92672">);</span>
    mThread <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看到像官方文档描述的那样，每个 Handler 实例都关联着一条线程以及这条线程的消息队列(Each Handler instance is associated with a single thread and that thread&rsquo;s message queue)。</p>
<h4 id="消息如何入列">消息如何入列</h4>
<p>在 <code>sendMessageAtTime()</code> 方法最后返回了 <code>Handler.enqueueMessage()</code> 的值：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">enqueueMessage</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> MessageQueue queue<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NonNull</span> Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> uptimeMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">workSourceUid</span> <span style="color:#f92672">=</span> ThreadLocalWorkSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getUid</span><span style="color:#f92672">();</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAsynchronous<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setAsynchronous</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> queue<span style="color:#f92672">.</span><span style="color:#a6e22e">enqueueMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> uptimeMillis<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>Handler.enqueueMessage()</code> 调用的 <code>MessageQueue.enqueueMessage()</code> 实现如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">enqueueMessage</span><span style="color:#f92672">(</span>Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> when<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Message must have a target.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isInUse</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span>msg <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; This message is already in use.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mQuitting<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            IllegalStateException e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span>
                    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; sending message to a Handler on a dead thread&#34;</span><span style="color:#f92672">);</span>
            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">markInUse</span><span style="color:#f92672">();</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span> <span style="color:#f92672">=</span> when<span style="color:#f92672">;</span>
        Message p <span style="color:#f92672">=</span> mMessages<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> needWake<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">==</span> 0 <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// New head, wake up the event queue if blocked.
</span><span style="color:#75715e"></span>            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
            mMessages <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
            needWake <span style="color:#f92672">=</span> mBlocked<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Inserted within the middle of the queue.  Usually we don&#39;t have to wake
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// up the event queue unless there is a barrier at the head of the queue
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// and the message is the earliest asynchronous message in the queue.
</span><span style="color:#75715e"></span>            needWake <span style="color:#f92672">=</span> mBlocked <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">();</span>
            Message prev<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
                prev <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needWake <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    needWake <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span> <span style="color:#75715e">// invariant: p == prev.next
</span><span style="color:#75715e"></span>            prev<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// We can assume mPtr != 0 because mQuitting is false.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needWake<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            nativeWake<span style="color:#f92672">(</span>mPtr<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>我们分开来看，这里 <code>msg.target</code> 即消息对应的 handler, 在 <code>Handler.enqueueMessage()</code> 方法有赋值。</p>
<p>MessageQueue 并没有队列的数据结构，而是以单链表的形式存储 msg，<code>mMessages</code> 为当前链表头部的消息，我们称为 head_msg，当前传入的消息称为 current_msg，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">==</span> 0 <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// New head, wake up the event queue if blocked.
</span><span style="color:#75715e"></span>    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
    mMessages <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
    needWake <span style="color:#f92672">=</span> mBlocked<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>if</code> 的判断是，如果:</p>
<ul>
<li>1).当前队列没有 head_msg</li>
<li>2).current_msg 是需要立即执行</li>
<li>3).current_msg 的执行时间在 head_msg 执行时间之前</li>
</ul>
<p>则将 head_msg 标记为 current_msg 的下一条消息，current_msg 标记为头部消息，并且唤醒当前阻塞的队列。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">...</span>
<span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Inserted within the middle of the queue.  Usually we don&#39;t have to wake
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// up the event queue unless there is a barrier at the head of the queue
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// and the message is the earliest asynchronous message in the queue.
</span><span style="color:#75715e"></span>    needWake <span style="color:#f92672">=</span> mBlocked <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">();</span>
    Message prev<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        prev <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
        p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> when <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">when</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needWake <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsynchronous</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            needWake <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span> <span style="color:#75715e">// invariant: p == prev.next
</span><span style="color:#75715e"></span>    prev<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> msg<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>else</code> 内的逻辑是，根据 current_msg 的执行时间在消息队列中找到对应的位置入列。</p>
<h4 id="何时执行入列的消息">何时执行入列的消息</h4>
<p>答案就是在子线程使用 handler 时显式调用的 <code>Looper.loop()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// android/os/Looper.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> Looper me <span style="color:#f92672">=</span> myLooper<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>me <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No Looper; Looper.prepare() wasn&#39;t called on this thread.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">final</span> MessageQueue queue <span style="color:#f92672">=</span> me<span style="color:#f92672">.</span><span style="color:#a6e22e">mQueue</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        Message msg <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span> <span style="color:#75715e">// might block
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// No message indicates that the message queue is quitting.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">target</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
            <span style="color:#f92672">...</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exception<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">...</span>
            <span style="color:#66d9ef">throw</span> exception<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">...</span>
        <span style="color:#f92672">}</span>
        <span style="color:#f92672">...</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">recycleUnchecked</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>Looper.loop()</code> 的实现就是在无限循环中不断从消息队列中取出 msg，并在 <code>msg.target</code>即 handler 中 <code>dispatchMessage</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchMessage</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> Message msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">callback</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        handleCallback<span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCallback <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCallback<span style="color:#f92672">.</span><span style="color:#a6e22e">handleMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        handleMessage<span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>msg.callback</code> 对应的是 <code>Handler.post(runnable)</code> 传递的 Runnable 对象，而 <code>mCallback.handleMessage(msg)</code> 或 <code>handleMessage(msg)</code> 则是实例话 Handler 对象时复写的方法。</p>
<h3 id="总结">总结</h3>
<p>Handler 帮助我们处理 Message 和 Runnable 对象，每个 Handler 实例都关联着一个线程以及这个线程的 MessageQueue。当你创建一个新的 Handler 对象时，它将与当前所在的线程(UI/Work Thread)和 MessageQueue 绑定在一起，通过 Handler 发出的 Message 或者 Runnable(msg.callback) 会根据执行时间插入 MessageQueue，Looper 会持续不断的从 MessageQueue 取出可执行的 Message 通过 Handler.handleMessage(msg) 处理。</p>
<p>如下图所示：<img src="https://i1.wp.com/tutorial.eyehunts.com/wp-content/uploads/2018/08/Android-Handler-Background-Thread-Communicate-with-UI-thread-1.png?resize=1024%2C621&amp;ssl=1" alt="handler"></p>

        </section>
        <footer>
            <a class="permalink u-url" href="https://zacash.cn/post/handler-in-code/">🔗</a>
            
            <hr class="post-underline">
            <p class="post-tag">Tags for this post:
                
                <a href="https://zacash.cn/tags/handler" class="post-tag p-category">Handler</a>
                
                <a href="https://zacash.cn/tags/messagequeue" class="post-tag p-category">MessageQueue</a>
                
                <a href="https://zacash.cn/tags/looper" class="post-tag p-category">Looper</a>
                
            </p>
            
        </footer>
    </article>
</div>

    
    <div class="h-card">
      <img class="u-photo" src="https://zacash.cn/images/android-os.png" />
      <div class="card-content">
        <h2 class="card-name"><a class="p-name u-url" href="https://zacash.cn" rel="me">Zac</a></h2>
        <p class="card-subhead">
          <span class="p-locality">Shanghai</span>,
          <span class="p-country-name">China</span><br />
          <a class="u-email" href="mailto:zac_ju@163.com">Email me</a>
        </p>
      </div>
      <p class="p-note">🐭</p>
    </div>
    
    <div id="footer">
      
      <nav id="article-skip">
        <div class="next">
          
          <a alt="Newer article" href="https://zacash.cn/post/handler-in-action/">&larr; Newer</a>
          
        </div>
        <div class="top">
          <a alt="Top of page" href="#">Top</a>
        </div>
        <div class="prev">
          
          <a alt="Older article" href="https://zacash.cn/post/hugo-basic/">Older &rarr;</a>
          
        </div>
      </nav>
      
      <aside id="social">
  <div id="social-icons">
    
    
    
    
    <div class="icon-24x24">
      <a class="glyph" alt="GitHub profile" href="https://github.com/zac4j"><img src=https://zacash.cn/icons/github.svg height="24px" width="24px"></a>
    </div>
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
</aside>

      
      <p class="copyright">
          Copyright © 2020, Copyright Zac
      </p>
      
    </div>


</body>
</html>