<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    
    <title>Intro to Service | Zac&#39;s Blog</title>
    <meta name="description" content="Android developer blog">
    <meta name="author" content="">
    
    <link rel="apple-touch-icon" sizes="180x180" href=https://zacash.cn/apple-touch-icon.png>
    <link rel="icon" type="image/png" sizes="32x32" href=https://zacash.cn/favicon-32x32.png>
    <link rel="icon" type="image/png" sizes="16x16" href=https://zacash.cn/favicon-16x16.png>
    <link rel="manifest" href=https://zacash.cn/site.webmanifest>
    <link rel="mask-icon" href=https://zacash.cn/safari-pinned-tab.svg color="#00416a">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="me" href="mailto:zac_ju@163.com">
    <link rel="me" href="https://github.com/zac4j">
    
    
    
    <link rel="authorization_endpoint" href=https://indieauth.com/auth />
    <link rel="token_endpoint" href=https://tokens.indieauth.com/token />
    
    
    
    
    
    <link rel="stylesheet" href=https://zacash.cn/css/fonts.css />
    <link rel="stylesheet" href=https://zacash.cn/css/style.css />
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="sitelogo">
        <a class="glyph" alt="Home" href="https://zacash.cn"><img src=https://zacash.cn/images/site-logo.svg alt="Site Logo" height="64px" width="64px"></a>
    </div>
    <header>
        <nav>
    
    <div id="page-nav">
        <div class="page-nav-item">
            <a href="https://zacash.cn">Home</a>
        </div>
        
            <div class="page-nav-item">
                <a href="/tags">
                    
                    <span>Tag</span>
                </a>
            </div>
        
            <div class="page-nav-item">
                <a href="/categories">
                    
                    <span>Category</span>
                </a>
            </div>
        
    </div>
</nav>
        
    </header>




<div id="content">
    <article class="h-entry">
        <header>
            <h1 class="post-title p-name">Intro to Service</h1>
            
            <p class="post-date">Posted on
                <time class="dt-published" datetime="2020-07-04T11:08:11&#43;08:00">
                    4 July, 2020 at 11:08 CST
                </time>  by <a href="https://zacash.cn" class="p-author h-card"
                    rel="author">Zac</a>
            </p>
            
            
        </header>
        <section class="content e-content">
            <h2 id="æŸ¥çœ‹è¿›ç¨‹åŸºæœ¬ä¿¡æ¯">æŸ¥çœ‹è¿›ç¨‹åŸºæœ¬ä¿¡æ¯</h2>
<p>ä½¿ç”¨ <code>adb shell ps|grep com.tencent.mobileqq</code> å¯ä»¥æŸ¥çœ‹ QQ åº”ç”¨è¿›ç¨‹ç›¸å…³çš„åŸºæœ¬ä¿¡æ¯</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Zac:tivi Zac$ adb shell ps | grep com.tencent.mobileqq
<span style="color:#75715e"># curr_user   pid                                                 process name</span>
u0_a163       <span style="color:#ae81ff">6779</span>   <span style="color:#ae81ff">669</span> <span style="color:#ae81ff">1638852</span>  <span style="color:#ae81ff">27152</span> <span style="color:#ae81ff">0</span>                   <span style="color:#ae81ff">0</span> S com.tencent.mobileqq:MSF
u0_a163      <span style="color:#ae81ff">22001</span>   <span style="color:#ae81ff">669</span> <span style="color:#ae81ff">1915536</span> <span style="color:#ae81ff">224004</span> <span style="color:#ae81ff">0</span>                   <span style="color:#ae81ff">0</span> S com.tencent.mobileqq
u0_a163      <span style="color:#ae81ff">27829</span>   <span style="color:#ae81ff">669</span> <span style="color:#ae81ff">1670960</span> <span style="color:#ae81ff">236668</span> <span style="color:#ae81ff">0</span>                   <span style="color:#ae81ff">0</span> S com.tencent.mobileqq:qzone
</code></pre></div><h2 id="è¿›ç¨‹çš„åˆ’åˆ†">è¿›ç¨‹çš„åˆ’åˆ†</h2>
<p>ä¸ºäº†ç¡®å®šåœ¨å†…å­˜ä¸è¶³æ—¶ kill å“ªäº›è¿›ç¨‹ï¼ŒAndroid ä¼šä¾æ®è¿›ç¨‹ä¸­è¿è¡Œçš„ç»„ä»¶ï¼ˆActivity/Service/BroadcastReceiverï¼‰å’Œè¿™äº›ç»„ä»¶çš„çŠ¶æ€ï¼Œåˆ’åˆ†æ¯ä¸ªè¿›ç¨‹çš„é‡è¦å±‚æ¬¡ç»“æ„ï¼ˆimportance hierarchyï¼‰ã€‚è¿™äº›è¿›ç¨‹æŒ‰é‡è¦æ€§æ’åº:</p>
<h3 id="å‰å°è¿›ç¨‹foreground-process">å‰å°è¿›ç¨‹ï¼ˆforeground processï¼‰</h3>
<p>å‰å°è¿›ç¨‹æ˜¯ç”¨æˆ·å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ“ä½œæ‰€å¿…é¡»çš„è¿›ç¨‹ï¼Œåº”ç”¨è¿›ç¨‹å†…çš„ç»„ä»¶å¯èƒ½ä»¥ä¸åŒå½¢å¼è®©å…¶å¤„äºå‰å°ï¼š</p>
<ul>
<li>Activity å¤„äºç”¨æˆ·æ­£åœ¨äº¤äº’çŠ¶æ€ï¼ˆonResume() æ–¹æ³•å·²è°ƒç”¨ï¼‰</li>
<li>BroadcastReceiver æ­£åœ¨è¿è¡Œï¼ˆBroadcastReceiver.onReceive() æ–¹æ³•æ­£åœ¨æ‰§è¡Œï¼‰</li>
<li>Service çš„å›è°ƒæ­£åœ¨æ‰§è¡Œä»£ç ï¼ˆService.onCreate(), Service.onStart(), Service.onDestroy()ï¼‰</li>
</ul>
<p>Android ç³»ç»Ÿä¸­åªæœ‰å°‘æ•°è¿™æ ·çš„è¿›ç¨‹ï¼Œè€Œä¸”åªæœ‰åœ¨å†…å­˜å¤ªä½ä¸”æ— æ³•è¿è¡Œè¿™äº›è¿›ç¨‹æ—¶ï¼Œæ‰ä¼š kill è¿™äº›è¿›ç¨‹ã€‚</p>
<h3 id="å¯è§è¿›ç¨‹visible-process">å¯è§è¿›ç¨‹ï¼ˆvisible processï¼‰</h3>
<p>å¯è§è¿›ç¨‹æ­£åœ¨æ‰§è¡Œç”¨æˆ·æ„è¯†åˆ°çš„å·¥ä½œï¼Œå› æ­¤ kill è¿™ç§è¿›ç¨‹å¯èƒ½å¯¹ç”¨æˆ·ä½“éªŒäº§ç”Ÿè´Ÿé¢å½±å“ã€‚è¿™ç§è¿›ç¨‹çš„ç»„ä»¶å¯ä»¥æœ‰å¦‚ä¸‹å½¢å¼ï¼š</p>
<ul>
<li>Activity å¯è§ä½†å¹¶ä¸å¤„äºå‰å°ï¼ˆonPause() æ–¹æ³•å·²è°ƒç”¨ï¼‰ï¼Œå¸¸è§çš„ä¾‹å­æ¯”å¦‚åœ¨å½“å‰ Activity å±•ç¤ºä¸€ä¸ªå¼¹çª—ã€‚</li>
<li>ä½¿ç”¨ <em>Service.startForeground()</em> æ–¹æ³•å¯åŠ¨çš„å‰å°æœåŠ¡ã€‚</li>
<li>ç‰¹å®šåŠŸèƒ½çš„æœåŠ¡ï¼Œå¦‚åŠ¨æ€å£çº¸ï¼Œè¾“å…¥æ³•æœåŠ¡ç­‰ã€‚</li>
</ul>
<h3 id="æœåŠ¡è¿›ç¨‹service-process">æœåŠ¡è¿›ç¨‹ï¼ˆservice processï¼‰</h3>
<p>æœåŠ¡è¿›ç¨‹æ˜¯æŒæœ‰ç”± <em>Service.startService()</em> æ–¹æ³•å¯åŠ¨çš„ Service è¿›ç¨‹ã€‚å°½ç®¡è¿™äº›è¿›ç¨‹ç”¨æˆ·å¹¶ä¸æ˜¯ç›´æ¥å¯è§ï¼Œä½†å®ƒåšçš„é€šå¸¸æ˜¯ç”¨æˆ·å…³å¿ƒçš„äº‹æƒ…ï¼Œå¦‚åå°ä¸Šä¼ /ä¸‹è½½ç½‘ç»œæ•°æ®ã€‚</p>
<p>é•¿æ—¶é—´(&gt; 30min)è¿è¡Œçš„æœåŠ¡å¯èƒ½ä¼šè¢«é™çº§ï¼Œå³ä¸‹é¢ä»‹ç»çš„ç¼“å­˜åˆ—è¡¨ï¼Œè¿™æœ‰åŠ©äºé¿å…é•¿æ—¶é—´æœåŠ¡å ç”¨è¿‡å¤šç³»ç»Ÿèµ„æºï¼ˆå¦‚å†…å­˜æ³„æ¼ï¼‰ã€‚</p>
<h3 id="ç¼“å­˜è¿›ç¨‹cached-process">ç¼“å­˜è¿›ç¨‹ï¼ˆcached processï¼‰</h3>
<p>ç¼“å­˜è¿›ç¨‹æ˜¯å½“å‰ä¸éœ€è¦çš„è¿›ç¨‹ï¼Œå½“åˆ«çš„åœ°æ–¹éœ€è¦ä½¿ç”¨å†…å­˜æ—¶ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆ kill æ‰è¿™ç§è¿›ç¨‹ã€‚åœ¨ä¸€ä¸ªè¿è¡Œè‰¯å¥½çš„ç³»ç»Ÿé€šå¸¸ä¼šæœ‰å¤šä¸ªå¯ç”¨çš„ç¼“å­˜è¿›ç¨‹ï¼Œå¹¶æ ¹æ®éœ€è¦å®šæœŸåˆ é™¤æœ€è€çš„è¿›ç¨‹ã€‚</p>
<p>è¿™äº›è¿›ç¨‹é€šå¸¸åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå½“å‰ç”¨æˆ·ä¸å¯è§çš„ Activity å®ä¾‹ï¼ˆå·²è°ƒç”¨ onStop() æ–¹æ³•ï¼‰ï¼Œåªè¦ App æ­£ç¡®çš„å®ç° Activity å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“ç³»ç»Ÿç»ˆæ­¢æ­¤ç±»è¿›ç¨‹æ—¶ï¼Œå®ƒä¸ä¼šå½±å“ç”¨æˆ·è¿”å›è¯¥ App æ—¶çš„ä½“éªŒï¼ˆåœ¨æ–°è¿›ç¨‹ä¸­é‡æ–°åˆ›å»ºå…³è” Activity æ—¶ï¼Œå®ƒå¯ä»¥æ¢å¤ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ï¼‰ã€‚</p>
<p>è¿™äº›è¿›ç¨‹ä¼šè¢«è®°å½•åœ¨ç¼“å­˜åˆ—è¡¨ä¸­ï¼Œè¯¥åˆ—è¡¨çš„è¿›ç¨‹ç»ˆæ­¢ç­–ç•¥ä¾èµ–å¹³å°çš„å…·ä½“å®ç°ï¼ŒåŸåˆ™ä¸Šä¼˜å…ˆä¿ç•™é‡è¦è¿›ç¨‹ã€‚å…¶ä»–çš„ç­–ç•¥åŒ…æ‹¬é™åˆ¶æœ€å¤§è¿›ç¨‹æ•°é‡ï¼Œä»¥åŠé™åˆ¶è¿›ç¨‹è¿è¡Œæ—¶é—´ç­‰ã€‚</p>
<h2 id="ç»ˆæ­¢è¿›ç¨‹low-memory-killer-daemon-lmkd">ç»ˆæ­¢è¿›ç¨‹ï¼ˆLow Memory Killer Daemon, lmkdï¼‰</h2>
<p>Android lmkd è¿›ç¨‹ç›‘æ§æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿå†…å­˜çŠ¶æ€ï¼Œå¹¶é€šè¿‡æ€æ­»æœ€ä¸é‡è¦è¿›ç¨‹ï¼ˆleast essential processesï¼‰æ¥åº”å¯¹é«˜å†…å­˜å‹åŠ›ï¼Œä»¥ä½¿ç³»ç»Ÿè¿è¡Œåœ¨å¯æ¥æ”¶çš„æ°´å¹³ã€‚</p>
<h3 id="æŸ¥çœ‹æ‰‹æœºçš„å†…å­˜é˜€å€¼">æŸ¥çœ‹æ‰‹æœºçš„å†…å­˜é˜€å€¼</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># root permission need</span>
adb shell cat /sys/module/lowmemorykiller/parameters/minfree
</code></pre></div><h3 id="adj">ADJ</h3>
<p>Adj å®šä¹‰åœ¨ <a href="https://android.googlesource.com/platform/frameworks/base/+/be4e6aa/services/java/com/android/server/am/ProcessList.java">frameworks/&hellip;/services/java/com/android/server/am/ProcessList.java</a> ä¸­ï¼Œ<code>oom_adj</code> è¡¨ç¤ºè¿›ç¨‹çš„ adj å€¼ï¼Œä¸€èˆ¬åœ¨ -17ï½16 é—´å–å€¼ï¼Œadj å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ï¼Œ<code>adj &lt; 0</code>çš„è¿›ç¨‹éƒ½æ˜¯ç³»ç»Ÿè¿›ç¨‹ã€‚<code>adj = 0</code> è¡¨ç¤ºè¿›ç¨‹å¤„äºå‰å°ã€‚</p>
<p>é€šè¿‡å‘½ä»¤æŸ¥çœ‹ <code>pid = 4061</code> è¿›ç¨‹çš„ adj å€¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># App å¤„äºå‰å°æ—¶</span>
adb shell cat /proc/4061/oom_adj
<span style="color:#ae81ff">0</span>
<span style="color:#75715e"># App å¤„äºåå°æ—¶</span>
Zac:tivi Zac$ adb shell cat /proc/4061/oom_adj
<span style="color:#ae81ff">11</span>
</code></pre></div><h3 id="è¿›ç¨‹ç»ˆæ­¢ç­–ç•¥">è¿›ç¨‹ç»ˆæ­¢ç­–ç•¥</h3>
<p><code>ProcessList</code> ä¸­å®šä¹‰çš„ <code>oomAdj</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// These are the various interesting memory levels that we will give to
</span><span style="color:#75715e">// the OOM killer.  Note that the OOM killer only supports 6 slots, so we
</span><span style="color:#75715e">// can&#39;t give it a different value for every possible kind of process.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> mOomAdj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> <span style="color:#f92672">{</span>
    FOREGROUND_APP_ADJ<span style="color:#f92672">,</span> VISIBLE_APP_ADJ<span style="color:#f92672">,</span> PERCEPTIBLE_APP_ADJ<span style="color:#f92672">,</span>
    BACKUP_APP_ADJ<span style="color:#f92672">,</span> CACHED_APP_MIN_ADJ<span style="color:#f92672">,</span> CACHED_APP_MAX_ADJ
<span style="color:#f92672">};</span>
</code></pre></div><p>åœ¨ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œä¾æ¬¡ä» <code>CACHED_APP_MAX_ADJ -&gt; .. -&gt;  FOREGROUND_APP_ADJ</code> ç»ˆæ­¢è¿›ç¨‹ã€‚</p>
<p>çœ‹å®Œè¿›ç¨‹æˆ‘ä»¬å†çœ‹çœ‹æœåŠ¡</p>
<h2 id="service-çš„ç”Ÿå‘½å‘¨æœŸ">Service çš„ç”Ÿå‘½å‘¨æœŸ</h2>
<p>Service çš„ç”Ÿå‘½å‘¨æœŸæ¯” Activity çš„è¦ç®€å•å¾ˆå¤šã€‚ä½†å…³æ³¨å…¶å¦‚ä½•åˆ›å»ºé”€æ¯åè€Œæ›´åŠ é‡è¦ï¼Œå› ä¸ºæœåŠ¡å¯ä»¥åœ¨ç”¨æˆ·æ²¡æœ‰æ„è¯†åˆ°çš„æƒ…å†µä¸‹åœ¨åå°è¿è¡Œã€‚</p>
<p>Service çš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥éµå¾ªä¸¤æ¡ä¸åŒçš„é€”å¾„ï¼š</p>
<ul>
<li>å¯åŠ¨æœåŠ¡
è¯¥æœåŠ¡åœ¨å…¶ä»–ç»„ä»¶ä¸­è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService()</a> æ—¶åˆ›å»ºï¼Œç„¶åæ— é™è¿è¡Œï¼Œå¿…é¡»é€šè¿‡ <a href="https://developer.android.com/reference/android/app/Service.html#stopSelf()">stopSelf()</a> æ¥è‡ªè¡Œåœæ­¢è¿è¡Œã€‚æ­¤å¤–ï¼Œå…¶ä»–ç»„ä»¶ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)">stopService()</a> æ¥åœæ­¢æœåŠ¡ã€‚æœåŠ¡åœæ­¢åï¼Œç³»ç»Ÿä¼šå°†å…¶é”€æ¯ã€‚</li>
<li>ç»‘å®šæœåŠ¡
è¯¥æœåŠ¡åœ¨å¦ä¸€ä¸ªç»„ä»¶ï¼ˆå®¢æˆ·ç«¯ï¼‰è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)">bindService()</a> æ—¶åˆ›å»ºã€‚ç„¶åå®¢æˆ·ç«¯é€šè¿‡ <a href="https://developer.android.com/reference/android/os/IBinder.html">IBinder</a> æ¥å£ä¸ Service è¿›è¡Œè¿›è¡Œé€šä¿¡ã€‚å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#unbindService(android.content.ServiceConnection)">unbindService()</a> æ¥å…³é—­è¿æ¥ã€‚å¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥ç»‘å®šåˆ°ç›¸åŒæœåŠ¡ï¼Œè€Œä¸”å½“æ‰€æœ‰ç»‘å®šå…¨éƒ¨å–æ¶ˆåï¼Œç³»ç»Ÿä¼šé”€æ¯è¯¥æœåŠ¡ã€‚ï¼ˆä¸å¿…è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)">stopService()</a> æ¥åœæ­¢æœåŠ¡)</li>
</ul>
<p>è¿™ä¸¤ç§çŠ¶æ€å¹¶éå®Œå…¨ç‹¬ç«‹ï¼Œå®é™…ä¸Šæ˜¯ <strong>å¯ä»¥å…±å­˜</strong> çš„ã€‚ä¾‹å¦‚å¯ä»¥ä½¿ç”¨ Intent è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService()</a> å¯åŠ¨åå°éŸ³ä¹æœåŠ¡ã€‚éšåï¼Œå¯èƒ½ç”¨æˆ·éœ€è¦åŠ å…¥æ§åˆ¶æ’­æ”¾å™¨è·å–æœ‰å…³æ’­æ”¾æ­Œæ›²ä¿¡æ¯æ—¶ï¼ŒActivity å¯ä»¥é€šè¿‡è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)">bindService()</a> ç»‘å®šåˆ°è¯¥æœåŠ¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé™¤éæ‰€æœ‰å®¢æˆ·ç«¯éƒ½å–æ¶ˆç»‘å®šï¼Œå¦åˆ™ <a href="https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)">stopService()</a> æˆ– <a href="https://developer.android.com/reference/android/app/Service.html#stopSelf()">stopSelf()</a> ä¸ä¼šåœæ­¢è¯¥æœåŠ¡ã€‚</p>
<h2 id="å®ç°-service-ç”Ÿå‘½å‘¨æœŸå›è°ƒ">å®ç° Service ç”Ÿå‘½å‘¨æœŸå›è°ƒ</h2>
<p>ä¸ Activity ç±»ä¼¼ï¼ŒService ä¹Ÿæ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡å®ç°è¿™äº›æ–¹æ³•æ¥ç›‘æ§Service çŠ¶æ€çš„å˜åŒ–ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> android.app.Service<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> android.content.Intent<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> android.os.IBinder<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> android.support.annotation.Nullable<span style="color:#f92672">;</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * Created by Zac on 2017/5/23.
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SampleService</span> <span style="color:#66d9ef">extends</span> Service <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> CHANNEL_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span><span style="color:#f92672">;</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * è¡¨ç¤ºæœåŠ¡è¢« kill ä¹‹åçš„è¡Œä¸º
</span><span style="color:#75715e">   */</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> mStartMode<span style="color:#f92672">;</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * è¡¨ç¤ºç»‘å®šè¯¥æœåŠ¡çš„ client
</span><span style="color:#75715e">   */</span>
  <span style="color:#66d9ef">private</span> IBinder mBinder<span style="color:#f92672">;</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * è¡¨ç¤ºæ˜¯å¦å…è®¸é‡æ–°ç»‘å®š
</span><span style="color:#75715e">   */</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> mAllowReind<span style="color:#f92672">;</span>

  <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onCreate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æœåŠ¡è¢«åˆ›å»º
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onCreate</span><span style="color:#f92672">();</span>
    startForeground<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * åˆ›å»ºå®šä¹‰çš„é€šçŸ¥
</span><span style="color:#75715e">   */</span>
  <span style="color:#66d9ef">private</span> Notification<span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span> <span style="color:#a6e22e">getNotification</span><span style="color:#f92672">(</span>String title<span style="color:#f92672">,</span> String body<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Notification<span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">(</span>appContext<span style="color:#f92672">,</span> CHANNEL_NAME<span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setContentTitle</span><span style="color:#f92672">(</span>title<span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setContentText</span><span style="color:#f92672">(</span>body<span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setSmallIcon</span><span style="color:#f92672">(</span>smallIcon<span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setAutoCancel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Nullable</span> <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> IBinder <span style="color:#a6e22e">onBind</span><span style="color:#f92672">(</span>Intent intent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å®¢æˆ·ç«¯é€šè¿‡ bindService() æ–¹æ³•ç»‘å®šæœåŠ¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> mBinder<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">onStartCommand</span><span style="color:#f92672">(</span>Intent intent<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> flags<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> startId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ç»„ä»¶è°ƒç”¨ startService() æ–¹æ³•å¯åŠ¨æœåŠ¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> mStartMode<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">onUnbind</span><span style="color:#f92672">(</span>Intent intent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æ‰€æœ‰ç»‘å®šçš„å®¢æˆ·ç«¯éƒ½å·²è°ƒç”¨ unbindService() æ–¹æ³•è§£ç»‘
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> mAllowReind<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onRebind</span><span style="color:#f92672">(</span>Intent intent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å®¢æˆ·ç«¯åœ¨onUnbind() æ–¹æ³•å›è°ƒä¹‹åï¼Œè°ƒç”¨ bindService() æ–¹æ³•ç»‘å®šæœåŠ¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onRebind</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onDestroy</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æœåŠ¡ä¸å†è¢«ä½¿ç”¨å¹¶è¢«é”€æ¯
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onDestroy</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="http://upload-images.jianshu.io/upload_images/1256396-2b2f6bb1c5e9f4c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="service_lifecycle.png"></p>
<blockquote>
<p>æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå·¦è¾¹æ˜¾ç¤ºäº†ä½¿ç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService()</a> æ‰€åˆ›å»ºçš„æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³è¾¹æ˜¾ç¤ºäº† <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)">bindService()</a> æ‰€åˆ›å»ºçš„æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
</blockquote>
<p>é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘æ§ Service ç”Ÿå‘½å‘¨æœŸçš„ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>
<p>Service çš„ <strong>æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ</strong> ä»è°ƒç”¨ onCreate() å¼€å§‹ï¼Œåˆ° onDestroy() è¿”å›æ—¶ç»“æŸã€‚ä¸ Activity ç±»ä¼¼ï¼ŒService ä¹Ÿåœ¨ onCreate() ä¸­å®Œæˆåˆå§‹è®¾ç½®ï¼Œå¹¶åœ¨ onDestroy() ä¸­é‡Šæ”¾æ‰€æœ‰å‰©ä½™èµ„æºã€‚ä¾‹å¦‚ï¼ŒéŸ³ä¹æ’­æ”¾å™¨å¯ä»¥åœ¨ onCreate() ä¸­åˆ›å»ºæ’­æ”¾éŸ³ä¹çš„çº¿ç¨‹ï¼Œç„¶ååœ¨ onDestroy() ä¸­åœæ­¢è¯¥çº¿ç¨‹ã€‚æ— è®º Service æ˜¯é€šè¿‡ <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService()</a> è¿˜æ˜¯ <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)">bindService()</a> æ–¹æ³•åˆ›å»ºï¼Œéƒ½ä¼šè°ƒç”¨ onCreate() å’Œ onDestroy() æ–¹æ³•ã€‚</p>
</li>
<li>
<p>Service çš„ <strong>æœ‰æ•ˆç”Ÿå‘½å‘¨æœŸ</strong> ä»è°ƒç”¨ <a href="https://developer.android.com/reference/android/app/Service.html#onStartCommand(android.content.Intent,int,int)">onStartCommand()</a> æˆ– <a href="https://developer.android.com/reference/android/app/Service.html#onBind(android.content.Intent)">onBind()</a> æ–¹æ³•å¼€å§‹ã€‚æ¯ç§æ–¹æ³•å‡æœ‰ Intent å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åˆ†åˆ«æ¥è‡ª <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService()</a> å’Œ <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)">bindService()</a> ã€‚å¯¹äºå¯åŠ¨æœåŠ¡ï¼Œæœ‰æ•ˆç”Ÿå‘½å‘¨æœŸå’Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒæ—¶ç»“æŸã€‚å¯¹äºç»‘å®šæœåŠ¡ï¼Œæœ‰æ•ˆç”Ÿå‘½å‘¨æœŸåœ¨ <a href="https://developer.android.com/reference/android/app/Service.html#onUnbind(android.content.Intent)">onUnbind()</a> è¿”å›æ—¶ç»“æŸã€‚</p>
</li>
</ul>
<blockquote>
<p>å°½ç®¡å¯åŠ¨æœåŠ¡æ˜¯é€šè¿‡ <a href="https://developer.android.com/reference/android/app/Service.html#stopSelf()">stopSelf()</a> æˆ– <a href="https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)">stopService()</a> æ¥åœæ­¢ï¼Œä½†è¯¥æœåŠ¡æ²¡æœ‰ç›¸åº”çš„å›è°ƒï¼ˆæ²¡æœ‰ onStop() å›è°ƒï¼‰ã€‚å› æ­¤ï¼Œé™¤éæ˜¯ç»‘å®šæœåŠ¡ï¼Œå¦åˆ™åœ¨æœåŠ¡åœæ­¢æ—¶ï¼Œç³»ç»Ÿä¼šå°†å…¶åœ¨ onDestroy() ä¸­é”€æ¯ã€‚</p>
</blockquote>
<p>ä¸Šå›¾è¯´æ˜äº†æœåŠ¡çš„å…¸å‹å›è°ƒæ–¹æ³•ã€‚å°½ç®¡è¯¥å›¾åˆ†å¼€ä»‹ç»é€šè¿‡ <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService()</a> åˆ›å»ºçš„æœåŠ¡å’Œé€šè¿‡ <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)">bindService()</a> åˆ›å»ºçš„æœåŠ¡ï¼Œä½†æ˜¯ä¸ç®¡å¯åŠ¨æ–¹å¼å¦‚ä½•ï¼Œä»»ä½•æœåŠ¡å‡æœ‰å¯èƒ½å…è®¸å®¢æˆ·ç«¯ä¸å…¶ç»‘å®šã€‚å› æ­¤ï¼Œæœ€åˆä½¿ç”¨ <a href="https://developer.android.com/reference/android/app/Service.html#onStartCommand(android.content.Intent,int,int)">onStartCommand()</a>ï¼ˆå®¢æˆ·ç«¯è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService()</a> ï¼‰å¯åŠ¨çš„æœåŠ¡ä»æœ‰å¯èƒ½æ¥æ”¶ <a href="https://developer.android.com/reference/android/app/Service.html#onBind(android.content.Intent)">onBind()</a> çš„è°ƒç”¨ï¼ˆå®¢æˆ·ç«¯è°ƒç”¨ <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)">bindService()</a> æ—¶ï¼‰ã€‚</p>
<h2 id="service-ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„çš„é—®é¢˜">Service ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„çš„é—®é¢˜</h2>
<h3 id="ä½•æ—¶ä½¿ç”¨-bounded-service-å’Œ-unbounded-server">ä½•æ—¶ä½¿ç”¨ Bounded service å’Œ Unbounded server</h3>
<p>å®˜æ–¹æ–‡æ¡£åœ¨ <a href="https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)">startService</a> æœ‰æè¿°ï¼š</p>
<blockquote>
<p>Note: Each call to startService() results in significant work done by the system to manage service lifecycle surrounding the processing of the intent, which can take multiple milliseconds of CPU time. Due to this cost, startService() should not be used for frequent intent delivery to a service, and only for scheduling significant work. Use bound services for high frequency calls.</p>
</blockquote>
<p>å¤§æ„æ˜¯æŒ‡ <code>startService()</code> æ–¹æ³•å¼€é”€æ¯”è¾ƒå¤§ï¼Œå› æ­¤åœ¨é«˜é¢‘æ¬¡è°ƒç”¨æœåŠ¡çš„åœºæ™¯ï¼Œæœ€å¥½ä½¿ç”¨ Bounded serviceï¼ŒUnbounded service ä»…ç”¨äºå®‰æ’é‡è¦å·¥ä½œã€‚</p>
<h3 id="android-o-ä»¥ä¸ŠæŠ¥-illegalstateexception">Android O ä»¥ä¸ŠæŠ¥ IllegalStateException</h3>
<p>Android O åŠ å¼ºäº†åå°æ‰§è¡Œçš„é™åˆ¶ï¼ŒApp å¤„äºåå°æ—¶ä¸å…è®¸é€šè¿‡ <code>startService()</code> çš„å½¢å¼å¯åŠ¨æœåŠ¡ï¼Œåªèƒ½é€šè¿‡ <code>startForegroundService()</code> æ–¹æ³•å¯åŠ¨æœåŠ¡ï¼Œè€Œä¸” App å¿…é¡»åœ¨åˆ›å»ºæœåŠ¡å5så†…è°ƒç”¨è¯¥æœåŠ¡çš„ <code>startForeground()</code> æ–¹æ³•ã€‚å…·ä½“çš„å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">if</span>(Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {
  startForegroundService(new Intent(MainActivity.<span style="color:#66d9ef">this</span>, SampleService.<span style="color:#66d9ef">class</span>));
}<span style="color:#66d9ef">else</span>{
  startService(new Intent(MainActivity.<span style="color:#66d9ef">this</span>, SampleService.<span style="color:#66d9ef">class</span>));
}
</code></pre></div>
        </section>
        <footer>
            <a class="permalink u-url" href="https://zacash.cn/post/intro-to-service/">ğŸ”—</a>
            
        </footer>
    </article>
</div>

    
    <div class="h-card">
      <img class="u-photo" src="https://zacash.cn/images/android-os.png" />
      <div class="card-content">
        <h2 class="card-name"><a class="p-name u-url" href="https://zacash.cn" rel="me">Zac</a></h2>
        <p class="card-subhead">
          <span class="p-locality">Shanghai</span>,
          <span class="p-country-name">China</span><br />
          <a class="u-email" href="mailto:zac_ju@163.com">Email me</a>
        </p>
      </div>
      <p class="p-note">ğŸ­</p>
    </div>
    
    <div id="footer">
      
      <nav id="article-skip">
        <div class="next">
          
          <a alt="Newer article" href="https://zacash.cn/post/intro-to-hybrid-app/">&larr; Newer</a>
          
        </div>
        <div class="top">
          <a alt="Top of page" href="#">Top</a>
        </div>
        <div class="prev">
          
          <a alt="Older article" href="https://zacash.cn/post/java-basic/">Older &rarr;</a>
          
        </div>
      </nav>
      
      <aside id="social">
  <div id="social-icons">
    
    
    
    
    <div class="icon-24x24">
      <a class="glyph" alt="GitHub profile" href="https://github.com/zac4j"><img src=https://zacash.cn/icons/github.svg height="24px" width="24px"></a>
    </div>
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
</aside>

      
      <p class="copyright">
          Copyright Â© 2020, Copyright Zac
      </p>
      
    </div>


</body>
</html>