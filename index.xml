<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Zac&#39;s Blog</title>
    <link>https://zacash.cn/</link>
    <description>Recent content on Zac&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-US</language>
    <copyright>Copyright © 2020, Copyright Zac</copyright>
    <lastBuildDate>Fri, 06 Nov 2020 00:00:00 +0000</lastBuildDate>
    
        <atom:link href="https://zacash.cn/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Use Hilt in Android</title>
      <link>https://zacash.cn/post/use-hilt-in-android/</link>
      <pubDate>Fri, 06 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>https://zacash.cn/post/use-hilt-in-android/</guid>
      <description>&lt;blockquote&gt;
&lt;p&gt;If you want to use dagger in  your project, you may have 2 or 3 different sources, different samples, different blog posts. All of them use a different set-up, and all of them use Dagger in a different way, so it&amp;rsquo;s very difficult to understand all the topics and relate them together. So that&amp;rsquo;s why Google create a common guidance, a common ground, which is called Hilt.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Hilt is an opinionated dependency injection library for Android that reduces the boilerplate of using manual DI in your project. Doing &lt;a href=&#34;https://developer.android.com/training/dependency-injection/manual&#34;&gt;manual dependency injection&lt;/a&gt; requires constructing every class and its denpendencies by hand and using &lt;strong&gt;containers&lt;/strong&gt; to reuse and manage &lt;strong&gt;dependencies&lt;/strong&gt;.&lt;/p&gt;
&lt;h2 id=&#34;dependencies-container&#34;&gt;Dependencies Container&lt;/h2&gt;
&lt;p&gt;Annotating Android classes with &lt;code&gt;@AndroidEntryPoint&lt;/code&gt; creates a &lt;strong&gt;dependencies container&lt;/strong&gt; that follows the Android lifecycle.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@AndroidEntryPoint
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;MainFragment&lt;/span&gt;: Fragment() {
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Hilt currently supports the following Android types: &lt;code&gt;Application&lt;/code&gt; by using(&lt;code&gt;@HiltAndroidApp&lt;/code&gt;), Activity, Fragment, Service and BroadcastReceiver.&lt;/p&gt;
&lt;p&gt;Hilt only supports activities that extend &lt;a href=&#34;https://developer.android.com/reference/androidx/fragment/app/FragmentActivity&#34;&gt;FragmentActivity&lt;/a&gt; and fragments that extend Jetpack library [Fragment][fx](Note:Hilt does not support retained fragments).&lt;/p&gt;
&lt;h3 id=&#34;container&#34;&gt;Container&lt;/h3&gt;
&lt;p&gt;A &lt;em&gt;container&lt;/em&gt; is a class which is in charge of providing dependencies in your codebase and knows how to create instances of other types of your app. It manages the graph of dependencies required to provide those instances by creating them and managing their lifecycle.&lt;/p&gt;
&lt;p&gt;A container exposes methods to get instances of the types it provides. Those methods can always return a different instance or the same instance. If the method always provides the same instance, we say that the type is &lt;em&gt;scoped&lt;/em&gt; to the container.&lt;/p&gt;
&lt;h3 id=&#34;hiltandroidapp&#34;&gt;@HiltAndroidApp&lt;/h3&gt;
&lt;p&gt;Annotating the Application class with &lt;code&gt;@HiltAndroidApp&lt;/code&gt;, we add a &lt;em&gt;container&lt;/em&gt; that is attached to the app&amp;rsquo;s lifecycle:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@HiltAndroidApp
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;App&lt;/span&gt;:Application() {
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;@HiltAndroidApp&lt;/code&gt; triggers Hilt&amp;rsquo;s code generation including a base class for our application that can use dependency injection. The application container is the &lt;strong&gt;parent container&lt;/strong&gt; of the app, which means that other containers can access the dependencies that it provides.&lt;/p&gt;
&lt;h2 id=&#34;provide-dependencies&#34;&gt;Provide dependencies&lt;/h2&gt;
&lt;h3 id=&#34;constructor-inject&#34;&gt;Constructor Inject&lt;/h3&gt;
&lt;p&gt;To tell Hilt how to provide instance of type, add the &lt;code&gt;@Inject&lt;/code&gt; annotation to the constructor of the class we want to be injected.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Logger&lt;/span&gt; @Inject &lt;span style=&#34;color:#66d9ef&#34;&gt;constructor&lt;/span&gt;() {
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;scoping-instance&#34;&gt;Scoping instance&lt;/h4&gt;
&lt;p&gt;Hilt can produce different containers that have different lifecycles, there are different annotations that scope to those containers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;@Singleton&lt;/code&gt;: Application container&lt;/li&gt;
&lt;li&gt;&lt;code&gt;@ActivityScoped&lt;/code&gt;: Activity container&lt;/li&gt;
&lt;li&gt;&lt;code&gt;@FragmentScoped&lt;/code&gt;: Fragment container&lt;/li&gt;
&lt;li&gt;&lt;code&gt;@ViewScoped&lt;/code&gt;: View container&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So we could annotating &lt;em&gt;Logger&lt;/em&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@Singleton
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Logger&lt;/span&gt; @Inject &lt;span style=&#34;color:#66d9ef&#34;&gt;constructor&lt;/span&gt;() {
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;modules&#34;&gt;Modules&lt;/h3&gt;
&lt;p&gt;For types that &lt;strong&gt;cannot be constructor injected&lt;/strong&gt;, such as interface or classes are not contained in our project, we should use &lt;strong&gt;Hilt modules&lt;/strong&gt;. An exemple of this is &lt;code&gt;OkHttpClient&lt;/code&gt;, we need to use its builder to create an instance.&lt;/p&gt;
&lt;p&gt;A Hilt module is a class annotated with &lt;code&gt;@Module&lt;/code&gt; and &lt;code&gt;@InstallIn&lt;/code&gt;. &lt;code&gt;@Module&lt;/code&gt; tells Hilt this is a module and &lt;code&gt;@InstallIn&lt;/code&gt; tells Hilt the bindings are specifying in which Hilt component.&lt;/p&gt;
&lt;p&gt;For each Android class that can be injected by Hilt, there&amp;rsquo;s an associated &lt;a href=&#34;https://developer.android.com/training/dependency-injection/hilt-android#generated-components&#34;&gt;Hilt Component&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@InstallIn(ApplicationComponent&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;)
@Module
&lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;DatabaseModule&lt;/span&gt; {
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;providing-instances-with-provides&#34;&gt;Providing instances with @Provides&lt;/h4&gt;
&lt;p&gt;We can annotate a function with &lt;code&gt;@Provides&lt;/code&gt; in Hilt modules to tell Hilt how to provide types that cannot be constructor injected.&lt;/p&gt;
&lt;p&gt;The function body of the &lt;code&gt;@Provides&lt;/code&gt; annotated function will be executed every time Hilt needs to provide an instance of that type. The return type of the &lt;code&gt;@Provides&lt;/code&gt; annotated function tells Hilt the bindings type or how to provide instances of that type.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@InstallIn(ApplicationComponent&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;)
@Module
&lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;DatabaseModule&lt;/span&gt; {

    &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     * We always want Hilt provide the same database instance, so annotate this
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     * method with @Singleton.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     *
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     * @param appContext: Each Hilt container comes with a set of default bindings that can be
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     * injected as dependencies into our custom bindings, to access this appContext, we annotate
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     * the filed with @ApplicationContext.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     */&lt;/span&gt;
    @Provides
    @Singleton
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;provideDatabase&lt;/span&gt;(@ApplicationContext appContext: Context): AppDatabase {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; Room.databaseBuilder(
            appContext,
            AppDatabase&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;.java,
            &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;logging.db&amp;#34;&lt;/span&gt;
        ).build()
    }

    &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     * provide AppDatabase dependency.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     */&lt;/span&gt;
    @Provides
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;provideLogDao&lt;/span&gt;(database: AppDatabase): LogDao {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; database.logDao()
    }

}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;providing-interface-impl-with-binds&#34;&gt;Providing interface impl with @Binds&lt;/h4&gt;
&lt;p&gt;To tell Hilt what implementation to use for an interface, we can use the &lt;code&gt;@Binds&lt;/code&gt; annotation on a function inside a Hilt module.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;@Binds&lt;/code&gt; must annotate an abstract function, since &lt;strong&gt;Hilt modules cannot contain both non-static and abstract binding methods&lt;/strong&gt;, so we cannot place &lt;code&gt;@Binds&lt;/code&gt; and &lt;code&gt;@Provides&lt;/code&gt; annotations in the same class.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@InstallIn(ActivityComponent&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;)
@Module
&lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NavigationModule&lt;/span&gt; {

    &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     * To tell Hilt how to provide instances of AppNavigatorImpl, we just annotate its constructor with `@Inject`
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;     */&lt;/span&gt;
    @Binds
    &lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;bindNavigator&lt;/span&gt;(impl: AppNavigatorImpl): AppNavigator
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;providing-different-interface-impl-with-qualifier&#34;&gt;Providing different interface impl with @Qualifier&lt;/h4&gt;
&lt;p&gt;Assume that LoggerDataSource interface has two different implementation.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoggerDataSource&lt;/span&gt; {
    ...
}

@Singleton
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoggerLocalDataSource&lt;/span&gt; @Inject &lt;span style=&#34;color:#66d9ef&#34;&gt;constructor&lt;/span&gt;(
    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; logDao: LogDao
): LoggerDataSource {
    ...
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Scoping to the Activity container
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
@ActivityScoped
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoggerInMemoryDataSource&lt;/span&gt; @Inject &lt;span style=&#34;color:#66d9ef&#34;&gt;constructor&lt;/span&gt;(
): LoggerDataSource {
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;At this moment, Hilt knows how to provide instances of &lt;code&gt;LoggerInMemoryDataSource&lt;/code&gt; and &lt;code&gt;LoggerLocalDataSource&lt;/code&gt; but doesn&amp;rsquo;t know which implementation to use when &lt;code&gt;LoggerDataSource&lt;/code&gt; is requested.&lt;/p&gt;
&lt;p&gt;We know that we can use the &lt;code&gt;@Binds&lt;/code&gt; annotation to provide &lt;strong&gt;one&lt;/strong&gt; &lt;code&gt;LoggerDataSource&lt;/code&gt; implementation, but if we need to provide both implementations in the same project?&lt;/p&gt;
&lt;h5 id=&#34;two-implementations-for-the-same-interface&#34;&gt;Two implementations for the same interface&lt;/h5&gt;
&lt;p&gt;Since the different implementations of &lt;code&gt;LoggerDataSource&lt;/code&gt; are scoped to different containers, we cannot use the same module:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;LoggerInMemoryDataSource&lt;/em&gt; is scoped in Actiivty container&lt;/li&gt;
&lt;li&gt;&lt;em&gt;LoggerLocalDataSource&lt;/em&gt; is scoped in Application container&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We should define two different module:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@InstallIn(ApplicationComponent&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;)
@Module
&lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoggingDatabaseModule&lt;/span&gt; {
    @Singleton
    @Binds
    &lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;bindDatabaseLogger&lt;/span&gt;(impl: LoggerLocalDataSource): LoggerDataSource
}

@InstallIn(ActivityComponent&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;)
@Module
&lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoggingInMemortModule&lt;/span&gt; {
    @ActivityScoped
    @Binds
    &lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;bindInMemoryLogger&lt;/span&gt;(impl: LoggerInMemoryDataSource): LoggerDataSource
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;@Binds method must have the scoping annotations if the type is scoped&lt;/strong&gt;, so that&amp;rsquo;s why the functions above are annotated with &lt;code&gt;@Singleton&lt;/code&gt; and &lt;code&gt;@ActivityScoped&lt;/code&gt;. If &lt;code&gt;@Binds&lt;/code&gt; or &lt;code&gt;@Provides&lt;/code&gt; are used as a binding for a type, the scoping annotations in the implementation classes are not used anymore, so we can remove them.&lt;/p&gt;
&lt;p&gt;If we buid the project right now, we&amp;rsquo;ll see &lt;code&gt;DuplicateBindings&lt;/code&gt; error:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[Dagger/DuplicateBindings] com.example.android.hilt.data.LoggerDataSource is bound multiple times&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;This is because the &lt;code&gt;LoggerDataSource&lt;/code&gt; type is being injected in &lt;code&gt;Fragment&lt;/code&gt;, but &lt;strong&gt;Hilt doesn&amp;rsquo;t know which implementation to use because there are two bindings of the same tyoe!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;To tell Hilt how to provide different implementations (multiple bindings) of the same type, we can use qualifier annotation.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@Qualifier
&lt;span style=&#34;color:#66d9ef&#34;&gt;annotation&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;InMemoryLogger&lt;/span&gt;

@Qualifier
&lt;span style=&#34;color:#66d9ef&#34;&gt;annotation&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;DatabaseLogger&lt;/span&gt;

@InstallIn(ApplicationComponent&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;)
@Module
&lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoggingDatabaseModule&lt;/span&gt; {

    @DatabaseLogger
    @Singleton
    @Binds
    &lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;bindDatabaseLogger&lt;/span&gt;(impl: LoggerLocalDataSource): LoggerDataSource
}

@InstallIn(ActivityComponent&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;)
@Module
&lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoggingInMemoryModule&lt;/span&gt; {

    @InMemoryLogger
    @ActivityScoped
    @Binds
    &lt;span style=&#34;color:#66d9ef&#34;&gt;abstract&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;bindInMemoryLogger&lt;/span&gt;(impl: LoggerInMemoryDataSource): LoggerDataSource
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;inject-dependencies&#34;&gt;Inject dependencies&lt;/h2&gt;
&lt;p&gt;We can make Hilt inject instances of different types with the &lt;code&gt;@Inject&lt;/code&gt; annotation on the fields we want to be injected:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;@AndroidEntryPoint
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;LoginFragment&lt;/span&gt;:Fragment() {
    &lt;span style=&#34;color:#75715e&#34;&gt;// note that fields injected by Hilt cannot be private.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    @InmemoryLogger
    @Inject &lt;span style=&#34;color:#66d9ef&#34;&gt;lateinit&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; logger: LoggerDataSource
    @Inject &lt;span style=&#34;color:#66d9ef&#34;&gt;lateinit&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; formatter: Formatter
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Introduction to Custom View</title>
      <link>https://zacash.cn/post/custom-view-introduction/</link>
      <pubDate>Sun, 06 Sep 2020 11:11:13 +0800</pubDate>
      
      <guid>https://zacash.cn/post/custom-view-introduction/</guid>
      <description>&lt;p&gt;To create a custom view we can either extend an existing &lt;code&gt;View&lt;/code&gt; subclass(like EditText), or create our own subclass of View. By extending View directly, we can create an interactive UI element of any size and shape by overriding the &lt;code&gt;onDraw()&lt;/code&gt; method for the View to draw it.&lt;/p&gt;
&lt;p&gt;This article resource from official Android &lt;a href=&#34;https://codelabs.developers.google.com/codelabs/advanced-andoid-kotlin-training-custom-views&#34;&gt;custom view&lt;/a&gt; codelab. I think you&amp;rsquo;ll get the most value if you work through this codelab in sequence.&lt;/p&gt;
&lt;h2 id=&#34;understanding-custom-views&#34;&gt;Understanding custom views&lt;/h2&gt;
&lt;p&gt;Views are the basic blocks of an app&amp;rsquo;s UI. the View class provides many subclasses, referred to as &lt;em&gt;UI widgets&lt;/em&gt;, that cover many of the needs of a typical Android app&amp;rsquo;s user interface.&lt;/p&gt;
&lt;p&gt;UI building blocks such as EditText or TextView are subclasses that extend the View class. To save time and development effort, we can extend one of these View subclasses.&lt;/p&gt;
&lt;p&gt;To create our custom view from scratch, extend the View class itself. Our code overrides &lt;code&gt;View&lt;/code&gt; methods to define the view&amp;rsquo;s appearance and functionality. Key to create our custom view is that we are responsible for &lt;strong&gt;drawing the entire UI element of any size and shape to the screen&lt;/strong&gt;. If we subclass an existing view such as &lt;code&gt;Button&lt;/code&gt;, that class handles drawing for us.&lt;/p&gt;
&lt;h3 id=&#34;general-steps-to-create-a-custom-view&#34;&gt;General steps to create a custom view&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Create a custom view class that extends &lt;code&gt;View&lt;/code&gt;, or extends a &lt;code&gt;View&lt;/code&gt; subclass(such as &lt;code&gt;TextView&lt;/code&gt; or &lt;code&gt;Button&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;If we extend a subclass of View(like Button), override only the behavior or aspect of the appearance methods that we want to change.&lt;/li&gt;
&lt;li&gt;If we extend View class, draw the custom view&amp;rsquo;s shape and control its appearance by overriding View methods such as &lt;code&gt;onDraw()&lt;/code&gt; and &lt;code&gt;onMeasure()&lt;/code&gt; in the new class.&lt;/li&gt;
&lt;li&gt;Add code to respond to user interaction and, if necessary, redraw the custom view.&lt;/li&gt;
&lt;li&gt;Use the custom view class as UI widget in activity&amp;rsquo;s XML layout. We can also define custom attributes(in &lt;code&gt;attrs.xml&lt;/code&gt; file) for the view, to provide customization for the view in different layouts.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;drawing-custom-views&#34;&gt;Drawing custom views&lt;/h2&gt;
&lt;p&gt;When we creating custom view from scratch(by extending &lt;code&gt;View&lt;/code&gt;), we are responsible for drawing the entire view each time the screen refreshes, and for overriding the View methods that handle drawing. In order to properly &lt;strong&gt;draw a custom view&lt;/strong&gt; that extends View, we need to follw this step:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Calculate the view&amp;rsquo;s size when it first appears, and each time that view&amp;rsquo;s size changes, by overriding the &lt;code&gt;onSizeChanged()&lt;/code&gt; method.&lt;/li&gt;
&lt;li&gt;Override the &lt;code&gt;onDraw()&lt;/code&gt; method to draw the custom view, using a &lt;code&gt;Canvas&lt;/code&gt; object styled by a &lt;code&gt;Paint&lt;/code&gt; object.&lt;/li&gt;
&lt;li&gt;Call the &lt;code&gt;invalidate()&lt;/code&gt; method when responding to a user click that changes how the view is drawn to invalidate the entire view, thereby forcing a call to &lt;code&gt;onDraw()&lt;/code&gt; to redraw the view.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;code&gt;onDraw()&lt;/code&gt; method is called every time that screen refreshes, which can be many time a second. For performance reasons and to avoid visual glitches, we should do as little work as possible in &lt;code&gt;onDraw()&lt;/code&gt;. In particular, don&amp;rsquo;t place allocations in &lt;code&gt;onDraw()&lt;/code&gt;, because allocations may lead to garbage collection that may cause a visual stutter.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;Canvas&lt;/code&gt; and &lt;code&gt;Paint&lt;/code&gt; classes offer a number of useful &lt;strong&gt;drawing shortcuts&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Draw text using &lt;code&gt;drawText()&lt;/code&gt;. Specify the typeface by calling &lt;code&gt;setTypeface()&lt;/code&gt;, and the text color by calling &lt;code&gt;setColor()&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Draw primitive shapes using &lt;code&gt;drawRect()&lt;/code&gt;, &lt;code&gt;drawOval()&lt;/code&gt; and &lt;code&gt;drawArc()&lt;/code&gt;. Change whether that shapes are filled, outlined, or both by calling &lt;code&gt;setStyle()&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Draw bitmaps using &lt;code&gt;drawBitmap()&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: in apps that have a deep view hierarchy, we can also override the &lt;code&gt;onMeasure()&lt;/code&gt; method to accurately define how custom view fits into the layout. That way, the parent layout can properly align the custom view. The &lt;code&gt;onMeasure()&lt;/code&gt; method provides a set of &lt;code&gt;measureSpecs&lt;/code&gt; that we can use to determine out view&amp;rsquo;s height and width. Learn more &lt;a href=&#34;https://developer.android.com/guide/topics/ui/how-android-draws.html&#34;&gt;how android draws&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;change-custom-view-behavior&#34;&gt;Change custom view behavior&lt;/h2&gt;
&lt;h3 id=&#34;add-view-interactivity&#34;&gt;Add view interactivity&lt;/h3&gt;
&lt;p&gt;Normally, with a standard Android view, we implement &lt;code&gt;OnClickListener()&lt;/code&gt; to perform an action when the user clicks that view. For a custom view, we should:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Set the view&amp;rsquo;s isClickable property to true. This enables custom view to respond to clicks.&lt;/li&gt;
&lt;li&gt;Implement the &lt;code&gt;View&lt;/code&gt; class&amp;rsquo;s &lt;code&gt;performClick()&lt;/code&gt; to perform operations when the view is clicked.&lt;/li&gt;
&lt;li&gt;Call the &lt;code&gt;invalidate()&lt;/code&gt; method. This tells the Android system to call the &lt;code&gt;onDraw()&lt;/code&gt; method to redraw the view.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;use-custom-attributes-with-custom-view&#34;&gt;Use custom attributes with custom view&lt;/h3&gt;
&lt;p&gt;To use a custom attributes we should:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Create and open &lt;code&gt;res/values/attrs.xml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Inside &lt;code&gt;&amp;lt;resource&amp;gt;&lt;/code&gt;, add a &lt;code&gt;&amp;lt;declare-styleable&amp;gt;&lt;/code&gt; resource element.&lt;/li&gt;
&lt;li&gt;Inside the &lt;code&gt;&amp;lt;declare-styleable&amp;gt;&lt;/code&gt; resource element, add three &lt;code&gt;attr&lt;/code&gt; elements, one for each attribute, with a &lt;code&gt;name&lt;/code&gt; and &lt;code&gt;format&lt;/code&gt;. The &lt;code&gt;format&lt;/code&gt; is the attribute&amp;rsquo;s type, such as &lt;code&gt;color&lt;/code&gt; or &lt;code&gt;string&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The sample code is:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;utf-8&amp;#34;?&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;resources&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;declare-styleable&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CustomView&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;attr&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;customColor&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;format=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;color&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;attr&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;customString&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;format=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;string&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;attr&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;customInteger&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;format=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;integer&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/declare-styleable&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/resources&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;Note: the &lt;code&gt;attr&lt;/code&gt; name is, by convention, the same name as the name ofthe class that defines the custom view. Although it&amp;rsquo;s not strictly necessary to follow this convention, Android Studio depend on this naming convention to provide statement completion.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Open &lt;code&gt;fragment_custom_ui.xml&lt;/code&gt; layout file, in &lt;code&gt;CustomView&lt;/code&gt;, add attribute for &lt;code&gt;customColor&lt;/code&gt;, &lt;code&gt;customString&lt;/code&gt;, &lt;code&gt;customInteger&lt;/code&gt;, and set their value. Use &lt;code&gt;app:&lt;/code&gt; as preface for the custom attribute rather than &lt;code&gt;android:&lt;/code&gt; because we custom attribute belong to the &lt;code&gt;schemas.android.com/apk/res/app_package_name&lt;/code&gt; namespace rather than the android namespace.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;com.zac4j.ui.widget.CustomView&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:id=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@+id/customView&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_width=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;200dp&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_height=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;200dp&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_marginLeft=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;8dp&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_marginTop=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;8dp&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_marginRight=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;8dp&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:background=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@android:color/darker_gray&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;app:customColor=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;#009688&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;app:customString=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@string/hello&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;app:customInteger=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0x101&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;app:layout_constraintLeft_toLeftOf=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;parent&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;app:layout_constraintRight_toRightOf=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;parent&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;app:layout_constraintTop_toBottomOf=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@id/customViewLabel&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In order to use the attributes in &lt;code&gt;CustomView&lt;/code&gt; class, we need to retrieve them. They are stored in an &lt;code&gt;AttributeSet&lt;/code&gt;, which is handed to out class upon creation, if it exists. We retrieve the attributes in &lt;code&gt;init&lt;/code&gt;, and assign the attribute values to local vaributes for caching.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Open the &lt;code&gt;CustomView.kt&lt;/code&gt; class file.&lt;/li&gt;
&lt;li&gt;Inside the &lt;code&gt;CustomView&lt;/code&gt; declare vaributes to cache the attribute values.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; customColor = &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; customString = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; customInt = &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Inside the &lt;code&gt;init&lt;/code&gt; block, add the following code using the &lt;code&gt;withStyledAttributes&lt;/code&gt; extension function. We supply the attributes and view, and set the local vaributes. Importing &lt;code&gt;withStyledAttributes&lt;/code&gt; will also import the right &lt;code&gt;getColor&lt;/code&gt; function.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;context.withStyledAttributes(attrs, R.styleable.CustomView) {
   customColor = getColor(R.styleable.CustomView_customColor, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;)
   customString = getString(R.styleable.CustomView_customString, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
   customInt = getInt(R.styleable.CustomView_customInteger, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;Android and the Kotlin extension library (&lt;a href=&#34;https://android.github.io/android-ktx/core-ktx/index.html&#34;&gt;android-ktx&lt;/a&gt;) do a lot of work for you here! The android-ktx library provides Kotlin extensions with a strong quality-of-life focus. For example, the &lt;a href=&#34;https://android.github.io/android-ktx/core-ktx/androidx.content/android.content.-context/index.html&#34;&gt;withStyledAttributes&lt;/a&gt; extension replaces a significant number of lines of rather tedious boilerplate code. For more on this library, check out the documentation, and the &lt;a href=&#34;https://android-developers.googleblog.com/2018/02/introducing-android-ktx-even-sweeter.html&#34;&gt;original announcement&lt;/a&gt; blog post!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Use the local variables in &lt;code&gt;onDraw()&lt;/code&gt; to set the color and label to the current view.&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Intro to Navigation</title>
      <link>https://zacash.cn/post/intro-to-navigation/</link>
      <pubDate>Sun, 23 Aug 2020 11:11:13 +0800</pubDate>
      
      <guid>https://zacash.cn/post/intro-to-navigation/</guid>
      <description>&lt;h2 id=&#34;navhostfragment&#34;&gt;NavHostFragment&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;NavHostFragment&lt;/code&gt; acts as a host for the fragments in the navigation graph.&lt;/p&gt;
&lt;p&gt;As the user moves between destination defined in the navigation graph, the &lt;code&gt;NavHostFragment&lt;/code&gt; swaps the fragments in and out and manages the Fragment back stack.&lt;/p&gt;
&lt;p&gt;In the &lt;code&gt;activity_main.xml&lt;/code&gt; layout file, the &lt;code&gt;NavHostFragment&lt;/code&gt; is represented by a &lt;code&gt;fragment&lt;/code&gt; element with the name &lt;code&gt;android:name=&amp;quot;androidx.navigation.fragment.NavHostFragment&amp;quot;&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;backstack-in-navigation&#34;&gt;BackStack in Navigation&lt;/h2&gt;
&lt;p&gt;Each time user goes to a new destination on the device, Android adds that destination to the &lt;em&gt;back stack&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;When user presses the Back Button, the app goes to the destination that&amp;rsquo;s at the top of the back stack. By default, the top of the back stack is the screen that the user last viewed.&lt;/p&gt;
&lt;h3 id=&#34;set-the-pop-behavior-for-the-navigation-actions&#34;&gt;Set the pop behavior for the navigation actions&lt;/h3&gt;
&lt;p&gt;We can manage the back stack by setting the pop behavior for the actions that connect the fragments:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;popUpTo&lt;/code&gt; attribute of an action &amp;ldquo;pops up&amp;rdquo; the back stack to a given destination before navigating.&lt;/li&gt;
&lt;li&gt;If the &lt;code&gt;popUpToInclusive&lt;/code&gt; attribute is &lt;code&gt;false&lt;/code&gt; or is not set, &lt;code&gt;popUpTo&lt;/code&gt; removes destinations up to the specified destination, but leaves the specified destination in the back stack.&lt;/li&gt;
&lt;li&gt;If &lt;code&gt;popUpToInclusive&lt;/code&gt; is set to true, the &lt;code&gt;popUpTo&lt;/code&gt; attribute removes all destinations up to and including the given destination from the back stack.&lt;/li&gt;
&lt;li&gt;If &lt;code&gt;popUpToInclusive&lt;/code&gt; is &lt;code&gt;true&lt;/code&gt; and &lt;code&gt;popUpTo&lt;/code&gt; is set to the app&amp;rsquo;s starting location, the action removes all app destination from the back stack. The Back button takes the user all the way out of the app.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;the-up-button&#34;&gt;The Up button&lt;/h2&gt;
&lt;p&gt;The Up button appears at the top left of the &lt;a href=&#34;https://developer.android.com/topic/libraries/architecture/navigation/navigation-ui#top_app_bar&#34;&gt;app bar&lt;/a&gt;(sometimes called action bar) The Up button navigates &amp;ldquo;upwards&amp;rdquo; within the app&amp;rsquo;s screens, based on the hierarchical relationships between screens.&lt;/p&gt;
&lt;p&gt;The navigation controller&amp;rsquo;s &lt;a href=&#34;https://developer.android.com/topic/libraries/architecture/navigation/navigation-ui&#34;&gt;NavigationUI&lt;/a&gt; library integrates with the app bar to allow user tap Up button to get back to the app&amp;rsquo;s home screen from anywhere in the app.&lt;/p&gt;
&lt;p&gt;link step:&lt;/p&gt;
&lt;h3 id=&#34;navhostfragment-in-fragmentcontainerview-element&#34;&gt;NavHostFragment in FragmentContainerView element&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;In &lt;code&gt;onCreate()&lt;/code&gt;, call:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; navHostFragment = supportFragmentManager.findFragmentById(R.id.nav_host_fragment) &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; NavHostFragment
&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; navController = navHostFragment.navController
NavigationUI.setupActionBarWithNavController(&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;, navController)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Override &lt;code&gt;onSupportNavigateUp()&lt;/code&gt; method to call &lt;code&gt;navigateUp()&lt;/code&gt; in the navigatiohn controller:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onSupportNavigateUp&lt;/span&gt;(): Boolean {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; navHostFragment = supportFragmentManager.findFragmentById(R.id.nav_host_fragment) &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; NavHostFragment
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; navController = navHostFragment.navController
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; navController.navigateUp()
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;navhostfragment-in-fragment-element&#34;&gt;NavHostFragment in fragment element&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;In &lt;code&gt;onCreate()&lt;/code&gt;, call:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; navController = findNavController(R.id.nav_host_fragment)
NavigationUI.setupActionBarWithNavController(&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;, navController)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Override &lt;code&gt;onSupportNavigateUp()&lt;/code&gt; method to call &lt;code&gt;navigateUp()&lt;/code&gt; in the navigatiohn controller:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onSupportNavigateUp&lt;/span&gt;(): Boolean {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; navController = findNavController(R.id.nav_host_fragment)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; navController.navigateUp()
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;safe-args-plugin&#34;&gt;Safe Args Plugin&lt;/h2&gt;
&lt;p&gt;When we needs to pass parameters from one fragment to another. To prevent bugs in these transactions and make them type-safe, we use a Gradle plugin called &lt;a href=&#34;https://developer.android.com/topic/libraries/architecture/navigation/navigation-pass-data#Safe-args&#34;&gt;Safe Args&lt;/a&gt;. The plugin generates &lt;code&gt;NavDirection&lt;/code&gt; class, and we could use these classes to pass parameters.&lt;/p&gt;
&lt;p&gt;We used a &lt;code&gt;Bundle&lt;/code&gt; to pass data from fragment A to fragment B in the past. These lead two kinds of errors:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Type mis-match error. For example, if Fragment A sends a String but Fragment requests an Integer from &lt;code&gt;Bundle&lt;/code&gt;, the request returns the default value of integer is 0.&lt;/li&gt;
&lt;li&gt;Missing key errors. If fragment B requests an argument that isn&amp;rsquo;t set in the bundle, the operation return &lt;code&gt;null&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;All above errors might make app misbehave or crash in runtime, but we can use &lt;em&gt;Safe Argu&lt;/em&gt; to catch these errors in compile time, Safe Args is a Gradle plugin that generates code and classes that help to detect errors at compile-time that might not otherwise be surfaced until the app runs.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Data Binding in Android</title>
      <link>https://zacash.cn/post/databinding-in-android/</link>
      <pubDate>Sun, 23 Aug 2020 08:37:45 +0800</pubDate>
      
      <guid>https://zacash.cn/post/databinding-in-android/</guid>
      <description>&lt;p&gt;每次在 view 发生创建或重建，我们使用 &lt;code&gt;findViewById()&lt;/code&gt; 来获取 view 的引用时，Android 系统在运行时会遍历整个视图层级结构（view hierarchy）来查找它。在我们 app 的视图结构比较简单时没有问题，但是生产上的 app 一个 layout 可能有几十个 views，即使是最佳设计，也会存在嵌套的 views.&lt;/p&gt;
&lt;h2 id=&#34;intro-to-databinding&#34;&gt;Intro to DataBinding&lt;/h2&gt;
&lt;p&gt;对于庞大或较深的视图层级结构，查找 view 可能耗费很多时间，从而可能明显降低 app 的响应速度。我们可以在变量中缓存这些 view 的引用，但这需要我们在每个 Activity/Fragment 中对于每个 view 都创建变量来暂存引用。&lt;/p&gt;
&lt;p&gt;另一种方案是创建一个对象包含每个 view 的引用。整个对象，称为 &lt;em&gt;绑定对象（binding object）&lt;/em&gt;，可以被整个 app 使用。这项技术被称为 &lt;em&gt;数据绑定（data binding）&lt;/em&gt;。当 app 的绑定对象创建后，我们可以通过绑定对象访问 views，或别的数据，而不用遍历整个 view hierarchy 来查找它们。&lt;/p&gt;
&lt;h2 id=&#34;findviewbyid-vs-databinding&#34;&gt;findViewById vs. DataBinding&lt;/h2&gt;
&lt;p&gt;Data binding 有如下优势：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;与 &lt;code&gt;findView&lt;/code&gt; 相比代码更简洁，更易于阅读和维护。&lt;/li&gt;
&lt;li&gt;数据和 views 明确分离，&lt;/li&gt;
&lt;li&gt;Android 系统在 app 启动时仅遍历 view hierarchy 一次即可获取每个 view 的引用，而不是像 &lt;code&gt;findView&lt;/code&gt; 在运行时获取 view 引用。&lt;/li&gt;
&lt;li&gt;我们可以 &lt;a href=&#34;https://en.wikipedia.org/wiki/Type_safety&#34;&gt;type safety&lt;/a&gt; 访问 views。（Type safety 意味着编译器在编译时会验证类型，如果我们将错误的类型分配给变量，则会引发编译错误。）&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;databing-expression&#34;&gt;Databing expression&lt;/h2&gt;
&lt;h3 id=&#34;formatted-string&#34;&gt;Formatted string&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;String res:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;string&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quote_format&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;\&amp;#34;%s\&amp;#34;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;string&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;score_format&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;Current Score: %d&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Layout res:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;TextView&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:id=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@+id/word_text&amp;#34;&lt;/span&gt;
   &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;...&lt;/span&gt;
   &lt;span style=&#34;color:#a6e22e&#34;&gt;android:text=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@{@string/quote_format(gameViewModel.word)}&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;null-coalescing-operator&#34;&gt;Null coalescing operator&lt;/h3&gt;
&lt;p&gt;The null coalescing operator (??) chooses the left operand if isn&amp;rsquo;t null or the right if the former is null.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;TextView&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:text=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@{user.displayName ?? user.lastName}&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This is functionally equivalent to:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;TextView&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:text=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@{user.displayName != null ? user.displayName : user.lastName}&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Generics in Kotlin</title>
      <link>https://zacash.cn/post/generics-in-kotlin/</link>
      <pubDate>Fri, 14 Aug 2020 07:27:09 +0800</pubDate>
      
      <guid>https://zacash.cn/post/generics-in-kotlin/</guid>
      <description>&lt;p&gt;val 和 var 与 variables 的 VALUES 相关，val 保护变量的值不变。in 和 out 与 variables 的 TYPES 相关，in 和 out 保证在范型的使用中，只有安全的类型才能传入或传出函数。&lt;/p&gt;
&lt;h2 id=&#34;define-an-out-type&#34;&gt;Define an out type&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Define a WaterSupply class and verify if water needs processing.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;open&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;WaterSupply&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; needsProcessing: Boolean)

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Define a TapWater class extends [WaterSupply] class.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;TapWater&lt;/span&gt;: WaterSupply(&lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;) {
    &lt;span style=&#34;color:#75715e&#34;&gt;// We do water processing by add chemical cleaners.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;addChemicalCleaners&lt;/span&gt;() {
        needsProcessing = &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
  }
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Define a Aquarium class, it accept water supply.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Aquarium&lt;/span&gt;&amp;lt;&lt;span style=&#34;color:#66d9ef&#34;&gt;out&lt;/span&gt; T: WaterSupply&amp;gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; waterSupply: T) {
    ...
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Define a funtion that could add Aquarium item.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;addItem&lt;/span&gt;(aquarium: Aquarium&amp;lt;WaterSupply&amp;gt;) = println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;item added&amp;#34;&lt;/span&gt;)

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Test function
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;g1&lt;/span&gt;() {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; aquarium = Aquarium(TapWater())
    addItem(aquarium)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果我们移除了 &lt;code&gt;class Aquarium&amp;lt;out T: WaterSupply&amp;gt;&lt;/code&gt; 定义中的 &lt;code&gt;out&lt;/code&gt; 关键字，&lt;code&gt;addItem&lt;/code&gt; 函数就会报 Type mismatch error:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-error&#34; data-lang=&#34;error&#34;&gt;Type mismatch
Required: Aquarium&amp;lt;WaterSupply&amp;gt;
Found: Aquarium&amp;lt;TapWater&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;define-an-in-type&#34;&gt;Define an in type&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Define a Cleaner interface that takes a generic T that&amp;#39;s constrained to WaterSupply.Since it is only used as an argument to clean(), we can make it an in paramter.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Cleaner&lt;/span&gt;&amp;lt;&lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; T : WaterSupply&amp;gt; {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;clean&lt;/span&gt;(waterSupply: T)
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Create a class TapWaterCleaner that implements Cleaner for cleaning TapWater by adding chemicals
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;TapWaterCleaner&lt;/span&gt; : Cleaner&amp;lt;TapWater&amp;gt; {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;clean&lt;/span&gt;(waterSupply: TapWater) {
    waterSupply.addChemicalCleaners()
  }
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * In the Aquarium class, update addWater() to take a Cleaner of type T, and clean the water before adding it.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Aquarium&lt;/span&gt;&amp;lt;&lt;span style=&#34;color:#66d9ef&#34;&gt;out&lt;/span&gt; T: WaterSupply&amp;gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; waterSupply: T) {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;addWater&lt;/span&gt;(cleaner: Cleaner&amp;lt;T&amp;gt;) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (waterSupply.needsProcessing) {
      cleaner.clean(waterSupply)
    }
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Water added!&amp;#34;&lt;/span&gt;)
  }
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Test function
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;g2&lt;/span&gt;() {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; cleaner = TapWaterCleaner()
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; aquarium = Aquarium(TapWater())
    aquarium.addWater(cleaner)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Kotlin 将使用 in 和 out 类型来确保我们可以安全地使用泛型。out 和 in 的使用场景：out 类型可以作为返回值向外传递，in 类型可以作为参数向内传递。&lt;/p&gt;
&lt;h2 id=&#34;type-erasure-and-generic-type-checks&#34;&gt;Type erasure and generic type checks&lt;/h2&gt;
&lt;p&gt;Java 中泛型只在编译时使用，编译器确保所有类型相关的操作都可以安全的进行。在运行时，泛型类型的实例并不持有实际类型的信息（&lt;a href=&#34;https://kotlinlang.org/docs/reference/typecasts.html#type-erasure-and-generic-type-checks&#34;&gt;类型擦除&lt;/a&gt;），比如 &lt;code&gt;List&amp;lt;Foo&amp;gt;&lt;/code&gt; 会擦除为 &lt;code&gt;List&amp;lt;*&amp;gt;&lt;/code&gt;。通常无法在运行时检查实例是否属于某种泛型类型，不过在 Kotlin 中我们可以通过 &lt;code&gt;inline + reified&lt;/code&gt; 的组合实现运行时类型判断。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Aquarium&lt;/span&gt;&amp;lt;T : WaterSupply&amp;gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; waterSupply: T) {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;addWater&lt;/span&gt;(cleaner: Cleaner&amp;lt;T&amp;gt;) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (waterSupply.needsProcessing) {
      cleaner.clean(waterSupply)
    }
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Water added!&amp;#34;&lt;/span&gt;)
  }

  &lt;span style=&#34;color:#75715e&#34;&gt;/*
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   * Declare the function inline, and make the type reified.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;inline&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &amp;lt;reified R : WaterSupply&amp;gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;isOfType&lt;/span&gt;(): Boolean = waterSupply &lt;span style=&#34;color:#66d9ef&#34;&gt;is&lt;/span&gt; R
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们在 Aquarium 类中添加 &lt;code&gt;isOfType&lt;/code&gt; 方法，通过 &lt;code&gt;inline&lt;/code&gt; 声明方法，将泛型类型标记为 &lt;code&gt;reified&lt;/code&gt;后，&lt;code&gt;is&lt;/code&gt; 关键字可以在运行时做泛型类型检查。&lt;/p&gt;
&lt;h3 id=&#34;make-extension-functions&#34;&gt;Make extension functions&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;inline&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &amp;lt;reified T: WaterSupply&amp;gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Aquarium&lt;/span&gt;&amp;lt;*&amp;gt;.isOfType() = waterSupply &lt;span style=&#34;color:#66d9ef&#34;&gt;is&lt;/span&gt; T
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://kotlinlang.org/docs/reference/generics.html#star-projections&#34;&gt;Star-projections&lt;/a&gt; 很像 Java 编程中的 raw types，不过更加安全。&lt;/p&gt;
&lt;h2 id=&#34;inline-functions&#34;&gt;inline functions&lt;/h2&gt;
&lt;p&gt;Lambdas 和高阶函数都很有用，但我们应该了解一个事实：Lambda 是对象。Lambda 表达式是 &lt;code&gt;Function&lt;/code&gt; 接口的实例，&lt;code&gt;Function&lt;/code&gt; 接口是 &lt;code&gt;Object&lt;/code&gt; 的子类。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * 自定义 with 函数，接收 [name] 字符串，执行 name.block() 函数
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;customWith&lt;/span&gt;(name: String, block: String.() -&amp;gt; Unit) {
  name.block()
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * 调用 customWith 函数，并将 fish.name 首字母大写
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
customWith(fish.name) {
  capitalize()
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上面调用 &lt;code&gt;customWith&lt;/code&gt; 函数实际的实现像这样：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;customWith(fish.name, &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt;: Function1&amp;lt;String, Unit&amp;gt;) {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;invoke&lt;/span&gt;(name: String) {
    name.capitalize()
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;通常这不是问题，因为创建对象和调用函数不会产生太多的开销。不过假如 &lt;code&gt;customWith&lt;/code&gt; 函数在非常多的地方都有调用，那么开销就会多起来。&lt;/p&gt;
&lt;p&gt;Kotlin 提供 &lt;code&gt;inline&lt;/code&gt; 作为处理这种情况的一种方式，通过增加编译器的工作来减少运行时的开销。将函数标记为 &lt;code&gt;inline&lt;/code&gt; 意味着每次调用该函数时，编译器实际上会将源码转换为内联函数。&lt;/p&gt;
&lt;p&gt;比如我们在使用 &lt;code&gt;customWith&lt;/code&gt; 时标记为 &lt;code&gt;inline&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;inline&lt;/span&gt; customWith(fish.name) {
  capitalize()
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;它转换后像这样：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;fish.name.capitalize()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;需要注意的是，内联大型函数会增加代码大小，因此 &lt;code&gt;inline&lt;/code&gt; 适用于多次使用的简单的函数，如 &lt;code&gt;customWith&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&#34;sam&#34;&gt;SAM&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;Single Abstract Method(SAM)&lt;/em&gt; 即表示只有一个方法的接口。在 Java 编写 API 时非常常见，比如 &lt;code&gt;Runnable&lt;/code&gt; 接口，只定义了一个 &lt;code&gt;run()&lt;/code&gt; 方法，&lt;code&gt;Callable&lt;/code&gt; 接口，定义了一个 &lt;code&gt;call()&lt;/code&gt; 方法。&lt;/p&gt;
&lt;p&gt;我们定义个 SAM：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;JavaRun&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;runNow&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Runnable runnable&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    runnable&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;run&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在 Kotlin 中调用该函数：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; runnable = &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt;: Runnable {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;run&lt;/span&gt;() {
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;I&amp;#39;m a Runnable&amp;#34;&lt;/span&gt;)
  }
}

JavaNow.runNow(runnable)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Kotlin 提供的 SAM 机制会提示缩减代码：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;JavaNow.runNow {
  println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Lambda as a Runnable&amp;#34;&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;SAM 的模版像这样：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;Class.singleAbstractMethod {lambda_of_override}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Interface Delegation</title>
      <link>https://zacash.cn/post/interface-delegation/</link>
      <pubDate>Tue, 11 Aug 2020 20:42:28 +0800</pubDate>
      
      <guid>https://zacash.cn/post/interface-delegation/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://codelabs.developers.google.com/codelabs/kotlin-bootcamp-classes/#7&#34;&gt;接口委托（Interface delegation）&lt;/a&gt; 是一种&amp;quot;高级&amp;quot;技术，接口的方法由 helper 或 delegate 对象实现，然后给别的类使用。当我们在一系列不相关的类中使用接口时，这项技术会很有用：我们将需要使用的接口的函数添加到单独的 helper 类中，别的类使用 helper 类的实例来实现这个函数。&lt;/p&gt;
&lt;h2 id=&#34;define-interface&#34;&gt;Define interface&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Define fish action interface.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;FishAction&lt;/span&gt; {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;eat&lt;/span&gt;()
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Define fish color interface.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;FishColor&lt;/span&gt; {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; color: String
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Plecostomus class implement [FishAction] and [FishColor] interface.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Plecostomus&lt;/span&gt;: FishAction, FishColor {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; color = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gold&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;eat&lt;/span&gt;() {
        println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;eat algae&amp;#34;&lt;/span&gt;)
    }
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Shark class implement [FishAction] and [FishColor] interface.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Shark&lt;/span&gt;: FishAction, FishColor {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; color = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gray&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;eat&lt;/span&gt;() {
        println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;eat fish&amp;#34;&lt;/span&gt;)
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;make-a-singleton-class&#34;&gt;Make a singleton class&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Creat a singleton for gold fish color.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;GoldColor&lt;/span&gt;: FishColor {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; color = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gold&amp;#34;&lt;/span&gt;
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Create printing fish action.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;PrintingFishAction&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; food: String): FishAction {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;eat&lt;/span&gt;() {
        println(food)
    }
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Plecostomus use interface delegation mechanism, and all overrides
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * are handled by interface delegation.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Plecostomus&lt;/span&gt;(fishColor: FishColor = GoldColor): FishAction &lt;span style=&#34;color:#66d9ef&#34;&gt;by&lt;/span&gt; PrintingFishAction(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;eat algae&amp;#34;&lt;/span&gt;), FishColor &lt;span style=&#34;color:#66d9ef&#34;&gt;by&lt;/span&gt; fishColor
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;
&lt;p&gt;Interface delegation is powerful, and you should generally consider how to use it whenever you might use an abstract class in another language. It lets you use composition to plug in behaviors, instead of requiring lots of subclasses, each specialized in a different way.&lt;/p&gt;
&lt;p&gt;接口委托很有用，通常每当我们在使用另一种语言的抽象类时都应该考虑使用它。它使我们可以使用组合来插入 behavior，而不是需要大量各有特色的子类。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Introducing Indigo</title>
      <link>https://zacash.cn/post/introducing-indigo/</link>
      <pubDate>Mon, 10 Aug 2020 09:00:00 -0400</pubDate>
      
      <guid>https://zacash.cn/post/introducing-indigo/</guid>
      <description>&lt;p&gt;Indigo is a lightweight theme for &lt;a href=&#34;https://gohugo.io&#34;&gt;Hugo&lt;/a&gt; with &lt;a href=&#34;https://indieweb.org&#34;&gt;IndieWeb&lt;/a&gt; features baked in. It&amp;rsquo;s great for longer-form blogging, placing its focus on distraction-free reading and beautiful typefaces.&lt;/p&gt;
&lt;h2 id=&#34;indieweb-features&#34;&gt;IndieWeb features&lt;/h2&gt;
&lt;p&gt;A key feature of this theme is its support for IndieWeb features, including microformats and web sign-in.&lt;/p&gt;
&lt;h3 id=&#34;web-sign-in&#34;&gt;Web sign-in&lt;/h3&gt;
&lt;p&gt;Indigo handles web sign-in by setting the &lt;code&gt;authorization_endpoint&lt;/code&gt; to &lt;a href=&#34;https://indieauth.com&#34;&gt;IndieAuth.com&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;IndieAuth.com is part of the &lt;a href=&#34;https://indieweb.org/why&#34;&gt;IndieWeb movement&lt;/a&gt; to take back control of your online identity. Instead of logging in to websites as &amp;ldquo;you on Twitter&amp;rdquo; or &amp;ldquo;you on Facebook&amp;rdquo;, &lt;strong&gt;you should be able to log in as just &amp;ldquo;you&amp;rdquo;&lt;/strong&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This allows you to sign in to certain services simply by providing your site&amp;rsquo;s domain name.&lt;/p&gt;
&lt;h3 id=&#34;microformats&#34;&gt;microformats&lt;/h3&gt;
&lt;p&gt;Indigo marks up content with appropriate &lt;a href=&#34;http://microformats.org&#34;&gt;microformats&lt;/a&gt;, which provides semantic definitions of your content to other software. Posts are marked up with &lt;code&gt;h-entry&lt;/code&gt; classes, like &lt;code&gt;p-name&lt;/code&gt;, &lt;code&gt;p-author&lt;/code&gt;, and &lt;code&gt;e-content&lt;/code&gt;, while the author bio is marked up with &lt;code&gt;h-card&lt;/code&gt; classes, including &lt;code&gt;u-photo&lt;/code&gt;, &lt;code&gt;u-url&lt;/code&gt;, &lt;code&gt;p-locality&lt;/code&gt;/&lt;code&gt;p-country-name&lt;/code&gt;, and &lt;code&gt;p-note&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;open-typefaces&#34;&gt;Open typefaces&lt;/h2&gt;
&lt;p&gt;Indigo uses a combination of three beautiful typefaces to render your words.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://bboxtype.com/typefaces/FiraSans/#!layout=specimen&#34;&gt;Fira Sans&lt;/a&gt; for heading text&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://practicaltypography.com/charter.html&#34;&gt;Charter&lt;/a&gt; for body text&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/tonsky/FiraCode&#34;&gt;Fira Code&lt;/a&gt; for monospaced text&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Licenses are included in the theme’s &lt;code&gt;static/fonts&lt;/code&gt; folder.&lt;/p&gt;
&lt;p&gt;Have a look at a couple of paragraphs of placeholder text using the wonderfully readable Charter:&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer eleifend nulla ac elit venenatis posuere. Sed id aliquam arcu, et malesuada lectus. &lt;strong&gt;Donec et dignissim massa. Pellentesque in laoreet nibh. Pellentesque sagittis, libero quis vestibulum aliquam, ante risus imperdiet magna, at ornare dolor libero quis nunc.&lt;/strong&gt; Donec quis tempus purus. Cras ornare magna ac facilisis tristique. Nulla aliquet purus quis massa rutrum interdum ac at magna. Cras fermentum magna id orci viverra facilisis. Ut vitae lobortis nisl.&lt;/p&gt;
&lt;p&gt;Sed interdum tincidunt venenatis. Sed hendrerit dictum nisi, at dignissim orci consectetur quis. Aenean sed nisl et nisl placerat euismod. Proin hendrerit nulla at rhoncus molestie. Cras eu gravida erat, vestibulum ornare diam. &lt;em&gt;Praesent nunc arcu, ultrices et risus sed, dictum mattis dui. Maecenas vitae nisl at massa porta pellentesque&lt;/em&gt;. Donec eget urna eget nisl imperdiet scelerisque eget a mauris. Nam fringilla sem id vehicula rhoncus. Curabitur tincidunt massa mauris, facilisis placerat odio eleifend sit amet. Etiam nec vehicula sapien, at dignissim risus. Sed elit erat, lacinia eu vulputate at, semper eu nulla. Quisque a urna sed nulla viverra egestas nec quis nunc. Curabitur iaculis elit in orci sollicitudin suscipit.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;And code snippets look great with Fira Code:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;article&amp;gt;
    &amp;lt;header&amp;gt;
    {{ if .Title }}
    &amp;lt;h2 class=&amp;quot;list-title&amp;quot;&amp;gt;&amp;lt;a href=&amp;quot;{{ .Permalink }}&amp;quot;&amp;gt;{{ .Title }}&amp;lt;/a&amp;gt;&amp;lt;/h2&amp;gt;
    {{ end }}
    &amp;lt;p class=&amp;quot;list-post-date&amp;quot;&amp;gt;
        &amp;lt;time datetime=&amp;quot;{{ .Date.Format &amp;quot;2006-01-02T15:04:05Z07:00&amp;quot; | safeHTML }}&amp;quot;&amp;gt;
        {{ .PublishDate.Format &amp;quot;2 January, 2006 at 15:04 MST&amp;quot; }}
        &amp;lt;/time&amp;gt;
    &amp;lt;/p&amp;gt;
    &amp;lt;/header&amp;gt;
    &amp;lt;div&amp;gt;
    {{ .Summary | plainify | safeHTML }}
    &amp;lt;/div&amp;gt;
    {{ if .Truncated }}
    &amp;lt;p&amp;gt;&amp;lt;a class=&amp;quot;read-more&amp;quot; href=&amp;quot;{{ .Permalink }}&amp;quot;&amp;gt;Read more &amp;amp;rarr;&amp;lt;/a&amp;gt;&amp;lt;/p&amp;gt;
    {{ end }}
&amp;lt;/article&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;contributions-welcome&#34;&gt;Contributions welcome&lt;/h2&gt;
&lt;p&gt;Indigo is distributed under the &lt;a href=&#34;https://github.com/AngeloStavrow/indigo/blob/master/LICENSE.md&#34;&gt;MIT license&lt;/a&gt;, so feel free to fork the repository and make it your own! If you&amp;rsquo;ve got ideas on how to improve the theme, let me know by &lt;a href=&#34;issue&#34;&gt;opening an issue in GitHub&lt;/a&gt; — but please be sure to review the documentation on &lt;a href=&#34;https://github.com/AngeloStavrow/indigo/blob/master/CONTRIBUTING.md&#34;&gt;contributing&lt;/a&gt;.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Lambdas and High-order Functions</title>
      <link>https://zacash.cn/post/lambdas-and-high-order-functions/</link>
      <pubDate>Sun, 09 Aug 2020 00:00:00 +0000</pubDate>
      
      <guid>https://zacash.cn/post/lambdas-and-high-order-functions/</guid>
      <description>&lt;p&gt;除了传统命名的函数外，Kotlin 还支持 &lt;a href=&#34;https://kotlinlang.org/docs/reference/lambdas.html&#34;&gt;lambdas&lt;/a&gt;. &lt;em&gt;lambda&lt;/em&gt; 是组成函数的表达式，一个没有名称的函数。lambda 表达式可以作为数据传递。在其他语言中，lambda 被称为 &lt;em&gt;匿名函数（anonymous function）&lt;/em&gt;，&lt;em&gt;函数字面量（function literals）&lt;/em&gt; 或类似名称。&lt;/p&gt;
&lt;h3 id=&#34;high-order-functions&#34;&gt;High-order functions&lt;/h3&gt;
&lt;p&gt;我们可以通过传递 lambda 到另一个函数，来创建 &lt;em&gt;高阶函数（high-order function）&lt;/em&gt;。&lt;code&gt;map&lt;/code&gt; 是一个高阶函数，你传入的 lambda 表达式是需要 &lt;em&gt;应用的转换（transformation to apply）&lt;/em&gt;。&lt;/p&gt;
&lt;h3 id=&#34;create-lambdas&#34;&gt;Create lambdas&lt;/h3&gt;
&lt;p&gt;与命名函数一样，lambda 也可以有入参。例如：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; waterFilter = { dirty: Int -&amp;gt; dirty / &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;位于 &lt;code&gt;-&amp;gt;&lt;/code&gt; 左侧的为入参及入参类型，&lt;code&gt;-&amp;gt;&lt;/code&gt; 右侧即为需要执行的代码。将 lambda 表达式赋值给变量后，我们就可以像函数一样调用它。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;println(waterFilter(&lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;))

&lt;span style=&#34;color:#75715e&#34;&gt;// print =&amp;gt; 10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Kotlin 的函数语法与 lambdas 语法紧密相关，我们可以使用这种语法明确声明一个包含函数的变量：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; waterFilter: (Int) -&amp;gt; Int = {dirty -&amp;gt; dirty / &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;create-high-order-function&#34;&gt;Create high-order function&lt;/h3&gt;
&lt;p&gt;我们可以使用 lambdas 来创建高阶函数，即函数的入参是另一个函数：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;updateDirty&lt;/span&gt;(dirty: Int, operation: (Int) -&amp;gt; Int): Int {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; operation(dirty)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们创建了一个 &lt;code&gt;updateDirty&lt;/code&gt; 函数，这个函数的第二个参数是另一个函数 &lt;code&gt;operation&lt;/code&gt;，&lt;code&gt;operation&lt;/code&gt; 函数接收一个 &lt;code&gt;Int&lt;/code&gt; 类型的入参并返回 &lt;code&gt;Int&lt;/code&gt;类型的值。函数体将第一个参数作为入参，调用了传入的函数。&lt;/p&gt;
&lt;p&gt;对于 &lt;code&gt;updateDirty&lt;/code&gt; 函数的使用，我们可以 a).创建一个 lambda 传入，如：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; waterFilter: (Int) -&amp;gt; Int = {dirty -&amp;gt; dirty / &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
println(updateDirty(&lt;span style=&#34;color:#ae81ff&#34;&gt;20.&lt;/span&gt; waterFilter))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;除了创建 lambda 外，我们还可以 b).传入常规的命名函数，只是与直接 lambda 变量不同，我们需要使用 &lt;code&gt;::&lt;/code&gt; 操作符来传入命名函数的引用。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;waterFilter&lt;/span&gt;(dirty: Int): Int = dirty / &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
println(updateDirty(&lt;span style=&#34;color:#ae81ff&#34;&gt;40&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;waterFilter))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这种单行的函数也称为 &lt;em&gt;compat functions&lt;/em&gt; 或 &lt;em&gt;single-expression functions&lt;/em&gt;，可以增加代码可读性。&lt;/p&gt;
&lt;h3 id=&#34;last-parameter-call-syntax&#34;&gt;Last parameter call syntax&lt;/h3&gt;
&lt;p&gt;Kotlin 倾向于将带有函数的任意参数作为最后一个入参。在使用高阶函数时，Kotlin 有一种特殊的语法，称为 &lt;a href=&#34;https://kotlinlang.org/docs/reference/lambdas.html#passing-a-lambda-to-the-last-parameter&#34;&gt;last parameter call syntax&lt;/a&gt; 可以使代码更加简洁。这种情况下，我们可以传入一个 lambda 而无需放入括号内：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; dirty = &lt;span style=&#34;color:#ae81ff&#34;&gt;60&lt;/span&gt;
dirty = updateDirty(dirty) { dirty -&amp;gt; dirty / &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; }
println(dirty)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Threads and Locks</title>
      <link>https://zacash.cn/post/threads-and-locks/</link>
      <pubDate>Mon, 27 Jul 2020 00:00:00 +0000</pubDate>
      
      <guid>https://zacash.cn/post/threads-and-locks/</guid>
      <description>&lt;p&gt;Threads are created and managed by the classes Thread and ThreadGroup. Creating a Thread object creates a thread, and that is the only way to create a thread. When the thread is created, it is not yet active; it begins to run when its start method is called.&lt;/p&gt;
&lt;h2 id=&#34;813-locks-and-synchronization&#34;&gt;8.13 Locks and Synchronization&lt;/h2&gt;
&lt;p&gt;There is a lock associated with every object. The Java programming language does not provide a way to perform separate lock and unlock operations; instead, they are implicitly performed by high-level constructs that always arrange to pair such operations correctly. (The Java virtual machine, however, provides separate monitorenter and monitorexit instructions that implement the lock and unlock operations.)&lt;/p&gt;
&lt;p&gt;每个对象都有一个锁。Java 没有单独提供锁定和解锁的方法；相反它们由始终安排准确配对操作的高阶构造隐式执行。Jvm 提供了单独的 &lt;em&gt;monitorenter&lt;/em&gt; 和 &lt;em&gt;monitorexit&lt;/em&gt; 指令，用于实现锁定和解锁操作。&lt;/p&gt;
&lt;p&gt;The synchronized statement computes a reference to an object; it then attempts to perform a lock operation on that object and does not proceed further until the lock operation has successfully completed. (A lock operation may be delayed because the rules about locks can prevent the main memory from participating until some other thread is ready to perform one or more unlock operations.) After the lock operation has been performed, the body of the synchronized statement is executed. Normally, a compiler for the Java programming language ensures that the lock operation implemented by a monitorenter instruction executed prior to the execution of the body of the synchronized statement is matched by an unlock operation implemented by a monitorexit instruction whenever the synchronized statement completes, whether completion is normal or abrupt.&lt;/p&gt;
&lt;p&gt;同步语句计算对象的引用，它尝试对该对象执行锁定操作，并且在锁定操作完成前不会进一步的操作。（锁定操作可能延迟，因为有关锁定的规则可能阻止主内存参与，直到线程准备一个或多个解锁操作为止。）指定锁定操作后，将执行同步语句的主体。通常，Java 编译器可以确保，由 &lt;em&gt;monitorenter&lt;/em&gt; 指令（在执行同步语句的主体之前执行）实现的锁定操作和由 &lt;em&gt;monitorexit&lt;/em&gt; 指令实现的解锁操作相匹配，而不管同步语句是否执行完成或打断。&lt;/p&gt;
&lt;p&gt;A synchronized method automatically performs a lock operation when it is invoked; its body is not executed until the lock operation has successfully completed. If the method is an instance method, it locks the lock associated with the instance for which it was invoked (that is, the object that will be known as this during execution of the method&amp;rsquo;s body). If the method is static, it locks the lock associated with the Class object that represents the class in which the method is defined. If execution of the method&amp;rsquo;s body is ever completed, either normally or abruptly, an unlock operation is automatically performed on that same lock.&lt;/p&gt;
&lt;p&gt;同步方法在被调用时会自动执行锁定操作。在锁定操作完成前不会执行方法主体。如果该方法是实例方法，则它将与调用该方法的实例锁定。如果该方法是静态的，则它将与定义该方法的 Class 对象相关联的类锁定。如果方法主体正常执行或突然中断，则与该锁配对解锁操作将自动执行。&lt;/p&gt;
&lt;p&gt;Best practice is that if a variable is ever to be assigned by one thread and used or assigned by another, then all accesses to that variable should be enclosed in synchronized methods or synchronized statements.&lt;/p&gt;
&lt;p&gt;最佳实践是对于某个变量由一个线程 &lt;em&gt;assign&lt;/em&gt; 并由另一个线程 &lt;em&gt;use&lt;/em&gt; 或 &lt;em&gt;assign&lt;/em&gt;，则对该变量的所有访问都应该放在 &lt;em&gt;synchronized&lt;/em&gt; 方法或 &lt;em&gt;synchronized&lt;/em&gt; 语句中。&lt;/p&gt;
&lt;p&gt;Although a compiler for the Java programming language normally guarantees structured use of locks (see Section 7.14, &amp;ldquo;Synchronization&amp;rdquo;), there is no assurance that all code submitted to the Java virtual machine will obey this property. Implementations of the Java virtual machine are permitted but not required to enforce both of the following two rules guaranteeing structured locking.&lt;/p&gt;
&lt;p&gt;Let T be a thread and L be a lock. Then:&lt;/p&gt;
&lt;p&gt;The number of lock operations performed by T on L during a method invocation must equal the number of unlock operations performed by T on L during the method invocation whether the method invocation completes normally or abruptly.&lt;/p&gt;
&lt;p&gt;At no point during a method invocation may the number of unlock operations performed by T on L since the method invocation exceed the number of lock operations performed by T on L since the method invocation.
In less formal terms, during a method invocation every unlock operation on L must match some preceding lock operation on L.
Note that the locking and unlocking automatically performed by the Java virtual machine when invoking a synchronized method are considered to occur during the calling method&amp;rsquo;s invocation.&lt;/p&gt;
&lt;h2 id=&#34;714-synchronizationsynchronized&#34;&gt;7.14 &lt;a href=&#34;https://docs.oracle.com/javase/specs/jvms/se6/html/Compiling.doc.html#6530&#34;&gt;Synchronization&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The Java virtual machine provides explicit support for synchronization through its monitorenter and monitorexit instructions. For code written in the Java programming language, however, perhaps the most common form of synchronization is the synchronized method.&lt;/p&gt;
&lt;p&gt;Jvm 通过 &lt;em&gt;monitorenter&lt;/em&gt; 和 &lt;em&gt;monitorexit&lt;/em&gt; 指令为同步操作提供支持。但对于 Java 编写的代码，最常见的同步形式可能是 &lt;em&gt;synchronized&lt;/em&gt; 方法。&lt;/p&gt;
&lt;p&gt;A synchronized method is not normally implemented using monitorenter and monitorexit. Rather, it is simply distinguished in the runtime constant pool by the ACC_SYNCHRONIZED flag, which is checked by the method invocation instructions. When invoking a method for which ACC_SYNCHRONIZED is set, the current thread acquires a monitor, invokes the method itself, and releases the monitor whether the method invocation completes normally or abruptly. During the time the executing thread owns the monitor, no other thread may acquire it. If an exception is thrown during invocation of the synchronized method and the synchronized method does not handle the exception, the monitor for the method is automatically released before the exception is rethrown out of the synchronized method.&lt;/p&gt;
&lt;p&gt;Jvm 通常不使用 &lt;em&gt;monitorenter&lt;/em&gt; 和 &lt;em&gt;monitorexit&lt;/em&gt; 实现同步方法，而是在运行时常量池通过 &lt;em&gt;ACC_SYNCHRONIZED&lt;/em&gt; 标记加以区分，该标记由方法调用指令校验。当调用标记为 &lt;em&gt;ACC_SYNCHRONIZED&lt;/em&gt; 的方法时，当前线程获取 monitor，调用这个方法自身，并释放 monitor，不管方法调用是正常完成或突然中断。&lt;/p&gt;
&lt;p&gt;正在执行的线程拥有 monitor 时，别的线程无法获取它。如果在调用同步方法时抛出异常，且同步方法无法处理该异常，则在异常从同步方法抛出执行，自动释放该方法的 monitor.&lt;/p&gt;
&lt;p&gt;The &lt;em&gt;monitorenter&lt;/em&gt; and &lt;em&gt;monitorexit&lt;/em&gt; instructions exist to support synchronized statements. For example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onlyMe&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Foo f&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;synchronized&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;f&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        doSomething&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;is compiled to&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-assembly&#34; data-lang=&#34;assembly&#34;&gt;Method void onlyMe(Foo)
   0 	aload_1				// Push f	
   1 	astore_2			// Store it in local variable 2
   2 	aload_2				// Push local variable 2 (f)
   3 	monitorenter		// Enter the monitor associated with f
   4 	aload_0				// Holding the monitor, pass this and...
   5 	invokevirtual #5 	// ...call Example.doSomething()V
   8	aload_2				// Push local variable 2 (f)
   9	monitorexit			// Exit the monitor associated with f
  10	return				// Return normally
  11 	aload_2				// In case of any throw, end up here
  12 	monitorexit			// Be sure to exit monitor...
  13 	athrow				// ...then rethrow the value to the invoker
Exception table:
   	From	To 	Target 		Type
    4     	8   11   		any
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;volatile&#34;&gt;Volatile&lt;/h2&gt;
&lt;p&gt;The rules for volatile variables effectively require that main memory be touched exactly once for each use or assign of a volatile variable by a thread, and that main memory be touched in exactly the order dictated by the thread execution semantics. However, such memory operations are not ordered with respect to read and write operations on nonvolatile variables.&lt;/p&gt;
&lt;h2 id=&#34;thread-pool&#34;&gt;Thread Pool&lt;/h2&gt;
&lt;p&gt;Most of the executor implementations in &lt;em&gt;java.util.concurrent&lt;/em&gt; use thread pools, which consist of &lt;em&gt;worker threads&lt;/em&gt;. This kind of thread exists separately from the &lt;em&gt;Runnable&lt;/em&gt; and &lt;em&gt;Callable&lt;/em&gt; tasks it executes and is often used to execute multiple tasks.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;java.util.concurrent&lt;/em&gt; 包中大部分 executor 实现都使用线程池，这些线程池由 &lt;em&gt;work threads&lt;/em&gt; 组成。这些线程与它执行的 &lt;em&gt;Runnable&lt;/em&gt; 和 &lt;em&gt;Callable&lt;/em&gt; 任务分开，通常用于执行多个任务。&lt;/p&gt;
&lt;p&gt;Using &lt;em&gt;worker threads&lt;/em&gt; minimizes the overhead due to thread creation. Thread objects use a significant amount of memory, and in a large-scale application, allocating and deallocating many thread objects creates a significant memory management overhead.&lt;/p&gt;
&lt;p&gt;使用 &lt;em&gt;worker threads&lt;/em&gt; 可以最大限度减少线程创建所带来的开销。线程对象占用大量内存，并且在大规模 App 中，分配和取消分配许多线程会产生大量内存管理的开销。&lt;/p&gt;
&lt;p&gt;One common type of thread pool is the &lt;em&gt;fixed thread pool&lt;/em&gt;. This type of pool always has a specified number of threads running; if a thread is somehow terminated while it is still in use, it is automatically replaced with a new thread. Tasks are submitted to the pool via an &lt;em&gt;internal queue&lt;/em&gt;, which holds extra tasks whenever there are more active tasks than threads.&lt;/p&gt;
&lt;p&gt;线程池的一种常见类型是 &lt;em&gt;fixed thread pool&lt;/em&gt;。这种类型的线程池始终有指定数量的线程在运行；如果一个线程在使用时被某种方式突然终止，则线程池会自动创建新的线程替换终止的线程。任务通过内部队列提交到线程池中，&lt;em&gt;该内部队列在活动任务多于线程数时容纳额外的任务。&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;An important advantage of the fixed thread pool is that applications using it degrade gracefully. To understand this, consider a web server application where each HTTP request is handled by a separate thread. If the application simply creates a new thread for every new HTTP request, and the system receives more requests than it can handle immediately, the application will suddenly stop responding to all requests when the overhead of all those threads exceed the capacity of the system. With a limit on the number of the threads that can be created, the application will not be servicing HTTP requests as quickly as they come in, but it will be servicing them as quickly as the system can sustain.&lt;/p&gt;
&lt;p&gt;固定线程池的一个重要优势是使用该线程池的 App 可以正常降级。考虑一个 Web 服务应用，每个 HTTP 请求均由单独的线程处理。如果该应用仅简单针对每个 HTTP 请求创建新的线程，
并且系统收到的请求超出了其立即处理的数量，当这些线程的所有开销超出系统的容量时，应用会突然停止响应所有请求。由于可以创建的线程数量受到限制，因此应用可以不尽快的处理 HTTP 请求，但
可以根据系统能力尽快服务这些请求。&lt;/p&gt;
&lt;p&gt;A simple way to create an executor that uses a fixed thread pool is to invoke the &lt;a href=&#34;https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Executors.html#newFixedThreadPool-int-&#34;&gt;newFixedThreadPool&lt;/a&gt; factory method in &lt;em&gt;java.util.concurrent.Executors&lt;/em&gt; This class also provides the following factory methods:&lt;/p&gt;
&lt;p&gt;调用 &lt;em&gt;java.util.concurrent.Executors&lt;/em&gt; 中的 newFixedThreadPool 工厂方法可以创建固定线程池的 executor。此类还提供如下工厂方法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href=&#34;https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Executors.html#newCachedThreadPool-int-&#34;&gt;newCachedThreadPool&lt;/a&gt; method creates an executor with an expandable thread pool. This executor is suitable for applications that launch many short-lived tasks.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;newCachedThreadPool&lt;/em&gt; 使用可扩展的线程池创建 executor。此类线程池适用于启动许多短期任务的应用程序。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href=&#34;https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Executors.html#newSingleThreadExecutor-int-&#34;&gt;newSingleThreadExecutor&lt;/a&gt; method creates an executor that executes a single task at a time.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;newSingleThreadExecutor&lt;/em&gt; 创建的 executor 每次只执行一个任务。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Several factory methods are &lt;em&gt;ScheduledExecutorService&lt;/em&gt; versions of the above executors.&lt;/p&gt;
&lt;p&gt;上述 executor 的 &lt;em&gt;ScheduledExecutorService&lt;/em&gt; 版本有几种工厂方法。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If none of the executors provided by the above factory methods meet your needs, constructing instances of &lt;em&gt;java.util.concurrent.ThreadPoolExecutor&lt;/em&gt; or &lt;em&gt;java.util.concurrent.ScheduledThreadPoolExecutor&lt;/em&gt; will give you additional options.&lt;/p&gt;
&lt;p&gt;除了上面这些创建 executor 的方法，&lt;em&gt;java.util.concurrent.ThreadPoolExecutor&lt;/em&gt; 和 &lt;em&gt;java.util.concurrent.ScheduledThreadPoolExecutor&lt;/em&gt; 也会提供额外的方法。&lt;/p&gt;
&lt;h2 id=&#34;processes-and-threads&#34;&gt;Processes and Threads&lt;/h2&gt;
&lt;p&gt;In concurrent programming, there are two basic units of execution: &lt;em&gt;processes&lt;/em&gt; and &lt;em&gt;threads&lt;/em&gt;. In the Java programming language, concurrent programming is mostly concerned with threads. However, processes are also important.&lt;/p&gt;
&lt;p&gt;在并发编程中，有两个基本的执行单元：进程和线程。Java 并发编程主要和线程有关，不过进程也很重要。&lt;/p&gt;
&lt;p&gt;A computer system normally has many active processes and threads. This is true even in systems that only have a single execution core, and thus only have one thread actually executing at any given moment. Processing time for a single core is shared among processes and threads through an OS feature called &lt;em&gt;time slicing&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;计算机系统通常有很多活跃的进程和线程。这在只有一个执行核心以至于任何时刻都只有一个线程实际执行的系统也是如此。通过称为 &lt;em&gt;时间分片&lt;/em&gt; 的 OS 功能，进程和线程可以共享单个内核的处理时间。&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s becoming more and more common for computer systems to have multiple processors or processors with multiple execution cores. This greatly enhances a system&amp;rsquo;s capacity for concurrent execution of processes and threads — but concurrency is possible even on simple systems, without multiple processors or execution cores.&lt;/p&gt;
&lt;p&gt;具有多个处理器或多个执行核心的处理器的计算机系统正在变得越来越普遍。这极大增强了并发执行多进程和多线程的能力——即使是在没有多核处理器的简单系统上，并发也是可能的。&lt;/p&gt;
&lt;h3 id=&#34;processes&#34;&gt;Processes&lt;/h3&gt;
&lt;p&gt;A process has a self-contained execution environment. A process generally has a complete, private set of basic run-time resources; in particular, each process has its own memory space.&lt;/p&gt;
&lt;p&gt;进程具有独立的执行环境。进程通常具有一组完整的、私有的基本运行时资源，每个进程有自己的内存空间。&lt;/p&gt;
&lt;p&gt;Processes are often seen as synonymous with programs or applications. However, what the user sees as a single application may in fact be a set of cooperating processes. To facilitate communication between processes, most operating systems support &lt;em&gt;Inter Process Communication&lt;/em&gt; (IPC) resources, such as pipes and sockets. IPC is used not just for communication between processes on the same system, but processes on different systems.&lt;/p&gt;
&lt;p&gt;进程通常被视为程序或应用的代名词。但实际上用户看见的单个应用可能一组协作进程。为了促进进程间的通信，大多数操作系统都支持 &lt;em&gt;进程间通信&lt;/em&gt;（IPC）资源，比如管道（pipes）和sockets. IPC 不仅可以用在同一系统的进程间通信，还可用于不同系统上的进程。&lt;/p&gt;
&lt;p&gt;Most implementations of the Java virtual machine run as a single process. A Java application can create additional processes using a &lt;a href=&#34;https://docs.oracle.com/javase/8/docs/api/java/lang/ProcessBuilder.html&#34;&gt;ProcessBuilder&lt;/a&gt; object. Multiprocess applications are beyond the scope of this lesson.&lt;/p&gt;
&lt;p&gt;大多数的 Jvm 实现都是以单个进程运行的。Java 应用可以使用 &lt;a href=&#34;https://docs.oracle.com/javase/8/docs/api/java/lang/ProcessBuilder.html&#34;&gt;ProcessBuilder&lt;/a&gt; 创建新的进程，不过多进程应用不在这里的讨论范围。&lt;/p&gt;
&lt;h3 id=&#34;threads&#34;&gt;Threads&lt;/h3&gt;
&lt;p&gt;Threads are sometimes called &lt;em&gt;lightweight processes&lt;/em&gt;. Both processes and threads provide an execution environment, but creating a new thread requires fewer resources than creating a new process.&lt;/p&gt;
&lt;p&gt;线程通常被称为 &lt;em&gt;轻量级进程&lt;/em&gt;。进程和线程都可以提供执行环境，但创建线程要比创建进程需要更少的资源。&lt;/p&gt;
&lt;p&gt;Threads exist within a process — every process has at least one. Threads share the process&amp;rsquo;s resources, including memory and open files. This makes for efficient, but potentially problematic, communication.&lt;/p&gt;
&lt;p&gt;线程存在于进程中 —— 每个进程至少有一个。线程分享进程资源，包括内存和打开的文件。这样可以进行高效的、但同时又可能有问题的通信。&lt;/p&gt;
&lt;p&gt;Multithreaded execution is an essential feature of the Java platform. Every application has at least one thread — or several, if you count &amp;ldquo;system&amp;rdquo; threads that do things like memory management and signal handling. But from the application programmer&amp;rsquo;s point of view, you start with just one thread, called the main thread. This thread has the ability to create additional threads, as we&amp;rsquo;ll demonstrate in the next section.&lt;/p&gt;
&lt;p&gt;多线程执行是 Java 平台基础的功能。每个应用至少有一个 —— 如果算上执行内存管理和信号处理的系统线程，则有多个。但从应用程序员的角度来看，我们从一个线程开始，称为&lt;em&gt;主线程（main thread）&lt;/em&gt;，这个线程有能力创建别的线程。&lt;/p&gt;
&lt;h4 id=&#34;thread-objects&#34;&gt;Thread Objects&lt;/h4&gt;
&lt;p&gt;每个线程都与一个 &lt;a href=&#34;https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html&#34;&gt;Thread&lt;/a&gt; 相关。有两种策略使用 &lt;em&gt;Thread&lt;/em&gt; 对象创建并发应用。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;直接控制线程的创建和管理，每次应用需要启动异步任务时，只需实例化 &lt;em&gt;Thread&lt;/em&gt;。&lt;/li&gt;
&lt;li&gt;要从应用的其他部分抽象线程管理，将应用的任务传递给 &lt;em&gt;executor&lt;/em&gt;。&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>WebSocket 和长轮询</title>
      <link>https://zacash.cn/post/websocket-and-long-polling/</link>
      <pubDate>Tue, 21 Jul 2020 00:00:00 +0000</pubDate>
      
      <guid>https://zacash.cn/post/websocket-and-long-polling/</guid>
      <description>&lt;p&gt;客户端的网络请求大部分都建立在请求/响应模式的 HTTP/HTTPS 协议之下，AJAX 技术使页面看起来更加动态。尽管如此，所有的 HTTP 连接仍由客户端控制，需要用户交互或定时轮询（periodic polling）才能从服务端加载新数据。&lt;/p&gt;
&lt;p&gt;通过长轮询，客户端打开与服务端的 HTTP 连接，并保持连接直到服务端返回响应，只要服务端有新的数据，它就会发送响应。然而这些技术有共同的问题：它们带有 HTTP 的开销，并不适合低延时应用的需求。&lt;/p&gt;
&lt;h2 id=&#34;websocket-简介&#34;&gt;WebSocket 简介&lt;/h2&gt;
&lt;p&gt;WebSocket 规范定义了一个 API：在客户端和服务端之间建立 &lt;em&gt;socket&lt;/em&gt; 连接。简而言之，客户端和服务端之间建立持久连接，双方都可以随时发送数据。&lt;/p&gt;
&lt;h2 id=&#34;使用-okhttp-实现-websocket&#34;&gt;使用 OkHttp 实现 WebSocket&lt;/h2&gt;
&lt;h3 id=&#34;添加依赖&#34;&gt;添加依赖&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-groovy&#34; data-lang=&#34;groovy&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// network
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;implementation&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;com.squareup.okhttp3:okhttp:4.8.0&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
implementation&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;com.squareup.okhttp3:mockwebserver:4.8.0&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;客户端创建-websocket-连接&#34;&gt;客户端创建 WebSocket 连接&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * 连接 WebSocket 服务
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; *
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * @param hostname 服务端域名地址
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * @param port WebSocket 服务端口号
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;connectWebSocket&lt;/span&gt;(hostname: String,port: Int) {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; httpClient = OkHttpClient.Builder()
      .pingInterval(PING_INTERVAL, TimeUnit.SECONDS)
      .build()

  &lt;span style=&#34;color:#75715e&#34;&gt;// Android 9 已禁止明文传输网络数据，此处使用 ws，可以参考：https://stackoverflow.com/a/50834600
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; url = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ws://${hostname}:${port}&amp;#34;&lt;/span&gt;
  Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;connectWebSocket&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;connect url -&amp;gt; $url&amp;#34;&lt;/span&gt;)

  &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; request = Request.Builder()
      .url(url)
      .build()

  httpClient.newWebSocket(request, &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;: &lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;WebSocketListener&lt;/span&gt;() {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onOpen&lt;/span&gt;(
      webSocket: WebSocket,
      response: Response
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onOpen(webSocket, response)
      Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onOpen&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;response -&amp;gt; ${response.message}&amp;#34;&lt;/span&gt;)
      &lt;span style=&#34;color:#75715e&#34;&gt;// While web socket is opened create our interval work
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;      createIntervalWork(webSocket)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onMessage&lt;/span&gt;(
      webSocket: WebSocket,
      text: String
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onMessage(webSocket, text)
      Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onMessage&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;text -&amp;gt; $text&amp;#34;&lt;/span&gt;)
      &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (text.isNotEmpty()) {
        mHandler.post {
          mAdapter.addMessage(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;pong -&amp;gt; $text&amp;#34;&lt;/span&gt;)
        }
      }
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onMessage&lt;/span&gt;(
      webSocket: WebSocket,
      bytes: ByteString
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onMessage(webSocket, bytes)
      Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onMessage&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;bytes -&amp;gt; $bytes&amp;#34;&lt;/span&gt;)
      mHandler.post {
        mAdapter.addMessage(bytes.toString())
      }
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClosed&lt;/span&gt;(
      webSocket: WebSocket,
      code: Int,
      reason: String
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onClosed(webSocket, code, reason)
      Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onClosed&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;reason -&amp;gt; $reason&amp;#34;&lt;/span&gt;)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClosing&lt;/span&gt;(
      webSocket: WebSocket,
      code: Int,
      reason: String
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onClosing(webSocket, code, reason)
      Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onClosing&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;reason -&amp;gt; $reason&amp;#34;&lt;/span&gt;)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onFailure&lt;/span&gt;(
      webSocket: WebSocket,
      t: Throwable,
      response: Response?
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onFailure(webSocket, t, response)
      Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onFailure&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;${t.message}&amp;#34;&lt;/span&gt;)
    }
  })
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;客户端-mock-websocket-服务&#34;&gt;客户端 Mock WebSocket 服务&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Mock websocket server
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;mockWebServer&lt;/span&gt;(): MockWebServer? {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mockWebServer: MockWebServer? = MockWebServer()

  mockWebServer&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;enqueue(MockResponse().withWebSocketUpgrade(&lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;: &lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;WebSocketListener&lt;/span&gt;() {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onOpen&lt;/span&gt;(
      webSocket: WebSocket,
      response: Response
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onOpen(webSocket, response)
      Logger.i(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;MockWebServer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onOpen&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;response -&amp;gt; ${response.message}&amp;#34;&lt;/span&gt;)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onMessage&lt;/span&gt;(
      webSocket: WebSocket,
      text: String
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onMessage(webSocket, text)
      Logger.i(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;MockWebServer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onMessage&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;text -&amp;gt; $text&amp;#34;&lt;/span&gt;)
      &lt;span style=&#34;color:#75715e&#34;&gt;// send back message to client
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;      webSocket.send(text)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onMessage&lt;/span&gt;(
      webSocket: WebSocket,
      bytes: ByteString
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onMessage(webSocket, bytes)
      Logger.i(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;MockWebServer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onMessage&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;bytes -&amp;gt; $bytes&amp;#34;&lt;/span&gt;)
      &lt;span style=&#34;color:#75715e&#34;&gt;// send back message to client
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;      webSocket.send(bytes)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClosed&lt;/span&gt;(
      webSocket: WebSocket,
      code: Int,
      reason: String
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onClosed(webSocket, code, reason)
      Logger.i(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;MockWebServer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onClosed&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;reason -&amp;gt; $reason&amp;#34;&lt;/span&gt;)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClosing&lt;/span&gt;(
      webSocket: WebSocket,
      code: Int,
      reason: String
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onClosing(webSocket, code, reason)
      Logger.i(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;MockWebServer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onClosing&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;reason -&amp;gt; $reason&amp;#34;&lt;/span&gt;)
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onFailure&lt;/span&gt;(
      webSocket: WebSocket,
      t: Throwable,
      response: Response?
    ) {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onFailure(webSocket, t, response)
      Logger.i(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;MockWebServer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;onFailure&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;exception -&amp;gt; ${t.message}&amp;#34;&lt;/span&gt;)
    }
  }))
  &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; mockWebServer
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>JVM Architecture in A Nutshell</title>
      <link>https://zacash.cn/post/jvm-arch-in-a-nutshell/</link>
      <pubDate>Fri, 17 Jul 2020 00:00:00 +0000</pubDate>
      
      <guid>https://zacash.cn/post/jvm-arch-in-a-nutshell/</guid>
      <description>&lt;p&gt;跨平台的本质是因为汇编指令的不同.&lt;/p&gt;
&lt;h2 id=&#34;classloader&#34;&gt;ClassLoader&lt;/h2&gt;
&lt;h3 id=&#34;what-is-it&#34;&gt;What is it&lt;/h3&gt;
&lt;p&gt;类加载器负责在运行时将 Java 类动态加载到 JVM，是 JRE 的一部分，由于有了类加载器，JVM 无需了解底层文件或文件系统即可运行Java程序。&lt;/p&gt;
&lt;p&gt;类加载器不会一次将全部类加载到内存里，而是在程序需要时加载。&lt;/p&gt;
&lt;h3 id=&#34;built-in-class-loaders-types&#34;&gt;Built-in class loaders types&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Bootstrap class loader&lt;/p&gt;
&lt;p&gt;每个 JVM 实现必须有一个 bootstrap 类加载器。它加载 &lt;em&gt;JAVA_HOME/jre/lib&lt;/em&gt; 目录下的核心 Java API 类，该路径通常被称为引导路径(bootstrap path)。该类加载器由 C/C++ 语言实现。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Extension class loader&lt;/p&gt;
&lt;p&gt;Bootstrap 的子类加载器，它加载扩展目录 &lt;em&gt;JAVA_HOME/jre/lib/ext&lt;/em&gt; 或 &lt;strong&gt;java.ext.dirs&lt;/strong&gt; 指定路径下的类。它由 Java 在 &lt;code&gt;sun.misc.Launcher$ExtClassLoader&lt;/code&gt; 类中实现。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;System/Application class loader&lt;/p&gt;
&lt;p&gt;Extension 的子类加载器。它负责从 app 路径加载类，它加载在 &lt;em&gt;classpath&lt;/em&gt; 环境变量、&lt;em&gt;-classpath&lt;/em&gt;、-cp 命令行选项中找到的文件。它同样由 Java 在 &lt;code&gt;sun.misc.Launcher$AppClassLoader&lt;/code&gt; 类中实现。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;how-it-works&#34;&gt;How it works&lt;/h3&gt;
&lt;p&gt;类加载器是 JRE 的一部分。当 JVM 请求一个类时，类加载器尝试定位该类，并使用&lt;em&gt;完全限定的类名(fully qualified class name)&lt;/em&gt; 将&lt;em&gt;类定义(class definition)&lt;/em&gt; 加载到运行时环境中。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;java.lang.ClassLoader.loadClass()&lt;/code&gt; 方法负责将类定义加载到运行时环境中。如果请求的类尚未加载，则它将请求委派给父类加载器，此过程递归进行。如果父类加载器找不到该类，则子类加载器调用 &lt;code&gt;java.net.URLClassLoader.findClass()&lt;/code&gt; 方法在文件系统中查找类。最终，如果子类加载器未找到该类，则它将抛出 &lt;code&gt;java.lang.NoClassDefFoundError&lt;/code&gt; 或 &lt;code&gt;java.lang.ClassNotFoundException&lt;/code&gt;。&lt;/p&gt;
&lt;h3 id=&#34;class-loader-features&#34;&gt;Class loader features&lt;/h3&gt;
&lt;h4 id=&#34;代理模型delegation-model&#34;&gt;代理模型（Delegation Model）&lt;/h4&gt;
&lt;p&gt;类加载器遵循代理模型，在该模型中，ClassLoader 会根据请求查找的类或资源，将搜索类或资源的工作委托给父加载器处理。仅当 bootstrap class loader 和 extension class loader 都未能加载该类时，system class loader 才会尝试自己加载该类。&lt;/p&gt;
&lt;h4 id=&#34;唯一类unique-classes&#34;&gt;唯一类（Unique classes）&lt;/h4&gt;
&lt;p&gt;作为代理模型的结果，很容易确保唯一的类，因为我们始终向上委托。&lt;/p&gt;
&lt;h4 id=&#34;可见性visibility&#34;&gt;可见性（Visibility）&lt;/h4&gt;
&lt;p&gt;子类加载器对其父类加载器加载的类完全可见，父类加载器则对子类加载器加载的类不可见。&lt;/p&gt;
&lt;h3 id=&#34;custom-classloader&#34;&gt;Custom ClassLoader&lt;/h3&gt;
&lt;p&gt;在需要从本地或网络加载类的场景，我们可能需要使用自定义类加载器。&lt;/p&gt;
&lt;h4 id=&#34;使用场景&#34;&gt;使用场景&lt;/h4&gt;
&lt;p&gt;自定义类加载器不仅对在运行时加载类有帮助，还包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;修改现有字节码，如织入代理&lt;/li&gt;
&lt;li&gt;动态创建适合用户需求的类。如 JDBC 中，通过动态类加载完成不同驱动实现(driver implementations)之间的切换。&lt;/li&gt;
&lt;li&gt;实现类版本控制机制，如为具有相同名称和包名的类加载不同的字节码（热修复）。这可以通过 URL 类加载器或自定义加载器完成。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们可以自定义类加载器实现指定类的加载：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;package&lt;/span&gt; com.zac4j.system.util

&lt;span style=&#34;color:#66d9ef&#34;&gt;import&lt;/span&gt; java.io.ByteArrayOutputStream
&lt;span style=&#34;color:#66d9ef&#34;&gt;import&lt;/span&gt; java.io.File
&lt;span style=&#34;color:#66d9ef&#34;&gt;import&lt;/span&gt; java.io.IOException

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Custom ClassLoader sample
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; *
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * @author: zac
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * @date: 2020/7/19
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;internal&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Test&lt;/span&gt; {
  @JvmStatic &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;(args: Array&amp;lt;String&amp;gt;) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; classLoader = CustomClassLoader()
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; clazz = classLoader.loadClass(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;com.zac4j.system.util.Utils&amp;#34;&lt;/span&gt;)
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;custom classloader:${clazz.canonicalName}&amp;#34;&lt;/span&gt;)
  }
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * 自定义 ClassLoader，加载指定类文件。
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;CustomClassLoader&lt;/span&gt; : ClassLoader() {
  &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;findClass&lt;/span&gt;(name: String): Class&amp;lt;*&amp;gt; {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; b = loadClassFromFile(name)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; defineClass(name, b, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, b.size)
  }

  &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   * 根据类名加载类文件
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;loadClassFromFile&lt;/span&gt;(filename: String): ByteArray {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; inStream = javaClass.classLoader&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;getResourceAsStream(
        filename.replace(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;, File.separatorChar) + &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;.class&amp;#34;&lt;/span&gt;
    ) &lt;span style=&#34;color:#f92672&#34;&gt;?:&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; byteArrayOf()
    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; outStream = ByteArrayOutputStream()
    &lt;span style=&#34;color:#66d9ef&#34;&gt;try&lt;/span&gt; {
      &lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; (inStream.read() != -&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; nextVal = inStream.read()
        outStream.write(nextVal)
      }
    } &lt;span style=&#34;color:#66d9ef&#34;&gt;catch&lt;/span&gt; (e: IOException) {

    }
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; outStream.toByteArray()
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;responsibility&#34;&gt;Responsibility&lt;/h3&gt;
&lt;p&gt;Class Loader 系统主要有&lt;a href=&#34;https://docs.oracle.com/javase/specs/jvms/se6/html/ConstantPool.doc.html#67960&#34;&gt;3种功能&lt;/a&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Loading&lt;/li&gt;
&lt;li&gt;Linking&lt;/li&gt;
&lt;li&gt;Initialization&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;loading&#34;&gt;Loading&lt;/h4&gt;
&lt;p&gt;类加载器读取 &lt;em&gt;.class&lt;/em&gt; 文件，生成对应的二进制数据并保存到 JVM 方法区。对每个 &lt;em&gt;.class&lt;/em&gt; 文件，方法区保存这些信息：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;完全限定名称的加载类和其直属父类&lt;/li&gt;
&lt;li&gt;&lt;em&gt;.class&lt;/em&gt; 文件是否与 Class 或 Interface 或 Enum 有关&lt;/li&gt;
&lt;li&gt;修饰符（Modifier）、变量和方法信息等。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;加载 &lt;em&gt;.class&lt;/em&gt; 文件后，JVM 在堆中创建该文件对应的 Class 类型对象。开发者可以使用此 Class 对象来获取类级别（class level）的信息，如类名、父类名、方法（&lt;code&gt;Class.getdeclaredMethods()&lt;/code&gt;）和变量信息（&lt;code&gt;Class.getDeclaredFields()&lt;/code&gt;）等。&lt;/p&gt;
&lt;h4 id=&#34;linking&#34;&gt;Linking&lt;/h4&gt;
&lt;p&gt;执行 Verification、Preparation 和 Resolution。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Verification：通过检查 &lt;em&gt;.class&lt;/em&gt; 文件是否正确的格式化和是否由有效的编译器生成，确保该文件的正确性。如果验证失败，将抛出运行时异常：&lt;em&gt;java.lang.VerifyError&lt;/em&gt;。&lt;/li&gt;
&lt;li&gt;Preparation：JVM 为类变量分配内存，并将内存初始化为默认值。&lt;/li&gt;
&lt;li&gt;Resolution：这是用直接引用(direct references)替换类型中的符号引用(symbolic references)的过程。通过搜索方法区域以找到引用的实体来完成此操作。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;initialization&#34;&gt;Initialization&lt;/h4&gt;
&lt;p&gt;这个阶段将为所有静态变量分配在代码或静态代码块中定义的值。在类中从顶至底（from top to bottom）执行，在类层级中从父类到子类（from parent to child）执行。类加载器的初始化：Bootstrap class loader -&amp;gt; Extension class loader -&amp;gt; App class loader.&lt;/p&gt;
&lt;h2 id=&#34;run-time-data-areas&#34;&gt;Run-Time Data Areas&lt;/h2&gt;
&lt;p&gt;基本结构.jpg&lt;/p&gt;
&lt;h3 id=&#34;the-pc-register&#34;&gt;The pc Register&lt;/h3&gt;
&lt;p&gt;JVM 可以支持多个线程同时运行，每个线程都有自己独立的 PC 寄存器(program counter register)。在任意时间点，任一线程在执行某个方法的代码，被称作该线程的&lt;a href=&#34;https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.6&#34;&gt;当前方法(current method)&lt;/a&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果该方法是 &lt;em&gt;native&lt;/em&gt; 的，pc 寄存器的值是 &lt;em&gt;undefined&lt;/em&gt;。&lt;/li&gt;
&lt;li&gt;如果该方法不是 &lt;em&gt;native&lt;/em&gt; 的，pc 寄存器包含当前正在执行指令的地址。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;JVM 的 pc 寄存器容量足够在特定平台上保存 &lt;em&gt;returnAddress&lt;/em&gt; 或 &lt;em&gt;native&lt;/em&gt; 指针。&lt;/p&gt;
&lt;h3 id=&#34;jvm-stacks&#34;&gt;JVM Stacks&lt;/h3&gt;
&lt;p&gt;对每个线程，JVM 在创建线程时都会创建一个私有的堆栈。JVM 仅对堆栈进行两种操作：推入(push)和弹出(pop)栈帧(frames)。JVM 堆栈的内存&lt;strong&gt;不必是连续的&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;线程执行的每个方法调用(method calls)都存储在对应的堆栈中，包括入参、局部变量、中间计算和其他数据。方法完成后，JVM 将从堆栈中删除对应的条目，完成所有的方法调用后，堆栈将变为空，并且在终止线程前，销毁该堆栈。&lt;/p&gt;
&lt;p&gt;存储在堆栈中的数据仅适用于对应线程，对别的线程不适用。因此，可以说局部数据是线程安全的。堆栈中每个条目都称为 &lt;em&gt;堆栈帧(Stack Frame)&lt;/em&gt; 或 &lt;em&gt;激活记录(Activation Record)&lt;/em&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;第一版的 Java 虚拟机规范 &lt;em&gt;The Java® Virtual Machine Specification&lt;/em&gt;, &lt;em&gt;JVM 堆栈(Java Virtual Machine stack)&lt;/em&gt; 被称为 &lt;em&gt;Java 栈(Java stack)&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;JVM 规范允许Java虚拟机堆栈具有固定大小，或者根据计算要求动态伸缩。 如果Java虚拟机堆栈的大小固定，则在创建每个Java虚拟机堆栈时可以独立选择它们的大小。&lt;/p&gt;
&lt;p&gt;关联的异常：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;如果线程中的计算需要比允许的 JVM 更大的堆栈，则 JVM 将抛出 &lt;strong&gt;StackOverflowError&lt;/strong&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果可以动态扩展 JVM 堆栈容量，并且尝试进行动态扩展，但外部环境无法提供足够的内存资源，或没有足够的内存资源为新线程创建 JVM 堆栈，则 JVM 会抛出 &lt;strong&gt;OutOfMemoryError&lt;/strong&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;heap&#34;&gt;Heap&lt;/h3&gt;
&lt;p&gt;堆是运行时数据区内为所有类实例和数组分配内存的部分，是共享资源。&lt;/p&gt;
&lt;p&gt;堆在虚拟机启动时创建，&lt;em&gt;垃圾回收器(garbage collector)&lt;/em&gt; 可以回收对象堆堆存储，对象永远不会显式释放内存。堆的大小同样可以是固定的，或者根据计算要求动态伸缩。堆内存&lt;strong&gt;不必是连续的&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;用户可以控制堆固定初始大小，或动态伸缩场景控制堆的最大/最小值。&lt;/p&gt;
&lt;p&gt;关联的异常：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;计算需要的堆内存多于系统可以提供的内存资源， JVM 会抛出 &lt;strong&gt;OutOfMemoryError&lt;/strong&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;method-area&#34;&gt;Method Area&lt;/h3&gt;
&lt;p&gt;方法区存储每个类的结构，如&lt;em&gt;运行时常量池(run-time constant pool)&lt;/em&gt;，&lt;em&gt;字段(field)&lt;/em&gt;，和&lt;em&gt;方法数据(method data)&lt;/em&gt;，以及方法和构造函数的代码，是共享资源。&lt;/p&gt;
&lt;p&gt;方法区同样是在 JVM 启动时创建。尽管方法区在逻辑上是堆的一部分，但 JVM 实现可以选择不对其进行垃圾回收或压缩。&lt;/p&gt;
&lt;p&gt;方法区可以是固定大小，或根据计算需求进行动态伸缩。方法区内存同样&lt;strong&gt;不必是连续的&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;关联的异常：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;方法区需要分配的内存多于系统可提供的内存资源，JVM 会抛出 &lt;strong&gt;OutOfMemoryError&lt;/strong&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;native-method-stacks&#34;&gt;Native Method Stacks&lt;/h3&gt;
&lt;p&gt;JVM 可以使用传统的堆栈，俗称 “C 栈”，来支持 &lt;em&gt;native&lt;/em&gt; 方法。&lt;em&gt;native&lt;/em&gt; 方法栈可以用于 JVM C语言指令集的解释器。JVM 不能加载 &lt;em&gt;native&lt;/em&gt; 方法，并且它本身不依赖于传统堆栈，不需要提供 &lt;em&gt;native&lt;/em&gt; 方法栈。如果提供，通常在创建线程时为每个线程提供 &lt;em&gt;native&lt;/em&gt; 方法栈。&lt;/p&gt;
&lt;p&gt;JVM 规范允许 &lt;em&gt;native&lt;/em&gt; 方法堆栈具有固定大小，或者根据计算要求动态扩展和收缩。如果本机方法堆栈的大小固定，则在创建每个 &lt;em&gt;native&lt;/em&gt; 方法栈的大小时可以独立选择。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;native&lt;/em&gt; 方法栈关联的异常：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果线程中的计算所需的 &lt;em&gt;native&lt;/em&gt; 方法栈容量超出允许的范围，则 JVM 会抛出 &lt;strong&gt;StackOverflowError&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;如果 &lt;em&gt;native&lt;/em&gt; 方法栈容量尝试动态扩展，但外部环境无法提供足够的内存资源，或没有足够的内存资源为新线程创建 &lt;em&gt;native&lt;/em&gt; 方法栈，则 JVM 会抛出 &lt;strong&gt;OutOfMemoryError&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;run-time-constant-pool&#34;&gt;Run-Time Constant Pool&lt;/h3&gt;
&lt;p&gt;运行时常量池是每个类或接口的 &lt;em&gt;class&lt;/em&gt; 文件中 &lt;em&gt;constant_pool&lt;/em&gt; 表的运行时表示形式。它主要包含：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;编译时数字文字&lt;/li&gt;
&lt;li&gt;运行时方法和字段引用&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;运行时常量池功能类似于常规编程语言的符号表。尽管它包含的数据范围比典型的符号表更大。&lt;/p&gt;
&lt;p&gt;每个运行时常量池都是从 JVM 方法去分配的，当 JVM 创建类或接口时，将为该类或结构构造运行时常量池。&lt;/p&gt;
&lt;p&gt;运行时常量池会关联如下异常：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;创建类或缄口时，如果运行时常量池构造所需的内存超过 JVM 方法区的可用内存，则 JVM 会抛出 &lt;strong&gt;OutOfMemoryError&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;execution-engine&#34;&gt;Execution Engine&lt;/h2&gt;
&lt;p&gt;执行引擎执行 &lt;em&gt;.class(bytecode)&lt;/em&gt;.它逐行读取字节码，使用各个存储区的数据和信息并执行指令，它可以分成三部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Interpreter：逐行解释字节码然后执行。缺点是当多处调用一个方法时，每次都需要解释步骤。&lt;/li&gt;
&lt;li&gt;Just-in-Time Compiler(HotSpot)：用于提高解释器的效率，它编译整个字节码并将其转换为 &lt;em&gt;native&lt;/em&gt; 代码，每当解释器遇见重复的方法调用时，JIT 都会为该部分提供 &lt;em&gt;native&lt;/em&gt; 代码，因此不用解释器重复解释，从而提高了效率。&lt;/li&gt;
&lt;li&gt;Garbage Collector：销毁未引用的对象，回收内存。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;java-native-interfacejni&#34;&gt;Java Native Interface（JNI）&lt;/h2&gt;
&lt;p&gt;JNI 是与 &lt;em&gt;native&lt;/em&gt; 方法库交互的接口，它使 JVM 可以调用 C/C ++ 库。&lt;/p&gt;
&lt;h2 id=&#34;native-method-libraries&#34;&gt;Native Method Libraries&lt;/h2&gt;
&lt;p&gt;供执行引擎需要的 &lt;em&gt;native&lt;/em&gt; 代码库。&lt;/p&gt;
&lt;h2 id=&#34;reference&#34;&gt;Reference&lt;/h2&gt;
&lt;p&gt;JVM Run-Time Data Areas: &lt;a href=&#34;https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4&#34;&gt;https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4&lt;/a&gt;
JVM architecture: &lt;a href=&#34;https://www.geeksforgeeks.org/jvm-works-jvm-architecture/&#34;&gt;https://www.geeksforgeeks.org/jvm-works-jvm-architecture/&lt;/a&gt;
Class Loader: &lt;a href=&#34;https://www.baeldung.com/java-classloaders&#34;&gt;https://www.baeldung.com/java-classloaders&lt;/a&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>JVM Mechanics</title>
      <link>https://zacash.cn/post/jvm-mechanics/</link>
      <pubDate>Fri, 17 Jul 2020 00:00:00 +0000</pubDate>
      
      <guid>https://zacash.cn/post/jvm-mechanics/</guid>
      <description>&lt;p&gt;Class 文件的结构&lt;/p&gt;
&lt;h2 id=&#34;class-file&#34;&gt;Class File&lt;/h2&gt;
&lt;h3 id=&#34;classfile-structure&#34;&gt;ClassFile structure&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-class&#34; data-lang=&#34;class&#34;&gt;ClassFile {
    u4 magic;
    u2 minor_version;
    u2 major_version;
    u2 constant_pool_count;
    cp_info constant_pool[constant_pool_count-1];
    u2 access_flags;
    u2 this_class;
    u2 super_class;
    u2 interfaces_count;
    u2 interfaces[interfaces_count];
    u2 fields_count;
    field_info fields[fields_count];
    u2 methods_count;
    method_info methods[methods_count];
    u2 attributes_count;
    attribute_info attributes[attributes_count];
}
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;The constant_pool is a table of structures representing various string constants, class and interface names, field names, and other constants that are referred to within the ClassFile structure and its substructures. The format of each constant_pool table entry is indicated by its first &amp;ldquo;tag&amp;rdquo; byte.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;constant_pool&lt;/em&gt; 是一个结构表，表示字符串常量、class 和 interface 名称、field 名称以及 ClassFile 结构和其子结构中引用的常量。每个 &lt;em&gt;constant_pool&lt;/em&gt; 表条目的格式由其 &amp;ldquo;tag&amp;rdquo; 字节标识。&lt;/p&gt;
&lt;h4 id=&#34;constant-pool&#34;&gt;constant pool&lt;/h4&gt;
&lt;p&gt;Jvm 指令不依赖于类，接口，类实例或数组，相反，指令引用了 constant_pool 表中的符号信息（symbolic info）。常量池中的条目有如下的结构：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-class&#34; data-lang=&#34;class&#34;&gt;cP_info {
    u1 tag;
    u1 info[];
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;tag 表示常量的类型，info 存储常量的值&lt;/p&gt;
&lt;p&gt;tag 类型和对应的值：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;Constant Type&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Class&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Fieldref&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;9&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Methodref&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;10&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_InterfaceMethodref&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;11&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_String&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Integer&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Float&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Long&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Double&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_NameAndType&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;12&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;CONSTANT_Utf8&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;fields&#34;&gt;Fields&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;field_info&lt;/em&gt; 的结构：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-class&#34; data-lang=&#34;class&#34;&gt;field_info {
    u2 access_flags;
    u2 name_index;
    u2 descriptor_index;
    u2 attributes_count;
    attribute_info attributes[attributes_count];
}
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;field-access_flags&#34;&gt;Field access_flags&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Flag Name&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;th&gt;Interpretation&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;ACC_PUBLIC&lt;/td&gt;
&lt;td&gt;0x0001&lt;/td&gt;
&lt;td&gt;Declared public; may be accessed from outside its package.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_PRIVATE&lt;/td&gt;
&lt;td&gt;0x0002&lt;/td&gt;
&lt;td&gt;Declared private; usable only within the defining class.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_PROTECTED&lt;/td&gt;
&lt;td&gt;0x0004&lt;/td&gt;
&lt;td&gt;Declared protected; may be accessed within subclasses.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_STATIC&lt;/td&gt;
&lt;td&gt;0x0008&lt;/td&gt;
&lt;td&gt;Declared static.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_FINAL&lt;/td&gt;
&lt;td&gt;0x0010&lt;/td&gt;
&lt;td&gt;Declared final; no further assignment after initialization.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_VOLATILE&lt;/td&gt;
&lt;td&gt;0x0040&lt;/td&gt;
&lt;td&gt;Declared volatile; cannot be cached.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_TRANSIENT&lt;/td&gt;
&lt;td&gt;0x0080&lt;/td&gt;
&lt;td&gt;Declared transient; not written or read by a persistent object manager.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;methods&#34;&gt;Methods&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;method_info&lt;/em&gt; 的结构：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-class&#34; data-lang=&#34;class&#34;&gt;method_info {
    u2 access_flags;
    u2 name_index;
    u2 descriptor_index;
    u2 attributes_count;
    attribute_info attributes[attributes_count];
}
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;method-access_flags&#34;&gt;Method access_flags&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Flag Name&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;th&gt;Interpretation&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;ACC_PUBLIC&lt;/td&gt;
&lt;td&gt;0x0001&lt;/td&gt;
&lt;td&gt;Declared public; may be accessed from outside its package.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_PRIVATE&lt;/td&gt;
&lt;td&gt;0x0002&lt;/td&gt;
&lt;td&gt;Declared private; accessible only within the defining class.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_PROTECTED&lt;/td&gt;
&lt;td&gt;0x0004&lt;/td&gt;
&lt;td&gt;Declared protected; may be accessed within subclasses.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_STATIC&lt;/td&gt;
&lt;td&gt;0x0008&lt;/td&gt;
&lt;td&gt;Declared static.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_FINAL&lt;/td&gt;
&lt;td&gt;0x0010&lt;/td&gt;
&lt;td&gt;Declared final; may not be overridden.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_SYNCHRONIZED&lt;/td&gt;
&lt;td&gt;0x0020&lt;/td&gt;
&lt;td&gt;Declared synchronized; invocation is wrapped in a monitor lock.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_NATIVE&lt;/td&gt;
&lt;td&gt;0x0100&lt;/td&gt;
&lt;td&gt;Declared native; implemented in a language other than Java.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_ABSTRACT&lt;/td&gt;
&lt;td&gt;0x0400&lt;/td&gt;
&lt;td&gt;Declared abstract; no implementation is provided.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACC_STRICT&lt;/td&gt;
&lt;td&gt;0x0800&lt;/td&gt;
&lt;td&gt;Declared strictfp; floating-point mode is FP-strict&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&#34;interpreter-vs-compilers&#34;&gt;Interpreter vs Compilers&lt;/h2&gt;
&lt;h3 id=&#34;interpreter&#34;&gt;Interpreter&lt;/h3&gt;
&lt;p&gt;Fetch next bytecode, execute, repeat&lt;/p&gt;
&lt;h3 id=&#34;compilers&#34;&gt;Compilers&lt;/h3&gt;
&lt;p&gt;HotSpot has two compilers: JIT compiler and server compiler&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Convert entire methods into native code&lt;/li&gt;
&lt;li&gt;Optimize(inlining, unboxing, loop optimization, etc)&lt;/li&gt;
&lt;li&gt;Code calls back to &amp;ldquo;runtime&amp;rdquo; when necessary&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;compiling-for-jvm&#34;&gt;Compiling for JVM&lt;/h3&gt;
&lt;p&gt;编译是将 Java 源码编译成 Jvm 指令集（instruction set）的过程，编译器（compiler）是实现这一过程的工具，有些场景编译器指代将 Jvm 指令集转到到特定 CPU 指令集的工具。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Intro to HashMap</title>
      <link>https://zacash.cn/post/intro-to-hashmap/</link>
      <pubDate>Wed, 15 Jul 2020 15:11:27 +0800</pubDate>
      
      <guid>https://zacash.cn/post/intro-to-hashmap/</guid>
      <description>&lt;p&gt;Hash table based implementation of the Map interface.  This implementation provides all of the optional map operations, and permits null values and the null key.&lt;/p&gt;
&lt;h2 id=&#34;hashmap-介绍&#34;&gt;HashMap 介绍&lt;/h2&gt;
&lt;p&gt;The HashMap class is roughly equivalent to Hashtable, except that it is unsynchronized and permits nulls. This class makes no guarantees as to the order of the map; in particular, it does not guarantee that the order will remain constant over time.&lt;/p&gt;
&lt;p&gt;HashMap 和 HashTable 大致等效，除了 HashMap 是非同步的，以及允许空值。无法保证顺序随着时间的推移保持不变。&lt;/p&gt;
&lt;p&gt;This implementation provides &lt;strong&gt;constant-time&lt;/strong&gt; performance for the basic operations (get and put),assuming the hash function disperses the elements properly among the buckets.&lt;/p&gt;
&lt;p&gt;假设 hash 函数将元素分散在正确的 bucket 中，HashMap 对于基本操作(get 或 put) 会提供恒定时间的性能。&lt;/p&gt;
&lt;h3 id=&#34;何为-constant-time&#34;&gt;何为 constant time&lt;/h3&gt;
&lt;p&gt;constant time 是表示时间复杂度的一个示例，常见时间复杂度的描述：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Time complexity&lt;/th&gt;
&lt;th&gt;Time description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;O(1)&lt;/td&gt;
&lt;td&gt;Constant time&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;O(log n)&lt;/td&gt;
&lt;td&gt;Logarithmic time&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;O(n)&lt;/td&gt;
&lt;td&gt;Linear time&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;O(n log n)&lt;/td&gt;
&lt;td&gt;Pseudo-linear time&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;O(n^c)&lt;/td&gt;
&lt;td&gt;Polynomial time&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;O(c^n)&lt;/td&gt;
&lt;td&gt;Exponential time&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;O(n!)&lt;/td&gt;
&lt;td&gt;Factorial time&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Iteration over collection views requires time proportional to the &amp;ldquo;capacity&amp;rdquo; of the HashMap instance (the number of buckets) plus its size (the number of key-value mappings).&lt;/p&gt;
&lt;p&gt;从集合视角看，迭代所需的时间与 HashMap 实例的“容量”（ bucket 数量 ）及其大小（键-值映射数）成正比。&lt;/p&gt;
&lt;p&gt;Thus, it&amp;rsquo;s very important not to set the initial capacity too high (or the load factor too low) if iteration performance is important.&lt;/p&gt;
&lt;p&gt;因此，如果迭代性能很重要，那么不要将初识容量设置过高（或负载因子设置过低），这很关键。&lt;/p&gt;
&lt;p&gt;An instance of HashMap has two parameters that affect its performance：&lt;/p&gt;
&lt;p&gt;有两个参数会影响 HashMap 实例的性能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;initial capacity 初始容量&lt;/li&gt;
&lt;li&gt;load factor 负载因子&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The capacity is the number of buckets in the hash table, and the initial capacity is simply the capacity at the time the hash table is created. The load factor is a measure of how full the hash table is allowed to get before its capacity is automatically increased.&lt;/p&gt;
&lt;p&gt;容量是哈希表中 bucket 的数量，初始容量即是创建哈希表时的容量。负载因子用来评估哈希表填满的程度，以自动增长容量。&lt;/p&gt;
&lt;p&gt;When the number of entries in the hash table exceeds the product of the load factor and the current capacity, the hash table is rehashed (that is, internal data structures are rebuilt) so that the hash table has approximately twice the number of buckets.&lt;/p&gt;
&lt;p&gt;当哈希表中的条目数超过负载因子和当前容量的乘积时，哈希表将被重新映射（即内部数据结构将被重建），以使哈希表的 bucket 数大约为两倍。&lt;/p&gt;
&lt;p&gt;As a general rule, the default load factor (0.75) offers a good tradeoff between time and space costs. Higher values decrease the space overhead but increase the lookup cost (reflected in most of the operations of the HashMap class, including get and put).&lt;/p&gt;
&lt;p&gt;通常，默认负载因子（0.75）在时间和空间成本之间提供了一个很好的权衡。较高的值会减少空间开销，但会增加查找成本（反应在 HashMap 类的大多数操作中，包括 get 和 put）。&lt;/p&gt;
&lt;p&gt;The expected number of entries in the map and its load factor should be taken into account when setting its initial capacity, so as to minimize the number of rehash operations.&lt;/p&gt;
&lt;p&gt;设置其初始容量时，应考虑 map 中的预期条目数及其负载因子，以最大程度地减少重新映射操作的次数。&lt;/p&gt;
&lt;p&gt;If the initial capacity is greater than the maximum number of entries divided by the load factor, no rehash operations will ever occur.&lt;/p&gt;
&lt;p&gt;如果初始容量大于最大条目数除以负载因子，则将不会发生任何映射操作。&lt;/p&gt;
&lt;p&gt;If many mappings are to be stored in a HashMap instance, creating it with a sufficiently large capacity will allow the mappings to be stored more efficiently than letting it perform automatic rehashing as needed to grow the table.&lt;/p&gt;
&lt;p&gt;如果将许多映射关系存储在 HashMap 实例中，创建足够大容量的 map 将比让其按需自动增长哈希表重新映射，更有效的存储映射。&lt;/p&gt;
&lt;p&gt;Note that using many keys with the same {@code hashCode()} is a sure way to slow down performance of any hash table. To ameliorate impact, when keys are {@link Comparable}, this class may use comparison order among keys to help break ties.&lt;/p&gt;
&lt;p&gt;注意，使用许多具有相同 hashCode 的键是降低任何哈希表性能的方法。为了改善影响，当键是可比较时(Comparable)时，此类可以使用键之间的比较顺序来帮助打破平衡。&lt;/p&gt;
&lt;p&gt;Note that this implementation is not synchronized. If multiple threads access a hash map concurrently, and at least one of the threads modifies the map structurally, it must be synchronized externally. (A structural modification is any operation that adds or deletes one or more mappings; merely changing the value associated with a key that an instance already contains is not a structural modification.) This is typically accomplished by synchronizing on some object that naturally encapsulates the map.&lt;/p&gt;
&lt;p&gt;注意，这个实现并不是同步的。如果多线程同时访问 hash map，并且至少有一个线程在结构上修改了 map，则必须在外部进行同步。（结构型修改是指增删一个或多个映射关系，更新某个 key 对应的值并不是结构型修改）。通常是对封装 map 的某个对象加同步来实现。&lt;/p&gt;
&lt;p&gt;If no such object exists, the map should be &amp;ldquo;wrapped&amp;rdquo; using the {@link Collections#synchronizedMap Collections.synchronizedMap} method.  This is best done at creation time, to prevent accidental unsynchronized access to the map: Map m = Collections.synchronizedMap(new HashMap(&amp;hellip;));&lt;/p&gt;
&lt;p&gt;如果没有这样的对象存在，则应该使用 Collections.synchronizedMap 方法来包装 map，最好是在创建时完成，以避免意外不同步地访问 map：&lt;code&gt;Map m = Collections.synchronizedMap(new HashMap(...));&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The iterators returned by all of this class&amp;rsquo;s &amp;ldquo;collection view methods&amp;rdquo; are fail-fast: if the map is structurally modified at any time after the iterator is created, in any way except through the iterator&amp;rsquo;s own remove method, the iterator will throw a {@link ConcurrentModificationException}.  Thus, in the face of concurrent modification, the iterator fails quickly and cleanly, rather than risking arbitrary, non-deterministic behavior at an undetermined time in the future.&lt;/p&gt;
&lt;p&gt;此类的所有“集合视角方法”返回的迭代器都是 &lt;a href=&#34;https://whatis.techtarget.com/definition/fail-fast&#34;&gt;fast fail&lt;/a&gt; 的：在创建迭代器之后任何时刻对 map 结构进行了修改，除了通过迭代器自已的 remove 方法以外，该迭代器都会抛出 ConcurrentModificationException。因此，面对并发修改，迭代器会快速干净的 fail，而不是在未来的不确定时间冒着任意，不确定行为的风险。&lt;/p&gt;
&lt;h3 id=&#34;何为-fast-fail&#34;&gt;何为 fast fail&lt;/h3&gt;
&lt;p&gt;Note that the fail-fast behavior of an iterator cannot be guaranteed as it is, generally speaking, impossible to make any hard guarantees in the presence of unsynchronized concurrent modification.  Fail-fast iterators throw ConcurrentModificationException on a best-effort basis. Therefore, it would be wrong to write a program that depended on this exception for its correctness: the fail-fast behavior of iterators should be used only to detect bugs.&lt;/p&gt;
&lt;p&gt;注意不能保证迭代器的 fast fail 行为，一般来说，在存在不同步的并发修改情况下，不可能作出任何严格的保证。因此，编写依赖于此异常的程序的正确性是错误的：迭代器的 fast fail 行为仅用于错误检测。&lt;/p&gt;
&lt;p&gt;This class is a member of the Java Collections Framework&lt;a href=&#34;https://docs.oracle.com/javase/8/docs/technotes/guides/collections/index.html&#34;&gt;jcf&lt;/a&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>How Are Touch Events Delivered</title>
      <link>https://zacash.cn/post/how-are-touch-events-delivered/</link>
      <pubDate>Sat, 11 Jul 2020 08:37:45 +0800</pubDate>
      
      <guid>https://zacash.cn/post/how-are-touch-events-delivered/</guid>
      <description>&lt;p&gt;根据例子来理解 Android 的事件传递&lt;/p&gt;
&lt;p&gt;页面的布局结构&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;utf-8&amp;#34;?&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;layout&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;xmlns:android=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;http://schemas.android.com/apk/res/android&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;xmlns:app=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;http://schemas.android.com/apk/res-auto&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;

  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;data&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;variable&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;viewModel&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;type=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;com.zac4j.system.data.TouchViewModel&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/data&amp;gt;&lt;/span&gt;

  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;com.zac4j.system.ui.widget.CustomLayout&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:id=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@id/touch_sample_container&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_width=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_height=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;

    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;Button&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:id=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@id/touch_sample_btn&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;style=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@style/Widget.AppCompat.Button.Colored&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_width=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_height=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;wrap_content&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:text=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Touch Me&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;app:layout_constraintEnd_toEndOf=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;parent&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;app:layout_constraintStart_toStartOf=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;parent&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;app:layout_constraintTop_toTopOf=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;parent&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;

  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/com.zac4j.system.ui.widget.CustomLayout&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/layout&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;touchevent-的传递&#34;&gt;TouchEvent 的传递&lt;/h2&gt;
&lt;p&gt;我们通常对 Button 创建点击事件:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;touchSampleBtn.setOnClickListener {
    Logger.i(TAG, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;setOnClickListener&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;sampleBtn clicked&amp;#34;&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以先看下 View.dispatchTouchEvent() 的实现:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; boolean dispatchTouchEvent(MotionEvent event) {
    ...
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (onFilterTouchEventForSecurity(event)) {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; ((mViewFlags &amp;amp; ENABLED_MASK) == ENABLED &amp;amp;&amp;amp; handleScrollBarDragging(event)) {
            result = &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
        }
        &lt;span style=&#34;color:#75715e&#34;&gt;//noinspection SimplifiableIfStatement
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        ListenerInfo li = mListenerInfo;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (li != &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; li.mOnTouchListener != &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;
                &amp;amp;&amp;amp; (mViewFlags &amp;amp; ENABLED_MASK) == ENABLED
                &amp;amp;&amp;amp; li.mOnTouchListener.onTouch(&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;, event)) {
            result = &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
        }

        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (!result &amp;amp;&amp;amp; onTouchEvent(event)) {
            result = &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
        }
    }
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以看到 &lt;code&gt;View.mOnTouchListener.onTouch()&lt;/code&gt; 会在 &lt;code&gt;View.onTouchEvent()&lt;/code&gt; 前判断是否执行，假如 &lt;code&gt;View.mOnTouchListener.onTouch()&lt;/code&gt; 返回 true(消费该事件) 的话，&lt;code&gt;View.onTouchEvent()&lt;/code&gt; 将不会执行。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;View.mTouchListener.onTouch()&lt;/code&gt; 的执行条件是:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mTouchListener 不为空(即设置 &lt;code&gt;View.setOnTouchListener()&lt;/code&gt; 方法)&lt;/li&gt;
&lt;li&gt;View 是 enable 状态(未设置 &lt;code&gt;View.setEnable(false)&lt;/code&gt; 方法)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;viewgrouponintercepttouchevent&#34;&gt;ViewGroup.onInterceptTouchEvent&lt;/h2&gt;
&lt;p&gt;设置 &lt;code&gt;CustomLayout.onInterceptTouchEvent()&lt;/code&gt; 返回 false，点击 touchSamleBtn 按钮.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-log&#34; data-lang=&#34;log&#34;&gt;# MotionEvent.ACTION_DOWN 事件
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; CustomLayout, Method -&amp;gt; dispatchTouchEvent, Msg -&amp;gt; MotionEvent::ACTION_DOWN
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; CustomLayout, Method -&amp;gt; onInterceptTouchEvent, Msg -&amp;gt; MotionEvent::ACTION_DOWN
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; touchSampleBtn::AppCompatButton, Method -&amp;gt; setOnTouchListener, Msg -&amp;gt; MotionEvent::ACTION_DOWN
# MotionEvent.ACTION_UP 事件
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; CustomLayout, Method -&amp;gt; dispatchTouchEvent, Msg -&amp;gt; MotionEvent::ACTION_UP
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; CustomLayout, Method -&amp;gt; onInterceptTouchEvent, Msg -&amp;gt; MotionEvent::ACTION_UP
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; touchSampleBtn::AppCompatButton, Method -&amp;gt; setOnTouchListener, Msg -&amp;gt; MotionEvent::ACTION_UP
# View.onClick 事件
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; touchSampleBtn::AppCompatButton, Method -&amp;gt; setOnClickListener, Msg -&amp;gt; clicked
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;事件的传递: CustomLayout.dispatchTouchEvent() -&amp;gt; CustomLayout.onInterceptTouchEvent() -&amp;gt; View.mOnTouchListener.onTouch()&lt;/p&gt;
&lt;p&gt;同时 MotionEvent.ACTION_DOWN + MotionEvent.ACTION_DOWN -&amp;gt; View.mOnClickListener.onClick()&lt;/p&gt;
&lt;p&gt;设置 &lt;code&gt;CustomLayout.onInterceptTouchEvent()&lt;/code&gt; 返回 true，点击 touchSampleBtn.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-log&#34; data-lang=&#34;log&#34;&gt;I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; CustomLayout, Method -&amp;gt; onInterceptTouchEvent, Msg -&amp;gt; MotionEvent::ACTION_DOWN
I/ZacLog: Page -&amp;gt; TouchFragment, View -&amp;gt; touchSampleContainer::CustomLayout, Method -&amp;gt; setOnTouchListener, Msg -&amp;gt; MotionEvent::ACTION_DOWN
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我们看下 ViewGroup.dispatchTouchEvent() 的实现：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dispatchTouchEvent&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;MotionEvent ev&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mInputEventConsistencyVerifier &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        mInputEventConsistencyVerifier&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onTouchEvent&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; 1&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#75715e&#34;&gt;// If the event targets the accessibility focused view and this is it, start
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// normal event dispatch. Maybe a descendant is what will handle the click.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isTargetAccessibilityFocus&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; isAccessibilityFocusedViewOrHost&lt;span style=&#34;color:#f92672&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setTargetAccessibilityFocus&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; handled &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;onFilterTouchEventForSecurity&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;))&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; action &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getAction&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; action &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_MASK&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// Handle an initial down.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_DOWN&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#75715e&#34;&gt;// Throw away all previous state when starting a new touch gesture.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// The framework may have dropped the up or cancel event for the previous gesture
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// due to an app switch, ANR, or some other state change.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            cancelAndClearTouchTargets&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            resetTouchState&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// Check for interception.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; intercepted&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_DOWN&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; mFirstTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; disallowIntercept &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mGroupFlags &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; FLAG_DISALLOW_INTERCEPT&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; 0&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(!&lt;/span&gt;disallowIntercept&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                intercepted &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; onInterceptTouchEvent&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setAction&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;action&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;// restore action in case it was changed
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                intercepted &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#75715e&#34;&gt;// There are no touch targets and this action is not an initial down
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// so this view group continues to intercept touches.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            intercepted &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// If intercepted, start normal event dispatch. Also if there is already
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;// a view that is handling the gesture, do normal event dispatch.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;intercepted &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; mFirstTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setTargetAccessibilityFocus&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// Check for cancelation.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; canceled &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; resetCancelNextUpFlag&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_CANCEL&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// Update list of touch targets for pointer down, if needed.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; split &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mGroupFlags &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; FLAG_SPLIT_MOTION_EVENTS&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; 0&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        TouchTarget newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; alreadyDispatchedToNewTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(!&lt;/span&gt;canceled &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!&lt;/span&gt;intercepted&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;

            &lt;span style=&#34;color:#75715e&#34;&gt;// If the event is targeting accessibility focus we give it to the
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// view that has accessibility focus and if it does not handle it
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// we clear the flag and dispatch the event to all children as usual.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// We are looking up the accessibility focused host to avoid keeping
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// state since these events are very rare.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            View childWithAccessibilityFocus &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isTargetAccessibilityFocus&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;?&lt;/span&gt; findChildWithAccessibilityFocus&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_DOWN&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;split &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_POINTER_DOWN&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_HOVER_MOVE&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; actionIndex &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getActionIndex&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;// always 0 for down
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; idBitsToAssign &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; split &lt;span style=&#34;color:#f92672&#34;&gt;?&lt;/span&gt; 1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getPointerId&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;actionIndex&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
                        &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; TouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ALL_POINTER_IDS&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

                &lt;span style=&#34;color:#75715e&#34;&gt;// Clean up earlier touch targets for this pointer id in case they
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                &lt;span style=&#34;color:#75715e&#34;&gt;// have become out of sync.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                removePointersFromTouchTargets&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;idBitsToAssign&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;

                &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; childrenCount &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mChildrenCount&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; childrenCount &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; 0&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;float&lt;/span&gt; x &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getX&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;actionIndex&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;float&lt;/span&gt; y &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getY&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;actionIndex&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                    &lt;span style=&#34;color:#75715e&#34;&gt;// Find a child that can receive the event.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                    &lt;span style=&#34;color:#75715e&#34;&gt;// Scan children from front to back.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; ArrayList&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;View&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; preorderedList &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; buildTouchDispatchChildList&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; customOrder &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; preorderedList &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;
                            &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; isChildrenDrawingOrderEnabled&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; View&lt;span style=&#34;color:#f92672&#34;&gt;[]&lt;/span&gt; children &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mChildren&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; childrenCount &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; 1&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;=&lt;/span&gt; 0&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt; i&lt;span style=&#34;color:#f92672&#34;&gt;--)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; childIndex &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; getAndVerifyPreorderedIndex&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;
                                childrenCount&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; i&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; customOrder&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; View child &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; getAndVerifyPreorderedView&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;
                                preorderedList&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; children&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; childIndex&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;

                        &lt;span style=&#34;color:#75715e&#34;&gt;// If there is a view that has accessibility focus we want it
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                        &lt;span style=&#34;color:#75715e&#34;&gt;// to get the event first and if not handled we will perform a
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                        &lt;span style=&#34;color:#75715e&#34;&gt;// normal dispatch. We may do a double iteration but this is
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                        &lt;span style=&#34;color:#75715e&#34;&gt;// safer given the timeframe.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;childWithAccessibilityFocus &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;childWithAccessibilityFocus &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; child&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                                &lt;span style=&#34;color:#66d9ef&#34;&gt;continue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                            childWithAccessibilityFocus &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                            i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; childrenCount &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; 1&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

                        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(!&lt;/span&gt;child&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;canReceivePointerEvents&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt;
                                &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!&lt;/span&gt;isTransformedTouchPointInView&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;x&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; y&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; child&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;))&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                            ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setTargetAccessibilityFocus&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                            &lt;span style=&#34;color:#66d9ef&#34;&gt;continue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

                        newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; getTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;child&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                            &lt;span style=&#34;color:#75715e&#34;&gt;// Child is already receiving touch within its bounds.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                            &lt;span style=&#34;color:#75715e&#34;&gt;// Give it the new pointer in addition to the ones it is handling.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                            newTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;pointerIdBits&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|=&lt;/span&gt; idBitsToAssign&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                            &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

                        resetCancelNextUpFlag&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;child&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;dispatchTransformedTouchEvent&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; child&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; idBitsToAssign&lt;span style=&#34;color:#f92672&#34;&gt;))&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                            &lt;span style=&#34;color:#75715e&#34;&gt;// Child wants to receive touch within its bounds.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                            mLastTouchDownTime &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getDownTime&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
                            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;preorderedList &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                                &lt;span style=&#34;color:#75715e&#34;&gt;// childIndex points into presorted list, find original index
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                                &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; j &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; 0&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt; j &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; childrenCount&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt; j&lt;span style=&#34;color:#f92672&#34;&gt;++)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                                    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;children&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;childIndex&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; mChildren&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;j&lt;span style=&#34;color:#f92672&#34;&gt;])&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                                        mLastTouchDownIndex &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; j&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                                        &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                                    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                                &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                                mLastTouchDownIndex &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; childIndex&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                            mLastTouchDownX &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getX&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
                            mLastTouchDownY &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getY&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
                            newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; addTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;child&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; idBitsToAssign&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                            alreadyDispatchedToNewTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                            &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

                        &lt;span style=&#34;color:#75715e&#34;&gt;// The accessibility focus didn&amp;#39;t handle the event, so clear
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                        &lt;span style=&#34;color:#75715e&#34;&gt;// the flag and do a normal dispatch to all children.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                        ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setTargetAccessibilityFocus&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;preorderedList &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; preorderedList&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;clear&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

                &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; mFirstTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#75715e&#34;&gt;// Did not find a child to receive the event.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                    &lt;span style=&#34;color:#75715e&#34;&gt;// Assign the pointer to the least recently added target.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                    newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mFirstTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;newTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                        newTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; newTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                    newTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;pointerIdBits&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|=&lt;/span&gt; idBitsToAssign&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// Dispatch to touch targets.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mFirstTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#75715e&#34;&gt;// No touch targets so treat this as an ordinary view.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            handled &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; dispatchTransformedTouchEvent&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; canceled&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt;
                    TouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ALL_POINTER_IDS&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#75715e&#34;&gt;// Dispatch to touch targets, excluding the new touch target if we already
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// dispatched to it.  Cancel touch targets if necessary.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            TouchTarget predecessor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            TouchTarget target &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mFirstTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;target &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; TouchTarget next &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; target&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;alreadyDispatchedToNewTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; target &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; newTouchTarget&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                    handled &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; cancelChild &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; resetCancelNextUpFlag&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;target&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;child&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
                            &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; intercepted&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;dispatchTransformedTouchEvent&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; cancelChild&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt;
                            target&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;child&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; target&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;pointerIdBits&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;))&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                        handled &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;cancelChild&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;predecessor &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                            mFirstTouchTarget &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; next&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                            predecessor&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; next&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                        target&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;recycle&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
                        target &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; next&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                        &lt;span style=&#34;color:#66d9ef&#34;&gt;continue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                predecessor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; target&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                target &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; next&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// Update list of touch targets for pointer up or cancel, if needed.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;canceled
                &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_UP&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_HOVER_MOVE&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            resetTouchState&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;split &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; actionMasked &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; MotionEvent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ACTION_POINTER_UP&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; actionIndex &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getActionIndex&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; idBitsToRemove &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; 1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; ev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getPointerId&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;actionIndex&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            removePointersFromTouchTargets&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;idBitsToRemove&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(!&lt;/span&gt;handled &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; mInputEventConsistencyVerifier &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        mInputEventConsistencyVerifier&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onUnhandledEvent&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ev&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; 1&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; handled&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Intro to Hybrid App</title>
      <link>https://zacash.cn/post/intro-to-hybrid-app/</link>
      <pubDate>Sat, 04 Jul 2020 15:45:14 +0800</pubDate>
      
      <guid>https://zacash.cn/post/intro-to-hybrid-app/</guid>
      <description>&lt;h2 id=&#34;hybrid-app-的几种方案&#34;&gt;Hybrid App 的几种方案&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;PhoneGap/Cordova&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;WebView 作为用户界面，以 Javascript 作为基本逻辑，以及和中间件通信，再由中间件访问底层 API 的方式，进行 App 开发。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;React Native/Weex&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;使用前端技术开发，通过 JSBridge 将 Javascript 代码解析的 Virtual DOM 传递到 Native 并使用原生进行渲染。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Native/H5 混合开发&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在原生的架构基础上，嵌入 WebView 业务逻辑，一般有 Native 和 Web 前端开发人员组成。Native 写好基本的架构以及 API 让 Web 开发人员开发页面以及大部分渲染。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;phonegapcordova&#34;&gt;PhoneGap/Cordova&lt;/h2&gt;
&lt;p&gt;PhoneGap 由 Apache 接管后改名为 Cordova，实际上是一个项目。Cordova 其实不应该称为 Hybrid 方案。因为，它的目标是全面使用前端技术开发移动应用，而不是前端和原生混合使用。不过，这些框架和 React Native 的目标是一致的：使用前端技术开发移动应用，提高工程效率。&lt;/p&gt;
&lt;p&gt;Cordova 让前端技术尽可能多的完成开发工作，只有在前端无法直接调用的原生系统功能方面提供了前端可用的接口。主流的 Cordova 项目都将业务逻辑实现在一个 WebView 中，目标是让开发者使用前端技术就能完成一个应用开发。这种做法需要一个前提——前端技术可以解决移动开发的所有需求。&lt;/p&gt;
&lt;h3 id=&#34;cordova-架构图&#34;&gt;Cordova 架构图&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://user-gold-cdn.xitu.io/2018/7/23/164c7814e247d497?imageView2/0/w/1280/h/960/format/webp/ignore-error/1&#34; alt=&#34;cordova arch&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Web App 是开发人员编写代码的地方，应用以网页的形式呈现，在一个 index.html 的本地页面文件中引用所需要的各种 Web 资源，如 CSS、Javascript、图片和影音文件等。App 的配置保存在 config.xml 文件中。&lt;/li&gt;
&lt;li&gt;WebView 层用来呈现 UI。&lt;/li&gt;
&lt;li&gt;Plugin 主要用于在 Javascript 代码中调用各平台的 native 功能。Cordova 项目已包含一些核心的插件，如电池、摄像头、通讯录等。开发人员也可以自定义插件，其原理就是 Native 获取 Javascript 环境上下文，并直接在上面挂在对象或者方法，&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;cordova-的优缺点&#34;&gt;Cordova 的优缺点&lt;/h3&gt;
&lt;h4 id=&#34;优点&#34;&gt;优点&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;快速构建UI，全 Web 开发一定程度上有利于 Web 前端人员快速开发。&lt;/li&gt;
&lt;li&gt;样式统一，在不同平台可以获得相同的交互和展示。&lt;/li&gt;
&lt;li&gt;便于调试，可以在浏览器上进行调试，工具丰富。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;缺点&#34;&gt;缺点&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;兼容性，部分前端框架或语法在低版本 Android 手机上无法执行。&lt;/li&gt;
&lt;li&gt;功能有局限性，只适用于富UI场景，与底层交互需要做复杂的处理。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;nativeh5-混合开发&#34;&gt;Native/H5 混合开发&lt;/h2&gt;
&lt;h3 id=&#34;原生基础架构-infra&#34;&gt;原生基础架构 Infra&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Hybrid-Navigator，使用 URL 来标识每个页面，在 App 中指明 URL 跳转到此页面。所以需要一个路由表，根据 URL 找到。&lt;/li&gt;
&lt;li&gt;Hybrid-Router，可以传递复杂对象，CRUD 功能。&lt;/li&gt;
&lt;li&gt;Hybrid-Scheme，使用 Scheme 标识 web 调用原生的功能，比如修改 WebView 标题栏和状态栏颜色，获取 user_code 等。&lt;/li&gt;
&lt;li&gt;Hybrid-Container，js 代码运行容器。它其实是一个内嵌浏览器（WebView），Container 需要提供一些必要的原生支持，比如 Cookie，OAuth 授权，图片缓存等。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;nativeh5-技术原理jsbridge&#34;&gt;Native/H5 技术原理——JsBridge&lt;/h3&gt;
&lt;h4 id=&#34;h5-如何调原生方法&#34;&gt;H5 如何调原生方法&lt;/h4&gt;
&lt;p&gt;基于 WebView 的机制和开发的 API，主要有三种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;API 注入，原理就是 Native 获取 Javascript 环境的上下文，并在上面挂载对象或者方法，使 js 可以直接调用。&lt;/li&gt;
&lt;li&gt;WebView 响应 js prompt/console/alert 方法，对应 WebChromeClient 中的 &lt;code&gt;onJsPrompt()&lt;/code&gt;/&lt;code&gt;onJsConsole()&lt;/code&gt;/&lt;code&gt;onJsAlert()&lt;/code&gt; 方法。&lt;/li&gt;
&lt;li&gt;WebView 拦截 URL Scheme，对应 WebViewClient 中的 &lt;code&gt;shouldOverrideUrlLoading()&lt;/code&gt; 方法。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;native-如何调-h5-函数&#34;&gt;Native 如何调 H5 函数&lt;/h4&gt;
&lt;p&gt;原生 WebView 可以直接执行 js 代码&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;iOS:stringByEvaluatingJavaScriptFromString&lt;/p&gt;
&lt;p&gt;&lt;code&gt;webview.stringByEvaluatingJavaScriptFromString(&amp;quot;alert(&#39;NativeCall&#39;)&amp;quot;)&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Android 4.4 以下&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mWebView.loadUrl(&amp;quot;javascript:JSBridge.trigger(&#39;NativeCall&#39;)&amp;quot;)&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Android 4.4+&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;mWebView&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;evaluateJavascript&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;JSBridge.trigger(&amp;#39;NativeCall&amp;#39;)&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; ValueCallback&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;String&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onReceiveValue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;String value&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#75715e&#34;&gt;// js callback
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;定义拦截规则&#34;&gt;定义拦截规则&lt;/h4&gt;
&lt;p&gt;我们根据公司业务会制定一套 URL scheme 规则，比较类似常用的 &lt;code&gt;https://&lt;/code&gt; 或 &lt;code&gt;file:///&lt;/code&gt;，不过我们自定义的 scheme 可以是任意样式，比如：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;zapp://action?param1=xxx&amp;amp;param2=xxx&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;这样定义好的 scheme，h5 通过创建 iframe 方式发送请求。&lt;/p&gt;
&lt;h4 id=&#34;scheme-的拦截&#34;&gt;Scheme 的拦截&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;iOS 上：shouldStartLoadWithRequest&lt;/li&gt;
&lt;li&gt;Android: &lt;code&gt;WebViewClient.shouldOverrideUrlLoading()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;scheme-的回调&#34;&gt;Scheme 的回调&lt;/h4&gt;
&lt;p&gt;一般 Native 拦截 scheme ，处理完成后，调用 Bridge 的 callback 方法。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;mWebView&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;evaluateJavascript&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;JSBridge.trigger(&amp;#39;NativeCall&amp;#39;)&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; ValueCallback&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;String&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onReceiveValue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;String value&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#75715e&#34;&gt;// js callback
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;react-native-实现原理&#34;&gt;React Native 实现原理&lt;/h2&gt;
&lt;p&gt;React Native 并没有运行在浏览器引擎（WebView/V8）中。不像大部分前端框架是简化 DOM 树的处理，React Native 和 DOM 没有关系。React Native 重写了大部分系统 UI 组件，并在框架内处理好了 Javascript 和原生组件之间的调用和通信。开发者可以通过 React 风格的 Javascript 代码使用这些 React Native UI 组件来构建应用的UI。可以认为 React Native 实现了一个渲染引擎，使用 React 作为渲染引擎的编程语言。&lt;/p&gt;
&lt;h2 id=&#34;页面调用方案&#34;&gt;页面调用方案&lt;/h2&gt;
&lt;p&gt;简单的页面跳转，从 MainScreen 跳转到 SecondaryScreen&lt;/p&gt;
&lt;p&gt;Android 中的实现：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;startActivity(Intent(&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;, SecondaryScreen.&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;iOS 中的实现：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-oc&#34; data-lang=&#34;oc&#34;&gt;SecondaryViewController *secondaryViewController = [[SecondaryViewController alloc] init];
[self.navigationController pushViewController:secondViewController animated:YES];
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;随着项目逐渐增大，我们需要做一些模块化的工作。模块化基本的要求是解除模块间的依赖，我们需要一个间接的调用目标页面的方案。&lt;/p&gt;
&lt;h3 id=&#34;openurl-方案&#34;&gt;openURL 方案&lt;/h3&gt;
&lt;p&gt;在这些间接方案中，有很多是基于 iOS 提供的 UIApplicationDelegate 中的用于响应 URL 调用的钩子方法。&lt;/p&gt;
&lt;p&gt;在 iOS 8 中，该方法为：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-oc&#34; data-lang=&#34;oc&#34;&gt;application:openURL:sourceApplication:annotation:
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;iOS 9 中该方法被标记为 Deprecated，并提供了一个替代方法：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-oc&#34; data-lang=&#34;oc&#34;&gt;application:openURL:options:
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我们将这两个方法称为 &lt;code&gt;openURL&lt;/code&gt; 钩子方法。&lt;/p&gt;
&lt;p&gt;如果应用注册了一个 URL scheme。任何第三方应用，以及应用自身对该 URL 的调用，都会调起以上 &lt;code&gt;openURL&lt;/code&gt; 钩子方法。这就提供了一个在应用间通信的方法。同时这也是目前为止，iOS 系统中，应用间通信的唯一方式。&lt;/p&gt;
&lt;h2 id=&#34;react-native&#34;&gt;React Native&lt;/h2&gt;
&lt;p&gt;React Native 需要的技术栈比较特别，比较适合 Web 经验特别丰富，前端工程师特别优秀，但又缺乏优秀的客户端工程师的情况，React Native 是一个快速切入移动应用市场的技术选择。&lt;/p&gt;
&lt;h2 id=&#34;常见问题&#34;&gt;常见问题&lt;/h2&gt;
&lt;h3 id=&#34;内存管理&#34;&gt;内存管理&lt;/h3&gt;
&lt;p&gt;根据 adb shell 查看 app 占用内存信息&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# 查看 app 基本信息&lt;/span&gt;
Zac:Sample Zac$ adb shell ps | grep com.guotai.dazhihui
u0_a674       &lt;span style=&#34;color:#ae81ff&#34;&gt;9858&lt;/span&gt;   &lt;span style=&#34;color:#ae81ff&#34;&gt;669&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2205104&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;268448&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;                   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; S com.guotai.dazhihui
u0_a674      &lt;span style=&#34;color:#ae81ff&#34;&gt;10039&lt;/span&gt;   &lt;span style=&#34;color:#ae81ff&#34;&gt;669&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1973628&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;101852&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;                   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; S com.guotai.dazhihui:remote
u0_a674      &lt;span style=&#34;color:#ae81ff&#34;&gt;10129&lt;/span&gt;   &lt;span style=&#34;color:#ae81ff&#34;&gt;669&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1988412&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;113528&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;                   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; S com.guotai.dazhihui:pushservice

&lt;span style=&#34;color:#75715e&#34;&gt;# 未开启 WebView 时的内存占用信息&lt;/span&gt;
Zac:Sample Zac$ adb shell dumpsys meminfo com.guotai.dazhihui
Applications Memory Usage &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;in Kilobytes&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;:
...
App Summary
                       Pss&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;KB&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
                        ------
           Java Heap:    &lt;span style=&#34;color:#ae81ff&#34;&gt;21264&lt;/span&gt;
         Native Heap:    &lt;span style=&#34;color:#ae81ff&#34;&gt;35988&lt;/span&gt;
                Code:    &lt;span style=&#34;color:#ae81ff&#34;&gt;15648&lt;/span&gt;
               Stack:       &lt;span style=&#34;color:#ae81ff&#34;&gt;52&lt;/span&gt;
            Graphics:    &lt;span style=&#34;color:#ae81ff&#34;&gt;72324&lt;/span&gt;
       Private Other:     &lt;span style=&#34;color:#ae81ff&#34;&gt;4528&lt;/span&gt;
              System:    &lt;span style=&#34;color:#ae81ff&#34;&gt;18578&lt;/span&gt;

               TOTAL:   &lt;span style=&#34;color:#ae81ff&#34;&gt;168382&lt;/span&gt;       TOTAL SWAP PSS:      &lt;span style=&#34;color:#ae81ff&#34;&gt;420&lt;/span&gt;
...

&lt;span style=&#34;color:#75715e&#34;&gt;# 开启 WebView 之后的内存占用&lt;/span&gt;
...
App Summary
                       Pss&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;KB&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
                        ------
           Java Heap:    &lt;span style=&#34;color:#ae81ff&#34;&gt;25136&lt;/span&gt;
         Native Heap:    &lt;span style=&#34;color:#ae81ff&#34;&gt;55420&lt;/span&gt;
                Code:    &lt;span style=&#34;color:#ae81ff&#34;&gt;51480&lt;/span&gt;
               Stack:       &lt;span style=&#34;color:#ae81ff&#34;&gt;52&lt;/span&gt;
            Graphics:    &lt;span style=&#34;color:#ae81ff&#34;&gt;74704&lt;/span&gt;
       Private Other:     &lt;span style=&#34;color:#ae81ff&#34;&gt;6244&lt;/span&gt;
              System:    &lt;span style=&#34;color:#ae81ff&#34;&gt;29544&lt;/span&gt;

               TOTAL:   &lt;span style=&#34;color:#ae81ff&#34;&gt;242580&lt;/span&gt;       TOTAL SWAP PSS:      &lt;span style=&#34;color:#ae81ff&#34;&gt;376&lt;/span&gt;

内存
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Intro to Service</title>
      <link>https://zacash.cn/post/intro-to-service/</link>
      <pubDate>Sat, 04 Jul 2020 11:08:11 +0800</pubDate>
      
      <guid>https://zacash.cn/post/intro-to-service/</guid>
      <description>&lt;h2 id=&#34;查看进程基本信息&#34;&gt;查看进程基本信息&lt;/h2&gt;
&lt;p&gt;使用 &lt;code&gt;adb shell ps|grep com.tencent.mobileqq&lt;/code&gt; 可以查看 QQ 应用进程相关的基本信息&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;Zac:tivi Zac$ adb shell ps | grep com.tencent.mobileqq
&lt;span style=&#34;color:#75715e&#34;&gt;# curr_user   pid                                                 process name&lt;/span&gt;
u0_a163       &lt;span style=&#34;color:#ae81ff&#34;&gt;6779&lt;/span&gt;   &lt;span style=&#34;color:#ae81ff&#34;&gt;669&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1638852&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;27152&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;                   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; S com.tencent.mobileqq:MSF
u0_a163      &lt;span style=&#34;color:#ae81ff&#34;&gt;22001&lt;/span&gt;   &lt;span style=&#34;color:#ae81ff&#34;&gt;669&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1915536&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;224004&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;                   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; S com.tencent.mobileqq
u0_a163      &lt;span style=&#34;color:#ae81ff&#34;&gt;27829&lt;/span&gt;   &lt;span style=&#34;color:#ae81ff&#34;&gt;669&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1670960&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;236668&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;                   &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; S com.tencent.mobileqq:qzone
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;进程的划分&#34;&gt;进程的划分&lt;/h2&gt;
&lt;p&gt;为了确定在内存不足时 kill 哪些进程，Android 会依据进程中运行的组件（Activity/Service/BroadcastReceiver）和这些组件的状态，划分每个进程的重要层次结构（importance hierarchy）。这些进程按重要性排序:&lt;/p&gt;
&lt;h3 id=&#34;前台进程foreground-process&#34;&gt;前台进程（foreground process）&lt;/h3&gt;
&lt;p&gt;前台进程是用户当前正在执行的操作所必须的进程，应用进程内的组件可能以不同形式让其处于前台：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Activity 处于用户正在交互状态（onResume() 方法已调用）&lt;/li&gt;
&lt;li&gt;BroadcastReceiver 正在运行（BroadcastReceiver.onReceive() 方法正在执行）&lt;/li&gt;
&lt;li&gt;Service 的回调正在执行代码（Service.onCreate(), Service.onStart(), Service.onDestroy()）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Android 系统中只有少数这样的进程，而且只有在内存太低且无法运行这些进程时，才会 kill 这些进程。&lt;/p&gt;
&lt;h3 id=&#34;可见进程visible-process&#34;&gt;可见进程（visible process）&lt;/h3&gt;
&lt;p&gt;可见进程正在执行用户意识到的工作，因此 kill 这种进程可能对用户体验产生负面影响。这种进程的组件可以有如下形式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Activity 可见但并不处于前台（onPause() 方法已调用），常见的例子比如在当前 Activity 展示一个弹窗。&lt;/li&gt;
&lt;li&gt;使用 &lt;em&gt;Service.startForeground()&lt;/em&gt; 方法启动的前台服务。&lt;/li&gt;
&lt;li&gt;特定功能的服务，如动态壁纸，输入法服务等。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;服务进程service-process&#34;&gt;服务进程（service process）&lt;/h3&gt;
&lt;p&gt;服务进程是持有由 &lt;em&gt;Service.startService()&lt;/em&gt; 方法启动的 Service 进程。尽管这些进程用户并不是直接可见，但它做的通常是用户关心的事情，如后台上传/下载网络数据。&lt;/p&gt;
&lt;p&gt;长时间(&amp;gt; 30min)运行的服务可能会被降级，即下面介绍的缓存列表，这有助于避免长时间服务占用过多系统资源（如内存泄漏）。&lt;/p&gt;
&lt;h3 id=&#34;缓存进程cached-process&#34;&gt;缓存进程（cached process）&lt;/h3&gt;
&lt;p&gt;缓存进程是当前不需要的进程，当别的地方需要使用内存时，系统会优先 kill 掉这种进程。在一个运行良好的系统通常会有多个可用的缓存进程，并根据需要定期删除最老的进程。&lt;/p&gt;
&lt;p&gt;这些进程通常包含一个或多个当前用户不可见的 Activity 实例（已调用 onStop() 方法），只要 App 正确的实现 Activity 对应的生命周期方法，当系统终止此类进程时，它不会影响用户返回该 App 时的体验（在新进程中重新创建关联 Activity 时，它可以恢复之前保存的状态）。&lt;/p&gt;
&lt;p&gt;这些进程会被记录在缓存列表中，该列表的进程终止策略依赖平台的具体实现，原则上优先保留重要进程。其他的策略包括限制最大进程数量，以及限制进程运行时间等。&lt;/p&gt;
&lt;h2 id=&#34;终止进程low-memory-killer-daemon-lmkd&#34;&gt;终止进程（Low Memory Killer Daemon, lmkd）&lt;/h2&gt;
&lt;p&gt;Android lmkd 进程监控正在运行的系统内存状态，并通过杀死最不重要进程（least essential processes）来应对高内存压力，以使系统运行在可接收的水平。&lt;/p&gt;
&lt;h3 id=&#34;查看手机的内存阀值&#34;&gt;查看手机的内存阀值&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# root permission need&lt;/span&gt;
adb shell cat /sys/module/lowmemorykiller/parameters/minfree
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;adj&#34;&gt;ADJ&lt;/h3&gt;
&lt;p&gt;Adj 定义在 &lt;a href=&#34;https://android.googlesource.com/platform/frameworks/base/+/be4e6aa/services/java/com/android/server/am/ProcessList.java&#34;&gt;frameworks/&amp;hellip;/services/java/com/android/server/am/ProcessList.java&lt;/a&gt; 中，&lt;code&gt;oom_adj&lt;/code&gt; 表示进程的 adj 值，一般在 -17～16 间取值，adj 值越大，优先级越低，&lt;code&gt;adj &amp;lt; 0&lt;/code&gt;的进程都是系统进程。&lt;code&gt;adj = 0&lt;/code&gt; 表示进程处于前台。&lt;/p&gt;
&lt;p&gt;通过命令查看 &lt;code&gt;pid = 4061&lt;/code&gt; 进程的 adj 值：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# App 处于前台时&lt;/span&gt;
adb shell cat /proc/4061/oom_adj
&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# App 处于后台时&lt;/span&gt;
Zac:tivi Zac$ adb shell cat /proc/4061/oom_adj
&lt;span style=&#34;color:#ae81ff&#34;&gt;11&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;进程终止策略&#34;&gt;进程终止策略&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;ProcessList&lt;/code&gt; 中定义的 &lt;code&gt;oomAdj&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// These are the various interesting memory levels that we will give to
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// the OOM killer.  Note that the OOM killer only supports 6 slots, so we
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// can&amp;#39;t give it a different value for every possible kind of process.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[]&lt;/span&gt; mOomAdj &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    FOREGROUND_APP_ADJ&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; VISIBLE_APP_ADJ&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; PERCEPTIBLE_APP_ADJ&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt;
    BACKUP_APP_ADJ&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; CACHED_APP_MIN_ADJ&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; CACHED_APP_MAX_ADJ
&lt;span style=&#34;color:#f92672&#34;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在系统内存不足时，依次从 &lt;code&gt;CACHED_APP_MAX_ADJ -&amp;gt; .. -&amp;gt;  FOREGROUND_APP_ADJ&lt;/code&gt; 终止进程。&lt;/p&gt;
&lt;p&gt;看完进程我们再看看服务&lt;/p&gt;
&lt;h2 id=&#34;service-的生命周期&#34;&gt;Service 的生命周期&lt;/h2&gt;
&lt;p&gt;Service 的生命周期比 Activity 的要简单很多。但关注其如何创建销毁反而更加重要，因为服务可以在用户没有意识到的情况下在后台运行。&lt;/p&gt;
&lt;p&gt;Service 的生命周期可以遵循两条不同的途径：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;启动服务
该服务在其他组件中调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService()&lt;/a&gt; 时创建，然后无限运行，必须通过 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#stopSelf()&#34;&gt;stopSelf()&lt;/a&gt; 来自行停止运行。此外，其他组件也可以通过调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)&#34;&gt;stopService()&lt;/a&gt; 来停止服务。服务停止后，系统会将其销毁。&lt;/li&gt;
&lt;li&gt;绑定服务
该服务在另一个组件（客户端）调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)&#34;&gt;bindService()&lt;/a&gt; 时创建。然后客户端通过 &lt;a href=&#34;https://developer.android.com/reference/android/os/IBinder.html&#34;&gt;IBinder&lt;/a&gt; 接口与 Service 进行进行通信。客户端可以通过调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#unbindService(android.content.ServiceConnection)&#34;&gt;unbindService()&lt;/a&gt; 来关闭连接。多个客户端可以绑定到相同服务，而且当所有绑定全部取消后，系统会销毁该服务。（不必调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)&#34;&gt;stopService()&lt;/a&gt; 来停止服务)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这两种状态并非完全独立，实际上是 &lt;strong&gt;可以共存&lt;/strong&gt; 的。例如可以使用 Intent 调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService()&lt;/a&gt; 启动后台音乐服务。随后，可能用户需要加入控制播放器获取有关播放歌曲信息时，Activity 可以通过调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)&#34;&gt;bindService()&lt;/a&gt; 绑定到该服务。这种情况下，除非所有客户端都取消绑定，否则 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)&#34;&gt;stopService()&lt;/a&gt; 或 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#stopSelf()&#34;&gt;stopSelf()&lt;/a&gt; 不会停止该服务。&lt;/p&gt;
&lt;h2 id=&#34;实现-service-生命周期回调&#34;&gt;实现 Service 生命周期回调&lt;/h2&gt;
&lt;p&gt;与 Activity 类似，Service 也拥有生命周期回调方法，可以通过实现这些方法来监控Service 状态的变化：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; android.app.Service&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; android.content.Intent&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; android.os.IBinder&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; android.support.annotation.Nullable&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * Created by Zac on 2017/5/23.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;

&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;SampleService&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;extends&lt;/span&gt; Service &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; CHANNEL_NAME &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   * 表示服务被 kill 之后的行为
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; mStartMode&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   * 表示绑定该服务的 client
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; IBinder mBinder&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   * 表示是否允许重新绑定
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; mAllowReind&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onCreate&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// 服务被创建
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onCreate&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    startForeground&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   * 创建定义的通知
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; Notification&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Builder&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;getNotification&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;String title&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; String body&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; Notification&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Builder&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;appContext&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; CHANNEL_NAME&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setContentTitle&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;title&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setContentText&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;body&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setSmallIcon&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;smallIcon&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setAutoCancel&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Nullable&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; IBinder &lt;span style=&#34;color:#a6e22e&#34;&gt;onBind&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Intent intent&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// 客户端通过 bindService() 方法绑定服务
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; mBinder&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onStartCommand&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Intent intent&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; flags&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; startId&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// 组件调用 startService() 方法启动服务
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; mStartMode&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onUnbind&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Intent intent&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// 所有绑定的客户端都已调用 unbindService() 方法解绑
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; mAllowReind&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onRebind&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Intent intent&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// 客户端在onUnbind() 方法回调之后，调用 bindService() 方法绑定服务
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onRebind&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;intent&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onDestroy&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// 服务不再被使用并被销毁
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onDestroy&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;http://upload-images.jianshu.io/upload_images/1256396-2b2f6bb1c5e9f4c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&#34; alt=&#34;service_lifecycle.png&#34;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;服务的生命周期，左边显示了使用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService()&lt;/a&gt; 所创建的服务的生命周期，右边显示了 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)&#34;&gt;bindService()&lt;/a&gt; 所创建的服务的生命周期。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;通过这些方法，我们可以监控 Service 生命周期的两个部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Service 的 &lt;strong&gt;整个生命周期&lt;/strong&gt; 从调用 onCreate() 开始，到 onDestroy() 返回时结束。与 Activity 类似，Service 也在 onCreate() 中完成初始设置，并在 onDestroy() 中释放所有剩余资源。例如，音乐播放器可以在 onCreate() 中创建播放音乐的线程，然后在 onDestroy() 中停止该线程。无论 Service 是通过 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService()&lt;/a&gt; 还是 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)&#34;&gt;bindService()&lt;/a&gt; 方法创建，都会调用 onCreate() 和 onDestroy() 方法。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Service 的 &lt;strong&gt;有效生命周期&lt;/strong&gt; 从调用 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#onStartCommand(android.content.Intent,int,int)&#34;&gt;onStartCommand()&lt;/a&gt; 或 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#onBind(android.content.Intent)&#34;&gt;onBind()&lt;/a&gt; 方法开始。每种方法均有 Intent 对象，该对象分别来自 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService()&lt;/a&gt; 和 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)&#34;&gt;bindService()&lt;/a&gt; 。对于启动服务，有效生命周期和整个生命周期同时结束。对于绑定服务，有效生命周期在 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#onUnbind(android.content.Intent)&#34;&gt;onUnbind()&lt;/a&gt; 返回时结束。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;尽管启动服务是通过 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#stopSelf()&#34;&gt;stopSelf()&lt;/a&gt; 或 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#stopService(android.content.Intent)&#34;&gt;stopService()&lt;/a&gt; 来停止，但该服务没有相应的回调（没有 onStop() 回调）。因此，除非是绑定服务，否则在服务停止时，系统会将其在 onDestroy() 中销毁。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;上图说明了服务的典型回调方法。尽管该图分开介绍通过 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService()&lt;/a&gt; 创建的服务和通过 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)&#34;&gt;bindService()&lt;/a&gt; 创建的服务，但是不管启动方式如何，任何服务均有可能允许客户端与其绑定。因此，最初使用 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#onStartCommand(android.content.Intent,int,int)&#34;&gt;onStartCommand()&lt;/a&gt;（客户端调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService()&lt;/a&gt; ）启动的服务仍有可能接收 &lt;a href=&#34;https://developer.android.com/reference/android/app/Service.html#onBind(android.content.Intent)&#34;&gt;onBind()&lt;/a&gt; 的调用（客户端调用 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent,android.content.ServiceConnection,int)&#34;&gt;bindService()&lt;/a&gt; 时）。&lt;/p&gt;
&lt;h2 id=&#34;service-使用时需要注意的问题&#34;&gt;Service 使用时需要注意的问题&lt;/h2&gt;
&lt;h3 id=&#34;何时使用-bounded-service-和-unbounded-server&#34;&gt;何时使用 Bounded service 和 Unbounded server&lt;/h3&gt;
&lt;p&gt;官方文档在 &lt;a href=&#34;https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)&#34;&gt;startService&lt;/a&gt; 有描述：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Note: Each call to startService() results in significant work done by the system to manage service lifecycle surrounding the processing of the intent, which can take multiple milliseconds of CPU time. Due to this cost, startService() should not be used for frequent intent delivery to a service, and only for scheduling significant work. Use bound services for high frequency calls.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;大意是指 &lt;code&gt;startService()&lt;/code&gt; 方法开销比较大，因此在高频次调用服务的场景，最好使用 Bounded service，Unbounded service 仅用于安排重要工作。&lt;/p&gt;
&lt;h3 id=&#34;android-o-以上报-illegalstateexception&#34;&gt;Android O 以上报 IllegalStateException&lt;/h3&gt;
&lt;p&gt;Android O 加强了后台执行的限制，App 处于后台时不允许通过 &lt;code&gt;startService()&lt;/code&gt; 的形式启动服务，只能通过 &lt;code&gt;startForegroundService()&lt;/code&gt; 方法启动服务，而且 App 必须在创建服务后5s内调用该服务的 &lt;code&gt;startForeground()&lt;/code&gt; 方法。具体的实现如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt;(Build.VERSION.SDK_INT &amp;gt;= Build.VERSION_CODES.O) {
  startForegroundService(new Intent(MainActivity.&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;, SampleService.&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;));
}&lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;{
  startService(new Intent(MainActivity.&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;, SampleService.&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt;));
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Java Basic</title>
      <link>https://zacash.cn/post/java-basic/</link>
      <pubDate>Fri, 03 Jul 2020 09:28:31 +0800</pubDate>
      
      <guid>https://zacash.cn/post/java-basic/</guid>
      <description>&lt;p&gt;🌟答案的组织策略：知道是什么，知道为什么，知道怎么用&lt;/p&gt;
&lt;h2 id=&#34;0jdk-和-jre-有什么区别&#34;&gt;0.JDK 和 JRE 有什么区别？&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;JDK 包含 JRE，同时还包含编译 Java 源码的编译器 javac，还包含了很多 Java 程序调试和分析的工具。&lt;/li&gt;
&lt;li&gt;加分项：除了 javac 还了解哪些命令行工具，它们的用途是什么？
&lt;ul&gt;
&lt;li&gt;jcmd：综合工具&lt;/li&gt;
&lt;li&gt;jps：虚拟机进程状况工具&lt;/li&gt;
&lt;li&gt;jinfo：虚拟机配置信息工具&lt;/li&gt;
&lt;li&gt;jstat：虚拟机统计信息监视工具&lt;/li&gt;
&lt;li&gt;jmap：Java 内存映像工具&lt;/li&gt;
&lt;li&gt;jhat：虚拟机堆转储快照分析工具&lt;/li&gt;
&lt;li&gt;jstack：Java 堆栈追踪工具&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;加分项jstat 用过吗，有哪些参数？
&lt;ul&gt;
&lt;li&gt;-class：监视类装载、卸载数量、总空间和类装载所耗费的时间&lt;/li&gt;
&lt;li&gt;-gc：监视 Java 堆的状况，包括 Eden 区，两个 survior 区，老年代、永久代等的容量，已用空间、GC 时间合计等统计&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;1equals-和--的差别&#34;&gt;1.equals 和 == 的差别？&lt;/h2&gt;
&lt;p&gt;两者都是判断等价性，区别要从入参类型来看：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;对于基本类型，他们是比较值是否相等&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;对于引用类型，他们是判断引用的是否为同一对象&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;考察点：equals 的概念&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;🌟实际要求：平时对源码的深挖意识即技术钻研和&lt;strong&gt;批判性思维&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;考察目的：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;基础知识的扎实程度&lt;/li&gt;
&lt;li&gt;候选人对技术的热情&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;2java-中操作字符串有那些类它们之间有什么区别&#34;&gt;2.Java 中操作字符串有那些类？它们之间有什么区别？&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;主要有：String，StringBuilder，StringBuffer&lt;/li&gt;
&lt;li&gt;区别：StringBuffer 和 StringBuilder 都继承自 AbstractStringBuilder，StringBuffer 具备线程安全性
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;加分项&lt;/strong&gt;：String 源码分析
&lt;ul&gt;
&lt;li&gt;String 是 &lt;em&gt;final&lt;/em&gt; 关键字修饰 -&amp;gt; 对象的值不可变 -&amp;gt; 每次操作都会生成新的对象&lt;/li&gt;
&lt;li&gt;StringBuffer 和 StringBuilder 对象的值可变，但拼接字符串开销比较小&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;加分项&lt;/strong&gt;：StringBuffer 线程安全性分析（查源码、找 synchronized、线程锁）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;使用场景：并发必选 StringBuffer，迭代必选 StringBuilder，普通场景选 String，避免中途不必要的类型转换开销&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;3hashmaphashtabletreemap-有什么区别&#34;&gt;3.HashMap、HashTable、TreeMap 有什么区别？&lt;/h2&gt;
&lt;p&gt;是什么：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;上面3种数据结构都是最常见的 Map 接口的实现，是以 key-value 的形式存储和操作数据的容器类型。&lt;/li&gt;
&lt;li&gt;HashTable 是 Java 类库提供的一个 hash 实现，本身是同步的，不支持 null key 和 null value，由于同步性能开销，所以已经很少推荐使用了。&lt;/li&gt;
&lt;li&gt;HashMap 是应用广泛的哈希表实现，行为上大致与 HashTable 一致，主要区别在于 HashMap 不是同步的，支持 null key 和 null value 等。通常情况下，HashMap 进行 get 和 put 操作可以达到&lt;strong&gt;常数时间的性能&lt;/strong&gt;。所以大部分利用键值对存取场景的首选。&lt;/li&gt;
&lt;li&gt;TreeMap 则是基于红黑树的一种提供顺序访问的 Map，它的 get、put、remove 之类的操作都是 O(logn) 时间复杂度，具体顺序由可以指定的 Comparator 来决定，后者根据键的自然顺序来判断。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;4内部类和静态嵌套类&#34;&gt;4.内部类和静态嵌套类&lt;/h2&gt;
&lt;h3 id=&#34;inner-class-vs-static-nested-class&#34;&gt;Inner class vs. Static nested class&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;OuterClass&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;StaticNestedClass&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;InnerClass&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;嵌套类（Nested class）可以分为两类：静态和非静态。声明为静态的嵌套类称为静态嵌套类（static nested classes）。非静态嵌套类称为内部类（inner classes）。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;嵌套类是其封闭类（enclosing class）的成员。内部类可以访问封闭类的其他成员，即使它们被声明为私有的可以访问。静态嵌套类无权访问封闭类的其他成员。作为 OuterClass 的成员，嵌套类可以声明为 &lt;em&gt;private&lt;/em&gt;, &lt;em&gt;public&lt;/em&gt;, &lt;em&gt;protected&lt;/em&gt; 或 &lt;em&gt;package private&lt;/em&gt;.&lt;/p&gt;
&lt;h3 id=&#34;why-use-nested-classes&#34;&gt;Why Use Nested Classes&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;这是一种对仅在一个地方使用的类进行逻辑分组的方法&lt;/p&gt;
&lt;p&gt;如果一个类B仅对其他一个类A有用，那么将B嵌入类A将更合乎逻辑，嵌套将使 package 更精简。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;增加封装&lt;/p&gt;
&lt;p&gt;对于同一层级的类A和类B，如果类B需要访问类A的成员，通常情况需要实例化A再调用A的成员。通过将B封装到A内，A的成员可以声明为 &lt;em&gt;private&lt;/em&gt;，同时B可以调用A的成员。此外B对外界完全隐藏。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;可以增加代码可读性，便于维护&lt;/p&gt;
&lt;p&gt;嵌套类可以使它更靠近使用的位置。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;静态嵌套类&#34;&gt;静态嵌套类&lt;/h3&gt;
&lt;p&gt;与类的方法和变量一样，静态嵌套类与外部类相关联。与静态方法一样，静态嵌套类不能直接引用封闭类中定义的实例变量或方法：它只能通过对象的引用来使用它们。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;静态嵌套类和它外部类的实例成员进行交互，就像对其他 top-level 类一样。实际上，静态嵌套类在行为上是顶级类，为了包装方便（for packaging convenience），该顶级类已嵌套在另一个顶级类中。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;创建静态嵌套类通过：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;OuterClass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;StaticNestedClass&lt;/span&gt; sKlass &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; OuterClass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;StaticNestedClass&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;内部类&#34;&gt;内部类&lt;/h3&gt;
&lt;p&gt;和实例方法及变量一样，内部类与其所在类的实例相关联，并且可以直接访问该对象的方法和字段。另外，由于内部类与实例相关联，因此它本身不能定义任何静态成员。&lt;/p&gt;
&lt;p&gt;内部类的实例只能存在于外部类实例中，且可以直接访问其外部类实例的方法和字段。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;OuterClass outer &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; OuterClass&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;// Instantiate inner class
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;OuterClass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;InnerClass&lt;/span&gt; inner &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; outer&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;InnerClass&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;// Instantiate static nested class
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;OuterClass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;NestedClass&lt;/span&gt; nested &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; OuterClass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;NestedClass&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;局部内部类和匿名内部类&#34;&gt;局部内部类和匿名内部类&lt;/h4&gt;
&lt;p&gt;局部内部类声明在别的类的实例方法内，匿名内部类与局部内部类相似，但写法是返回一次性对象的表达式。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;AnonymousClasses&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;HelloWorld&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;greet&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;greetSomeone&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;String someone&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sayHello&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#75715e&#34;&gt;// Local inner class
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;EnglishGreeting&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;implements&lt;/span&gt; HelloWorld &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            String name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;world&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;greet&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                greetSomeone&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;world&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;greetSomeone&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;String someone&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; someone&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                System&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;out&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Hello &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; name&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        HelloWorld englishGreeting &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; EnglishGreeting&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// Anonymous class
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        HelloWorld frenchGreeting &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; HelloWorld&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            String name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;tout le monde&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;greet&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                greetSomeone&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;tout le monde&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;greetSomeone&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;String someone&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; someone&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                System&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;out&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Salut &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; name&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;};&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;序列化&#34;&gt;序列化&lt;/h3&gt;
&lt;p&gt;强烈不建议对内部类，包括本地和匿名类进行序列化。当 Java 编译器编译某些构造时，它将创建&lt;a href=&#34;https://docs.oracle.com/javase/tutorial/reflect/member/methodparameterreflection.html#implcit_and_synthetic&#34;&gt;合成构造&lt;/a&gt;（synthetic constructs）。这些是类、方法、字段和其他在源码中没有对应构造方法的构造。合成构造可以使 Java 编译器无需更改 JVM 即可实现新的 Java 语言功能。但是，合成构造在不同的 Java 编译器中的实现可能有所不同，这意味着 .class 文件在不同的实现中也可能有所不同。因此，如果序列化一个内部类，然后使用其他 JRE 实现对其进行反序列化，则可能出现兼容性问题。&lt;/p&gt;
&lt;h2 id=&#34;5referenceref&#34;&gt;5.&lt;a href=&#34;https://community.oracle.com/blogs/enicholas/2006/05/04/understanding-weak-references&#34;&gt;Reference&lt;/a&gt;&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Package java.lang.ref 描述：
提供引用-对象类，该类支持与&lt;em&gt;垃圾回收器进行有限程度的交互&lt;/em&gt;。程序可以使用引用对象来维护对某个对象的引用，这样垃圾回收器可以收集后者的对象。垃圾回收器在确定给定对象的可达性更改后会通知程序。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;引用对象封装了对某个其他对象的引用，因此该引用本身可以像其他任何对象一样进行检查和操作。引用对象提供三种类型，引用依次减弱：soft, weak, 和 phantom，每种类型都对应不同级别的可达性。软引用用于实现内存敏感型缓存**（Android SDK 不建议这样做）**，弱引用用于实现规范化映射，这些映射不会阻止回收其键或值。虚引用用于安排比 Java 终止机制更灵活的事前清理行动。&lt;/p&gt;
&lt;h3 id=&#34;strongreference&#34;&gt;StrongReference&lt;/h3&gt;
&lt;p&gt;Strong 是描述它们如何与 garbage collector 进行交互的。如果一个对象通过一系列强引用访问（强可达性），那个该对象不符合垃圾回收的条件。&lt;/p&gt;
&lt;h3 id=&#34;softreference&#34;&gt;SoftReference&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;在虚拟机引发 OutOfMemoryError 之前，确保清除所有软引用的对象。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;不建议使用软引用做缓存&lt;/strong&gt;，运行时并没有足够的信息确定哪些引用需要保留，哪些需要清除，引用对象清除太早造成不必要的工作，引用清除太晚造成浪费内存。&lt;/li&gt;
&lt;li&gt;大多数 App 需要使用 LruCache 取代软引用。LruCache 具有有效的逐出策略，并允许用户调整分配的内存量。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;weakreference&#34;&gt;WeakReference&lt;/h3&gt;
&lt;p&gt;弱引用可以利用垃圾回收器的能力来确定可达性，因此我们不必自己做。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Essential Design Pattern in Android</title>
      <link>https://zacash.cn/post/design-pattern-in-android/</link>
      <pubDate>Sat, 20 Jun 2020 20:22:10 +0800</pubDate>
      
      <guid>https://zacash.cn/post/design-pattern-in-android/</guid>
      <description>&lt;h2 id=&#34;什么是设计模式&#34;&gt;什么是设计模式&lt;/h2&gt;
&lt;p&gt;设计模式的&lt;a href=&#34;https://en.wikipedia.org/wiki/Software_design_pattern&#34;&gt;经典解释&lt;/a&gt;：软件工程中，设计模式是针对软件设计中给定上下文的常见问题的&lt;strong&gt;通用、可复用的解决方案&lt;/strong&gt;。设计模式并非可以直接转换为源码或机器码的最终设计。相反，它是可以在不同场景下使用的解决问题的描述或模版。设计模式是程序员在设计 App 或系统时解决常见问题的最佳实践。&lt;/p&gt;
&lt;p&gt;面向对象的设计模式通常展示了类和对象之间的关系和交互，而不是指定 App 的类或对象。&lt;/p&gt;
&lt;p&gt;设计模式可以看作是一种编程的结构化方法，介于编程范式和具体算法之间。&lt;/p&gt;
&lt;p&gt;设计模式根据其解决的问题分为三个类别：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;创造型模式（Creational Patterns）：提供创建类，对象的方法（Singleton, Dependency Inject, Builder等）。&lt;/li&gt;
&lt;li&gt;结构型模式（Structural Patterns）：提供对象和类之间组合的方法（Composite, Bridge, Adapter 等）。&lt;/li&gt;
&lt;li&gt;行为型模式（Bahavioral Patterns）：提供对象和类之间相互交流的方法（Command, Observer, Strategy 等）。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;创造型模式&#34;&gt;创造型模式&lt;/h2&gt;
&lt;p&gt;当我们用最基本的形式创建创建对象可能导致设计问题，或增加设计的复杂性。创造型设计模式通过&lt;strong&gt;控制对象的创建方式&lt;/strong&gt;来解决这种问题。&lt;/p&gt;
&lt;p&gt;Android 常用的创造型模式：&lt;/p&gt;
&lt;h3 id=&#34;builder&#34;&gt;Builder&lt;/h3&gt;
&lt;p&gt;Builder 模式主要解决创建复杂对象过程中遇到的问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;类如何创建复杂对象不同的表现形式(different presentations)&lt;/li&gt;
&lt;li&gt;如何简化包含创建复杂对象的类&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Builder 模式在 Android 中常见的应用是 AlertDialog 的创建过程：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;AlertDialog.Builder(context)
 .setTitle(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Builder Sample&amp;#34;&lt;/span&gt;)
 .setMessage(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Builder Nessage&amp;#34;&lt;/span&gt;)
 .setNegativeButton(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Cancel&amp;#34;&lt;/span&gt;, {_,_ -&amp;gt; })
 .setPositiveButton(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;OK&amp;#34;&lt;/span&gt;, {_, _ -&amp;gt; })
 .show()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Builder 模式通过这种方式解决问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;将复杂对象的各个部分的创建(creating)和组装(assembling)封装在一个独立的 Builder 对象中。&lt;/li&gt;
&lt;li&gt;类将对象的创建委托给 Builder 对象，而不是直接创建。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;dependency-injection&#34;&gt;Dependency injection&lt;/h3&gt;
&lt;p&gt;依赖注入（Dependency injection, 简称 Di）通常表示某个对象接收(receives)它依赖的对象(objects)的技术，这些依赖的对象称为依赖项(dependencies)。在典型的使用关系中，接收者被称为客户端（client），传递的对象被称为服务（service）。将服务传递给客户端的代码可能有很多种，被称为注入器（injector）, 注入器提供给客户端需要使用哪些服务。注入(injection)是指将依赖项（服务）传递给使用依赖项的对象（客户端）。&lt;/p&gt;
&lt;p&gt;依赖注入的基本要求是将服务传递给客户端而不是让客户端创建或找到该服务。客户端不需要了解注入器，注入器实现构造服务然后将服务注入（传递）到客户端，客户端仅需要了解如何使用该服务。依赖注入的意图是实现对象构造和使用的分离，这可以提高代码的复用和可读性。&lt;/p&gt;
&lt;p&gt;依赖注入是&lt;a href=&#34;https://en.wikipedia.org/wiki/Inversion_of_control&#34;&gt;控制反转&lt;/a&gt;（inversion of control, 简称 IoC）的一种技术形式，其他遵循控制反转原则的还有回调（callbacks），调度器（schedulers）等。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Top 10 Kotlin Questions in StackOverflow</title>
      <link>https://zacash.cn/post/top-10-kotlin-questions/</link>
      <pubDate>Fri, 19 Jun 2020 22:03:29 +0800</pubDate>
      
      <guid>https://zacash.cn/post/top-10-kotlin-questions/</guid>
      <description>&lt;h4 id=&#34;intarray-vs-arrayint&#34;&gt;IntArray vs. &lt;code&gt;Array&amp;lt;Int&amp;gt;&lt;/code&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;In java code&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;IntArray: int[]&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Array&amp;lt;Int&amp;gt;&lt;/code&gt;: Integer[]&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Create method:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;IntArray:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; intArray : IntArray = intArrayOf(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Array&amp;lt;Int&amp;gt;&lt;/code&gt;:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; arrayOfInts : Array&amp;lt;Int&amp;gt; = arrayOf(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;iterable-vs-sequence&#34;&gt;Iterable vs. Sequence&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Usage&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Iterable:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;getPeople()
.filter { it.age &amp;gt;= &lt;span style=&#34;color:#ae81ff&#34;&gt;18&lt;/span&gt; }
.map { it.name }
.take(&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Sequence: start with &lt;code&gt;asSequence()&lt;/code&gt; and end with &lt;code&gt;toList()&lt;/code&gt; or &lt;code&gt;toSet()&lt;/code&gt;&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;getPeople().asSequence()
.filter { it.age &amp;gt;= &lt;span style=&#34;color:#ae81ff&#34;&gt;18&lt;/span&gt; }
.map { it.name }
.take(&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)
.toList()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Use for&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Iterable: use for small collections by default, might faster than the overhead using a &lt;code&gt;Sequence&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Sequence: use for &lt;code&gt;very large&lt;/code&gt; collections.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;iterate-a-collection&#34;&gt;Iterate a collection&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;eg.1&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.&lt;/span&gt;.args.size - &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) {
    println(args[i])
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eg.2, use Array&amp;rsquo;s &lt;code&gt;lastIndex&lt;/code&gt; extension property.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.&lt;/span&gt;.args.lastIndex) {
    println(args[i])
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eg., use &lt;code&gt;until&lt;/code&gt; to create open ended range.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; until args.size) {
    println(args[i])
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eg.4, use &lt;code&gt;indices&lt;/code&gt; extension property.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; args.indices) {
    println(args[i])
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eg.5&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (arg &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; args) {
    println(arg)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eg.6, use &lt;code&gt;forEach&lt;/code&gt; extension function.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;args.forEach { arg -&amp;gt;
    println(arg)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eg.7, use &lt;code&gt;withIndex&lt;/code&gt; function.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt;((index, arg) &lt;span style=&#34;color:#66d9ef&#34;&gt;in&lt;/span&gt; args.withIndex()) {
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;index: $index, arg: $arg&amp;#34;&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eg.8, use &lt;code&gt;forEachIndexed&lt;/code&gt; functions.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;args.forEachIndexed { index, arg -&amp;gt;
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;index: $index, arg: $arg&amp;#34;&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;sam-conversion&#34;&gt;SAM conversion&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;SAM conversions only work for interfaces, not for abstract classes&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;This code will work fine:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;button.setListener {
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Clicked!&amp;#34;&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The following will not work:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;* This gives the button a lambda that will create an anonymous instance of an OnClickListener
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;* every time the button is clicked, which is then just thrown away (never assigned anywhere,
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;* never invoked).
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;*/&lt;/span&gt;
button.setListener {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt;: OnClickListener {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClick&lt;/span&gt;(button: Button) {
            println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Clicked!&amp;#34;&lt;/span&gt;)
        }
    }
}

&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;* This one declares a useless local function in a very simliar fashion
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;*/&lt;/span&gt;
button.setListener {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClick&lt;/span&gt;(button: Button) {
        println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Clicked!&amp;#34;&lt;/span&gt;)
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://stackoverflow.com/questions/48284994/lambda-implementation-of-interface-in-kotlin&#34;&gt;SAM constructor&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/**
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * If the interface is defined in Java, but the function that takes an instance of its defined in Kotlin,
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; * try to use a SAM constructor.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt; */&lt;/span&gt;
 button.setListener(OnClickListener {
    println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Clicked&amp;#34;&lt;/span&gt;)
 })
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Explanation
|               | Java interface  | Kotlin interface  |
|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;ndash;|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-|
| Java method   | SAM conversion  | Object expression |
| Kotlin method | SAM constructor | Object expression |&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;static-things&#34;&gt;Static things&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;If your class has &amp;ldquo;non-static&amp;rdquo; parts as well, put the &amp;ldquo;static&amp;rdquo; parts in a companion object:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Foo&lt;/span&gt; {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;companion&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;x&lt;/span&gt;() {...}
    }
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;y&lt;/span&gt;() {...}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;If your class is completely static, replace &lt;code&gt;class&lt;/code&gt; with a singleton &lt;code&gt;object&lt;/code&gt; :&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Foo&lt;/span&gt; {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;x&lt;/span&gt;() {...}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;And if you don&amp;rsquo;t want to always scope your calls as &lt;code&gt;Foo.x()&lt;/code&gt; but want to just use &lt;code&gt;x()&lt;/code&gt; instead, use a top level function:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// file Foo.kt
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;x&lt;/span&gt;() {...}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;For function, there has this table:
| Function declaration             | Kotlin usage | Java usage         |
|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;ndash;|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;ndash;|
| Companion object                 | Foo.f()      | Foo.Companion.f(); |
| Companion object with @JvmStatic | Foo.f()      | Foo.f();           |
| Object                           | Foo.f()      | Foo.INSTANCE.f();  |
| Object with @JvmStatic           | Foo.f()      | Foo.f();           |
| Top level function               | f()          | UtilKt.f();        |
| Top level function with @JvmName | f()          | Util.f();          |&lt;/li&gt;
&lt;li&gt;For variable, here&amp;rsquo;s the reference:
| Variable declaration                           | Kotlin usage | Java usage          |
|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;ndash;|&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;|
| Companion object                               | X.x          | X.Companion.getX(); |
| Companion object with @JvmStatic               | X.x          | X.getX();           |
| Companion object with @JvmField                | X.x          | X.x;                |
| Companion object with const                    | X.x          | X.x();              |
| Object                                         | X.x          | X.INSTANCE.getX();  |
| Object with @JvmStatic                         | X.x          | X.getX();           |
| Object with @JvmField                          | X.x          | X.x;                |
| Object with const                              | X.x          | X.x;                |
| Top level variable                             | x            | ConstKt.getX();     |
| Top level variable with @JvmField              | x            | ConstKt.x;          |
| Top level variable with const                  | x            | ConstKt.x;          |
| Top level variable with @JvmName               | x            | Const.getX();       |
| Top level variable with @JvmName and @JvmField | x            | Const.x;            |
| Top level variable with @JvmName and const     | x            | Const.x;            |&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;6smart-cast-on-mutable-properties&#34;&gt;6.Smart cast on mutable properties&lt;/h4&gt;
&lt;p&gt;以下代码会报这种错：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Kotlin: Smart cast to &amp;lsquo;Toy&amp;rsquo; is impossible, because &amp;lsquo;toy&amp;rsquo; is a mutable property that could have been changed by this time&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Dog&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; toy: Toy? = &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;play&lt;/span&gt;() {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (toy != &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;) {
            toy.chew()
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;原因：
因为 mutable 的变量&lt;code&gt;Dog&lt;/code&gt; 实例可能在&lt;code&gt;toy!=null&lt;/code&gt;检查后在另一条线程上被修改，而在 &lt;code&gt;toy.chew()&lt;/code&gt;执行时可能产生 NPE.&lt;/p&gt;
&lt;p&gt;可以做以下修改：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用局部变量&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Dog&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; toy: Toy? = &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;play&lt;/span&gt;() {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; _toy = toy
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (_toy != &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;) {
            _toy.chew()
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;临时 let 操作符，使用范围更广泛：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Dog&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; toy: Toy? = &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;play&lt;/span&gt;() {
        toy&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;let {
            it.chew()
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;?. 操作符&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Dog&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; toy: Toy? = &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;play&lt;/span&gt;() {
        toy&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;chew()
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;override-java-方法&#34;&gt;override Java 方法&lt;/h4&gt;
&lt;p&gt;假设 Java 中定义了接口 &lt;code&gt;OnClickListener&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;OnClickListener&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClick&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Button button&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在 Kotlin 中实现该接口，如果使用IDEA生成：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;KtListener&lt;/span&gt;: OnClickListener {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClick&lt;/span&gt;(button: Button?): Unit {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; name = button&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;name &lt;span style=&#34;color:#f92672&#34;&gt;?:&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Unknown button&amp;#34;&lt;/span&gt;
        println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Clicked $name&amp;#34;&lt;/span&gt;)
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;对于我们知道不可能为 &lt;code&gt;null&lt;/code&gt; 的场景，可以这样写：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kt&#34; data-lang=&#34;kt&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;KtListener&lt;/span&gt;: OnClickListener {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onClick&lt;/span&gt;(button: Button): Unit {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; name = button.name
        println(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Clicked $name&amp;#34;&lt;/span&gt;)
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Intro to Build System</title>
      <link>https://zacash.cn/post/intro-to-build-system/</link>
      <pubDate>Fri, 05 Jun 2020 14:49:15 +0800</pubDate>
      
      <guid>https://zacash.cn/post/intro-to-build-system/</guid>
      <description>&lt;h3 id=&#34;构建流程build-process&#34;&gt;构建流程（Build process）&lt;/h3&gt;
&lt;p&gt;简单来说构建流程就是涉及一系列工具和步骤将项目转换成 Android Application Package(APK)。典型的流程如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://developer.android.google.cn/images/tools/studio/build-process_2x.png&#34; alt=&#34;build-process&#34;&gt;&lt;/p&gt;
&lt;p&gt;图中所示有4个步骤：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;编译器将源码转换为 DEX 文件(Dalvik 可执行文件，包括运行在 Android 设备的字节码)，并将其他所有内容转换成编译后的资源文件。&lt;/li&gt;
&lt;li&gt;APK Packager 将 DEX 文件和编译后的资源文件合并到一个 APK 里。&lt;/li&gt;
&lt;li&gt;APK Packager 使用 keystore 为 APK 签名。&lt;/li&gt;
&lt;li&gt;在生成最终的 APK 文件之前，Packager 会使用 &lt;a href=&#34;https://developer.android.com/studio/command-line/zipalign&#34;&gt;zipalign&lt;/a&gt; 工具&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;自定义构建配置&#34;&gt;自定义构建配置&lt;/h3&gt;
&lt;p&gt;Gradle 和 Android 插件可以帮助我们修改 &lt;strong&gt;build.gradle&lt;/strong&gt; 中的这些配置：&lt;/p&gt;
&lt;h4 id=&#34;构建类型-build-types&#34;&gt;构建类型 Build Types&lt;/h4&gt;
&lt;p&gt;构建类型定义 Gradle 在构建(building)和打包(packaging) App 时使用的某些属性，通常针对开发周期的不同阶段(different stages of development)进行配置。比如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;debug 构建类型支持 debug 选项，并使用 debug key 为 APK 签名。&lt;/li&gt;
&lt;li&gt;release 构建类型则会压缩(shrink)和混淆(obfuscate) APK，并使用 release key 为 APK 签名。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;构建 App 时必须指定一个构建类型。可以参考 &lt;a href=&#34;https://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.BuildType.html&#34;&gt;BuildType DSL&lt;/a&gt;，了解配置构建类型属性。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-groovy&#34; data-lang=&#34;groovy&#34;&gt;buildTypes &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  release &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    minifyEnabled &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
    shrinkResources &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;
    proguardFiles &lt;span style=&#34;color:#a6e22e&#34;&gt;getDefaultProguardFile&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;proguard-android-optimize.txt&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;proguard-rules.pro&amp;#39;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
  debug &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    applicationIdSuffix &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;.debug&amp;#34;&lt;/span&gt;
    debuggable &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
  staging &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    initWith debug
    manifestPlaceholders &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;hostname:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;internal.zacash.cn&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
    applicationIdSuffix &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;.debugStaging&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;产品类型-product-flavors&#34;&gt;产品类型 Product Flavors&lt;/h4&gt;
&lt;p&gt;Product flavors 表示我们可以向用户发布 App 不同的版本，如免费版和付费版。我们可以自定义 product flavor 来使用不同的代码和资源。&lt;/p&gt;
&lt;p&gt;Product flavors 支持与 &lt;code&gt;defaultConfig&lt;/code&gt; 相同的属性，这是因为 &lt;code&gt;defaultConfig&lt;/code&gt; 实际上属于 &lt;a href=&#34;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ProductFlavor.html&#34;&gt;ProductFlavor&lt;/a&gt; 类。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Google Play 的&lt;a href=&#34;https://developer.android.com/google/play/publishing/multiple-apks&#34;&gt;多 APK&lt;/a&gt; 分发应用，是将同一 applicationId 分配给所有的 flavor，并为每个 flavor 分配不同的 versionCode。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-groovy&#34; data-lang=&#34;groovy&#34;&gt;flavorDimensions &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;api&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;mode&amp;#34;&lt;/span&gt;
productFlavors &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  demo &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    dimension &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;mode&amp;#34;&lt;/span&gt;
    applicationIdSuffix &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;.demo&amp;#34;&lt;/span&gt;
    versionNameSuffix &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;-demo&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
  full &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    dimension &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;mode&amp;#34;&lt;/span&gt;
    applicationIdSuffix &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;.full&amp;#34;&lt;/span&gt;
    versionNameSuffix &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;-full&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
  minApi21 &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    dimension &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;api&amp;#34;&lt;/span&gt;
    minSdkVersion &lt;span style=&#34;color:#ae81ff&#34;&gt;21&lt;/span&gt;
    versionCode &lt;span style=&#34;color:#ae81ff&#34;&gt;10000&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;defaultConfig&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;versionCode&lt;/span&gt;
    versionNameSuffix &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;-minApi21&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;构建变体-build-variants&#34;&gt;构建变体 Build Variants&lt;/h4&gt;
&lt;p&gt;Build variants 是由 build type 和 product flavor 组成，也是 Gradle 用来构建应用的配置。配置 Build variants 就是指配置组成它的 build type 和 product flavor。&lt;/p&gt;
&lt;p&gt;Gradle 创建的 build varuants 数量等于 productFlavors * buildTypes. Gradle 构建 APK 命名时，会先以高优先级的 flavorDimension 的 ProductFlavor 显示，而后是低优先级 flavorDimension 的 ProductFlavor，最后是 BuildType。比如上面的 ProductFlavor 和 BuildType 配置，在构建 APK 时对应的 Build Variants：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Build Variants: [minApi21][Demo, Full][Debug, Release]&lt;/li&gt;
&lt;li&gt;APK 名称：app-[minApi21]-[demo, full]-[debug, release].apk&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;清单条目-manifest-entries&#34;&gt;清单条目 Manifest entries&lt;/h4&gt;
&lt;p&gt;我们可以在 build variants 中设置清单文件(AndroidManifest.xml)中的某些属性，这些构建值会替换清单文件中的现有值。如果我们要为模块生成多个 APK，这些 APK 有不同的应用名称、min SDK version 或 target SDK version，定义这些属性将会很有效。&lt;/p&gt;
&lt;h4 id=&#34;依赖项-dependencies&#34;&gt;依赖项 Dependencies&lt;/h4&gt;
&lt;p&gt;构建系统会管理来自本地文件系统以及来自远程代码库的项目依赖项。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Fragment in ViewPager</title>
      <link>https://zacash.cn/post/fragment-in-viewpager/</link>
      <pubDate>Mon, 25 May 2020 20:55:31 +0800</pubDate>
      
      <guid>https://zacash.cn/post/fragment-in-viewpager/</guid>
      <description>&lt;h3 id=&#34;使用-viewpager&#34;&gt;使用 ViewPager&lt;/h3&gt;
&lt;p&gt;通常我们使用 ViewPager + TabLayout 主要有这些步骤：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;页面的布局结构:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;utf-8&amp;#34;?&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;androidx.coordinatorlayout.widget.CoordinatorLayout&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;xmlns:android=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;http://schemas.android.com/apk/res/android&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;xmlns:app=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;http://schemas.android.com/apk/res-auto&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;xmlns:tools=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;http://schemas.android.com/tools&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_width=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_height=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;tools:context=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;.MainActivity&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;

  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;com.google.android.material.appbar.AppBarLayout&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_width=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_height=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;wrap_content&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:theme=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@style/AppTheme.AppBarOverlay&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;

    ...

    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;com.google.android.material.tabs.TabLayout&lt;/span&gt;
        &lt;span style=&#34;color:#a6e22e&#34;&gt;android:id=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@+id/tabs&amp;#34;&lt;/span&gt;
        &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_width=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
        &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_height=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;wrap_content&amp;#34;&lt;/span&gt;
        &lt;span style=&#34;color:#a6e22e&#34;&gt;android:background=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;?attr/colorPrimary&amp;#34;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;

    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;androidx.viewpager.widget.ViewPager&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:id=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@+id/view_pager&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_width=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;android:layout_height=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;match_parent&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#a6e22e&#34;&gt;app:layout_behavior=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@string/appbar_scrolling_view_behavior&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/com.google.android.material.appbar.AppBarLayout&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/androidx.coordinatorlayout.widget.CoordinatorLayout&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;在 PagerAdapter 中会指定我们使用的 Fragment:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;SectionsPagerAdapter&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; context: Context,
  fm: FragmentManager
) : FragmentPagerAdapter(fm, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT) {

  &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;getItem&lt;/span&gt;(position: Int): Fragment {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; SampleFragment.newInstance(position)
  }

  &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;getCount&lt;/span&gt;(): Int {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; TAB_TITLES.size
  }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;给 ViewPager 设置 PagerAdapter:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;viewPager.adapter = pagerAdapter
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;TabLayout 绑定 ViewPager:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;tabs.setupWithViewPager(viewPager)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;pageradapter&#34;&gt;PagerAdapter&lt;/h3&gt;
&lt;p&gt;目前官方提供的 PagerAdapter 有 2 种，在源码中已介绍各自的使用场景(假设 offscreenPageLimit=1)：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;FragmentPagerAdapter&lt;/p&gt;
&lt;p&gt;适合有少量的几个 Fragment 页面，比如一组 tabs，用户访问的每个页面都会保存在内存中，内存占用可能比较大。&lt;/p&gt;
&lt;p&gt;对于满足 &lt;code&gt;offscreenPageLimit&lt;/code&gt; 的 Fragment ，其回调的方法是：onStop -&amp;gt; onDestroyView.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;FragmentStatePagerAdapter&lt;/p&gt;
&lt;p&gt;适合有大量 Fragment 页面，类似于 ListView 工作的场景，页面不可见时，整个 Fragment 都会被销毁，只有 SavedState 会被保存。相较 FragmentPagerAdapter 内存占用更小。&lt;/p&gt;
&lt;p&gt;对于满足 &lt;code&gt;offscreenPageLimit&lt;/code&gt; 的 Fragment ，其回调的方法是：onStop -&amp;gt; onDestroyView -&amp;gt; onDestroy -&amp;gt; onDetach.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;保存和恢复-state&#34;&gt;保存和恢复 State&lt;/h3&gt;
&lt;h4 id=&#34;保存-fragment-的-state&#34;&gt;保存 Fragment 的 State&lt;/h4&gt;
&lt;p&gt;对于使用 &lt;code&gt;FragmentStatePagerAdapter&lt;/code&gt; 的场景，我们可能需要在 Fragment 销毁时保存一些数据，通常的做法是在 &lt;code&gt;onSaveInstanceState(outState)&lt;/code&gt; 中保存，在 &lt;code&gt;onCreate(savedInstanceState)&lt;/code&gt;、&lt;code&gt;onCreateView(savedInstanceState)&lt;/code&gt; 或 &lt;code&gt;onActivityCreated(savedInstanceState)&lt;/code&gt; 中恢复：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onSaveInstanceState&lt;/span&gt;(outState: Bundle) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onSaveInstanceState(outState)
    &lt;span style=&#34;color:#75715e&#34;&gt;// save instance state here
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;  }

&lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onCreate&lt;/span&gt;(savedInstanceState: Bundle?) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onCreate(savedInstanceState)
    savedInstanceState&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;let {
      &lt;span style=&#34;color:#75715e&#34;&gt;// restore instance state
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;保存-customview-的-state&#34;&gt;保存 CustomView 的 State&lt;/h4&gt;
&lt;p&gt;官方提供的 UI 控件内部都实现了 &lt;code&gt;onSaveInstanceState&lt;/code&gt; 和 &lt;code&gt;onRestoreInstanceState&lt;/code&gt; 方法，在页面销毁-重建时，这些控件可以保存-恢复 ViewState。对于自定义的 View，我们也需要实现这两个方法：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; Parcelable &lt;span style=&#34;color:#a6e22e&#34;&gt;onSaveInstanceState&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    Parcelable superState &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onSaveInstanceState&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
    SavedState ss &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; SavedState&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;superState&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; ss&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color:#a6e22e&#34;&gt;@Override&lt;/span&gt;
  &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onRestoreInstanceState&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Parcelable state&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(!(&lt;/span&gt;state &lt;span style=&#34;color:#66d9ef&#34;&gt;instanceof&lt;/span&gt; SavedState&lt;span style=&#34;color:#f92672&#34;&gt;))&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onRestoreInstanceState&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;state&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
      &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    SavedState ss &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SavedState&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; state&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;onRestoreInstanceState&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ss&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getSuperState&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;());&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Git Basic</title>
      <link>https://zacash.cn/post/git-basic/</link>
      <pubDate>Fri, 15 May 2020 15:55:52 +0800</pubDate>
      
      <guid>https://zacash.cn/post/git-basic/</guid>
      <description>&lt;h3 id=&#34;problem-solving&#34;&gt;Problem Solving&lt;/h3&gt;
&lt;h4 id=&#34;authentication&#34;&gt;Authentication&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Clear saved account &amp;amp; password&lt;/p&gt;
&lt;p&gt;Error: &lt;code&gt;fatal:Authentication failed for &#39;remote-url&#39;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;git config --system --unset credential.helper&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Save account &amp;amp; password&lt;/p&gt;
&lt;p&gt;&lt;code&gt;git config --global credential.helper store&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;remote&#34;&gt;Remote&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Check remote url&lt;/p&gt;
&lt;p&gt;&lt;code&gt;git remote -v&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Update remote url&lt;/p&gt;
&lt;p&gt;&lt;code&gt;git remote set-url origin newRepoUrl&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>Intro to Fragments</title>
      <link>https://zacash.cn/post/fragments/</link>
      <pubDate>Thu, 07 May 2020 20:30:50 +0800</pubDate>
      
      <guid>https://zacash.cn/post/fragments/</guid>
      <description>&lt;h3 id=&#34;activity-和-fragment-生命周期的关联&#34;&gt;Activity 和 Fragment 生命周期的关联&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Activity 状态&lt;/th&gt;
&lt;th&gt;Fragment 生命周期方法回调&lt;/th&gt;
&lt;th&gt;Fragment 状态&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Created&lt;/td&gt;
&lt;td&gt;onAttach(), onCreate(), onCreateView(), onActivityCreated()&lt;/td&gt;
&lt;td&gt;Fragment 添加到 Activity 且视图已初始化&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Started&lt;/td&gt;
&lt;td&gt;onStart()&lt;/td&gt;
&lt;td&gt;Fragment 活跃并可见&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Resumed&lt;/td&gt;
&lt;td&gt;onResume()&lt;/td&gt;
&lt;td&gt;Fragment 活跃并获取焦点&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Paused&lt;/td&gt;
&lt;td&gt;onPause()&lt;/td&gt;
&lt;td&gt;Fragment 暂停&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Stopped&lt;/td&gt;
&lt;td&gt;onStop()&lt;/td&gt;
&lt;td&gt;Fragment 停止并不再可见&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Destroyed&lt;/td&gt;
&lt;td&gt;onDestroyView(), onDestroy(), onDetach()&lt;/td&gt;
&lt;td&gt;Fragment 销毁&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;fragment-重要的生命周期方法的使用&#34;&gt;Fragment 重要的生命周期方法的使用&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;onAttach()&lt;/code&gt;: Fragment 在被 attach 到宿主 Activity 时回调，可以在该方法里检查宿主 Activity 是否实现了某个接口。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onCreateView()&lt;/code&gt;: Fragment 的 XML 布局在这个回调方法里初始化，系统调用这个方法来绘制 Fragment 的 UI。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onPause()&lt;/code&gt;: 可以在 Fragment 销毁前在该回调方法保存必要数据或状态。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onActivityCreated()&lt;/code&gt;: 在宿主 Activity 的 &lt;code&gt;onCreate()&lt;/code&gt; 方法调用后回调该方法。可以在该方法做最终的初始化，如检索 View &lt;code&gt;getView().findViewById(id)&lt;/code&gt;或恢复状态(restore state)。如果 Fragmnt 设置了 &lt;code&gt;setRetainInstance()&lt;/code&gt;，这个方法同样会被调用。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onDestroyView()&lt;/code&gt;: Fragment 的 UI 布局被移除时调用，可以在该方法标记 Fragment 不再可见。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;fragment-和-activity-间的连接&#34;&gt;Fragment 和 Activity 间的连接&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Fragment 获取宿主 Activity：在 Fragment attach 到宿主 Activity 后，可以通过 &lt;code&gt;getActivity()&lt;/code&gt; 获得宿主 Activity 实例。&lt;/li&gt;
&lt;li&gt;Activity 获取添加的 Fragment：可以通过 &lt;code&gt;FragmentManager.findFragmentById(containerId)&lt;/code&gt;获取 Fragment 的实例。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;fragment-的-backstack&#34;&gt;Fragment 的 BackStack&lt;/h4&gt;
&lt;p&gt;对于 Activity，系统管理着 Activity 的回退栈，而对于 Fragment，是宿主 Activity 管理着回退栈，对于需要响应返回键的 Fragment 页面，我们需要调用 &lt;code&gt;addToBackStack(name)&lt;/code&gt; 显式地将其添加到回退栈:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;fragmentTransaction.add(R.id.fragment_container, fragment)
fragmentTransaction.addToBackStack(&lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;)
fragmentTransaction.commit()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上面的代码中我们给 &lt;code&gt;addToBackStack()&lt;/code&gt; 传入的 &lt;code&gt;null&lt;/code&gt; ，如果是需要调用 &lt;code&gt;FragmentManager.BackStackEntry&lt;/code&gt; 接口时，则必须传入具体的名称标记。
对于添加到 Activity 回退栈的 Fragment，当按下返回键，某个 Fragment 实例出栈时，其视图重建回调 &lt;code&gt;onCreateView()&lt;/code&gt; 方法。&lt;/p&gt;
&lt;h4 id=&#34;activity-向-fragment-传递数据&#34;&gt;Activity 向 Fragment 传递数据&lt;/h4&gt;
&lt;p&gt;通常从 Activity 向 Fragment 传递数据，推荐使用 Fragment 的 &lt;code&gt;setArguments(Bundle)&lt;/code&gt; 方法，具体的流程是：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;companion&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;newInstance&lt;/span&gt;(name: String) : SimpleFragment {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; fragment = SimpleFragment()
        &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; args = Bundle(ARGS_NAME, name)
        fragment.arguments = argument
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; fragment
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在 Activity 初始化该 Fragment 传入 &lt;code&gt;name&lt;/code&gt; 参数:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; name = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;SimpleApp&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; ft = supportFragmentManager.beginTransaction()
&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; fragment = SimpleFragment.newInstance(name)
ft.add(R.id.fragment_container, fragment).commit()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在 Fragment 的 &lt;code&gt;onCreate()&lt;/code&gt; 或 &lt;code&gt;onCreateView()&lt;/code&gt; 的回调内，获取该参数：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (arguments.containsKey(ARGS_NAME)) {
    mName = arguments.getString(ARGS_NAME);
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;fragment-向-activity-传递数据&#34;&gt;Fragment 向 Activity 传递数据&lt;/h4&gt;
&lt;p&gt;对于 Activity 内实现 Fragment 内定义的接口，在 &lt;code&gt;Fragment.onAttach()&lt;/code&gt;方法获取宿主 Activity:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;OnPanelClickListener&lt;/span&gt; {
    void onClick()
}

&lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onAttach&lt;/span&gt;(context: Context) {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onAttach(context)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (context &lt;span style=&#34;color:#66d9ef&#34;&gt;is&lt;/span&gt; OnPanelClickListener) {
        mListener = context &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; OnPanelClickListener
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Coroutines Introduction</title>
      <link>https://zacash.cn/post/coroutines-introduction/</link>
      <pubDate>Sat, 25 Apr 2020 11:40:03 +0800</pubDate>
      
      <guid>https://zacash.cn/post/coroutines-introduction/</guid>
      <description>&lt;h3 id=&#34;协程用来解决什么问题&#34;&gt;协程用来解决什么问题&lt;/h3&gt;
&lt;p&gt;Kotlin 的协程提供了一种全新的并发处理方式，我们可以使用它来简化安卓异步执行的代码。&lt;/p&gt;
&lt;p&gt;在 Android 平台上协程主要用来解决两个问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;处理耗时任务(Long running tasks)&lt;/li&gt;
&lt;li&gt;保证主线程安全(Main-safety)&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;处理耗时任务&#34;&gt;处理耗时任务&lt;/h4&gt;
&lt;p&gt;我们常规处理耗时任务是通过异步回调的方式，比如：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;fetchDoc&lt;/span&gt;() {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;get&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://doc.qq.com&amp;#34;&lt;/span&gt;) { result -&amp;gt;
        show(result)
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;通过协程的方式是这样：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// 主线程执行
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;suspend&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;fetchDoc&lt;/span&gt;() {
    &lt;span style=&#34;color:#75715e&#34;&gt;// 直接返回结果
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; result = &lt;span style=&#34;color:#66d9ef&#34;&gt;get&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://doc.qq.com&amp;#34;&lt;/span&gt;)
    show(result)
}

&lt;span style=&#34;color:#75715e&#34;&gt;// 主线程执行
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;suspend&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;get&lt;/span&gt;(url: String) = withContext(Dispatchers.IO) {
    &lt;span style=&#34;color:#75715e&#34;&gt;/*IO 线程池执行*/&lt;/span&gt;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以看到通过协程可以直接返回请求结果，而不用管理请求延迟和线程阻塞，这是如何实现的呢？&lt;/p&gt;
&lt;p&gt;协程在常规的函数操作 —— invoke 和 return 之外，还新增了2项：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;suspend —— 称为挂起或暂停，用于暂停执行当前协程，并保存所有局部变量&lt;/li&gt;
&lt;li&gt;resume —— 让暂停的协程继续执行&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;那么 suspend 是如何实现的呢？&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Kotlin 使用堆栈帧来管理需要运行哪个函数及所有局部变量。suspend 协程时，系统会复制并保存当前的栈帧供后续使用，resume 协程时，系统会还原保存的栈帧，然后函数从暂停的位置继续执行。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在上面的协程示例中，&lt;code&gt;get()&lt;/code&gt;函数在主线程上运行，但会在网络请求前暂停协程，请求完成时，&lt;code&gt;get()&lt;/code&gt;函数恢复协程。&lt;/p&gt;
&lt;h4 id=&#34;保证线程安全&#34;&gt;保证线程安全&lt;/h4&gt;
&lt;p&gt;Kotlin 提供了三种调度器(Dispatcher)供协程执行任务。协程可以自行暂停，调度器(Dispatcher)负责恢复。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Dispatcher&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;线程&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;任务设计&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Dispatcher.Main&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;主线程&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;UI 交互和轻量级任务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;调用 suspend 函数、调用 UI 函数、 更新 LiveData&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Dispatcher.IO&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;非主线程&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;磁盘和网络 IO 任务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;数据库、文件、网络处理&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Dispatcher.Default&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;非主线程&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;CPU 密集型任务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;数组排序、JSON 解析、处理 Diff 判断&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;上面的示例中，&lt;code&gt;get()&lt;/code&gt;函数 通过 &lt;code&gt;withContext(Dispatcher.IO)&lt;/code&gt; 创建一个在 IO 线程池内运行的代码块。&lt;/p&gt;
&lt;p&gt;如果某个函数任务涉及到磁盘、网络或者占用过多的 CPU 资源，都应该使用 &lt;code&gt;withContext(Dispatcher)&lt;/code&gt; 来确保可以在主线程安全地调用。&lt;/p&gt;
&lt;h3 id=&#34;追踪协程&#34;&gt;追踪协程&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;协程自身并不能追踪正在处理的任务，使用代码来手动追踪上千个协程是十分困难的，我们虽然可以尝试对所有协程进行追踪，手动确保它们都完成或取消任务，但这样代码会十分复杂和臃肿。如果没有追踪协程，则可能诱发任务泄漏(work leak)，即耗时任务会持续地占用资源执行下去。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;为了能够避免这种情况，Kotlin 引入了 &lt;strong&gt;结构化并发(structured concurrency)&lt;/strong&gt; 机制，遵循它可以帮助我们追踪所有运行的任务。我们可以使用结构化并发做到下面三件事：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;取消任务 —— 取消某项无用的任务&lt;/li&gt;
&lt;li&gt;追踪任务 —— 追踪某项正在执行的任务&lt;/li&gt;
&lt;li&gt;发出错误信号 —— 任务异常时发出错误信号&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;使用-scope-来追踪协程&#34;&gt;使用 Scope 来追踪协程&lt;/h4&gt;
&lt;p&gt;Kotlin 中定义启动协程必须指定其 CoroutineScope, CoroutineScope 可以追踪或取消所有由它启动的协程。&lt;/p&gt;
&lt;p&gt;有两种方式能够启动协程，分别用于不同的场景：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;launch&lt;/code&gt; 方式启动新协程不会返回 result，适合不需要执行结果的场景&lt;/li&gt;
&lt;li&gt;&lt;code&gt;async&lt;/code&gt; 方式启动新协程并允许我们使用 await 的挂起函数返回 result.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通常我们应该使用 &lt;code&gt;launch&lt;/code&gt; 方式启动新协程。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;scope.launch {
    &lt;span style=&#34;color:#75715e&#34;&gt;// launch 可以调用 suspend 函数
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    fetchDoc()
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;在-viewmodel-中启动协程&#34;&gt;在 ViewModel 中启动协程&lt;/h4&gt;
&lt;p&gt;当协程和 Android Architecture Components 结合时，我们应该在哪个组件使用协程呢？&lt;/p&gt;
&lt;p&gt;答案是 ViewModel，我们大部分任务都是在 ViewModel 中处理，而且 &lt;a href=&#34;https://developer.android.google.cn/topic/libraries/architecture/coroutines#lifecycle-aware&#34;&gt;AndroidX Lifecycle&lt;/a&gt; 从 2.1.0 版本开始已经引入扩展属性 &lt;code&gt;ViewModel.viewModelScope&lt;/code&gt;，可以更方便地在 ViewModel 中使用协程：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;MainViewModel&lt;/span&gt;(): ViewModel() {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setUserDoc&lt;/span&gt;() {
        &lt;span style=&#34;color:#75715e&#34;&gt;// 启动新的协程
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        viewModelScope.launch {
            fetchDoc()
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;当 viewModelScope 被清除时，它将自动取消所有它启动的协程，可以保证协程和 ViewModel 的生命周期是一致的。&lt;/p&gt;
&lt;h4 id=&#34;启动多个协程&#34;&gt;启动多个协程&lt;/h4&gt;
&lt;p&gt;可以使用 &lt;a href=&#34;https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html&#34;&gt;&lt;code&gt;coroutineScope&lt;/code&gt;&lt;/a&gt; 或 &lt;a href=&#34;https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/supervisor-scope.html&#34;&gt;&lt;code&gt;supervisorScope&lt;/code&gt;&lt;/a&gt; 启动多个协程，结构化并发保证了当 &lt;code&gt;suspend&lt;/code&gt; 函数返回时，它所处理的任务也都完成了。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;suspend&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;fetchDocs&lt;/span&gt;() {
    coroutineScope {
        async {fetchDoc()}
        async {fetchPdf()}
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Kotlin 确保使用 &lt;code&gt;coroutineScope&lt;/code&gt; 构造方法不让 &lt;code&gt;fetchDocs()&lt;/code&gt; 方法发生泄漏，会先将 &lt;code&gt;coroutineScope&lt;/code&gt; 自身挂起，等待它内部的所有协程完成时，再返回结果。&lt;/p&gt;
&lt;h4 id=&#34;异常处理&#34;&gt;异常处理&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;coroutineScope&lt;/code&gt; 和 &lt;code&gt;supervisorScope&lt;/code&gt; 两者都适合启动多个协程的场景，区别在于当启动的某一子协程出错时，coroutineScope 将会取消所有协程，而 supervisorScope 会继续执行剩余的协程。&lt;/p&gt;
&lt;p&gt;协程中来自 suspend 函数的异常会通过 resume 重新抛给调用方 (Invoker) 来处理，跟函数一样，我们可以用 try/catch 处理异常。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;suspend&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;getError&lt;/span&gt;() {
    coroutineScope {
        async {
            &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; IllegalStateException(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;...&amp;#34;&lt;/span&gt;)
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;参考&#34;&gt;参考&lt;/h4&gt;
&lt;p&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/kPvWOCkMjYRKJSTX4I5VKg&#34;&gt;在Android 开发中使用协程&lt;/a&gt;
&lt;a href=&#34;https://www.reddit.com/r/androiddev/comments/ftqe6s/&#34;&gt;Coroutines Discussion&lt;/a&gt;
&lt;a href=&#34;https://www.youtube.com/watch?v=_hfBv0a09Jc&#34;&gt;Introduction to Coroutines&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Activity Start</title>
      <link>https://zacash.cn/post/activity-launch/</link>
      <pubDate>Wed, 22 Apr 2020 08:10:27 +0800</pubDate>
      
      <guid>https://zacash.cn/post/activity-launch/</guid>
      <description>&lt;h3 id=&#34;task-and-back-stack&#34;&gt;Task and Back Stack&lt;/h3&gt;
&lt;p&gt;Task 就是执行某项任务时开启的一系列 Activity 的集合，这些 Activity 会按照打开的顺序排列在回退栈 (Back Stack) 中。&lt;/p&gt;
&lt;h4 id=&#34;activity-的四种启动模式-launchmode&#34;&gt;Activity 的四种启动模式 (launchMode)&lt;/h4&gt;
&lt;p&gt;如通过 &lt;code&gt;startActivity(Intent)&lt;/code&gt; 启动 Activity A&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;standard 模式：标准模式，创建 Activity A 实例并 push 到当前任务栈中&lt;/li&gt;
&lt;li&gt;singleTop 模式：栈顶复用模式，如果当前栈顶是 Activity A ，直接复用并调用 &lt;code&gt;onNewIntent(Intent)&lt;/code&gt;方法，不会创建新的实例&lt;/li&gt;
&lt;li&gt;singleTask 模式：栈内复用模式，如果当前栈内含有 Activity A ，直接复用并调用 &lt;code&gt;onNewIntent(Intent)&lt;/code&gt;方法，并清除栈内 Activity A  上方的所有 Activity 实例&lt;/li&gt;
&lt;li&gt;singleInstance 模式：在新的任务栈开启 Activity A，如果新的任务栈和 Activity A 已创建，继续开启 Activity A 会调用其 &lt;code&gt;onNewIntent(Intent)&lt;/code&gt;方法。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;三种-intent-标记&#34;&gt;三种 Intent 标记&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;startActivity(Intent)&lt;/code&gt; 方法可以添加 3 种 Intent 标记：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;FLAG_ACTIVITY_NEW_TASK&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;在新的任务栈中启动 Activity A，如果当前运行的任务栈中已含有 Activity A，则将任务栈内的 Activity A 恢复到前台并调用 &lt;code&gt;onNewInstent(Intent)&lt;/code&gt; 方法，此 flag 的功能同 &lt;strong&gt;singleTask&lt;/strong&gt; 启动模式相同。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;FLAG_ACTIVITY_SINGLE_TOP&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;如果待启动的 Activity A 已位于任务栈顶，则会调用该实例的 &lt;code&gt;onNewInstent(Intent)&lt;/code&gt;，此 flag 的功能同 &lt;strong&gt;singleTop&lt;/strong&gt; 启动模式。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;FLAG_ACTIVITY_CLEAR_TOP&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;如果待启动的 Activity A 已存在于当前任务栈内，则任务栈内该 Activity A 上方的所有 Activity 都会被销毁，Activity A 恢复前台并调用的 &lt;code&gt;onNewIntent(Intent)&lt;/code&gt; 方法。&lt;em&gt;FLAG_ACTIVITY_CLEAR_TOP&lt;/em&gt; 通常和 &lt;em&gt;FLAG_ACTIVITY_NEW_TASK&lt;/em&gt; 结合使用，这是一种可以将另一个任务栈内已存在 Activity 响应 Intent 的方式。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;taskaffinity-属性&#34;&gt;taskAffinity 属性&lt;/h4&gt;
&lt;p&gt;taskAffinity 表示 Activity 倾向于归属哪个任务栈. 默认情况下，一个 App 内的所有 Activity 有相同的 affinity，即会被安排在同一任务栈下。我们可以通过 taskAffinity 修改 Activity 的归属任务栈。&lt;/p&gt;
&lt;p&gt;使用场景：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;启动 Activity 的 intent 包含 &lt;code&gt;FLAG_ACTIVITY_NEW_TASK&lt;/code&gt; 标记时。&lt;/p&gt;
&lt;p&gt;对于 Activity A 通过 &lt;code&gt;startActivity(Intent)&lt;/code&gt; 方法启动 Activity B，在默认 standard 启动模式时，Activity B 会被 push 到 Activity A 所在的任务栈。但当传给 &lt;code&gt;startActivity(Intent)&lt;/code&gt; 的 intent 使用 &lt;code&gt;FLAG_ACTIVITY_NEW_TASK&lt;/code&gt; 标记时，系统会先寻找是否有和 Activity B 具有相同 affinity 的任务栈，如果有，则会将启动的 Activity B push 到该任务栈中，如果没有，创建新的任务栈。&lt;/p&gt;
&lt;p&gt;通过 &lt;code&gt;FLAG_ACTIVITY_NEW_TASK&lt;/code&gt; 创建新的任务栈时，当用户按下 &lt;em&gt;HOME&lt;/em&gt; 键离开该任务时，必须有方法供用户返回该任务。某些外部实体(如 Notification Manager) 通常在外部任务(external task)启动 Activity， 即在 &lt;code&gt;startActivity(Intent)&lt;/code&gt; 的 intent 使用 &lt;code&gt;FLAG_ACTIVITY_NEW_TASK&lt;/code&gt; 标记。如果你的 App 中某个 Activity 可能被外部实体(如 Notification Manager) 通过这种方式启动，需要确保该用户具有独立的方式(App Launcher)，返回到启动的任务。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;当 Activity 的 &lt;strong&gt;allowTaskReparenting&lt;/strong&gt; 属性设为 &lt;code&gt;&amp;quot;true&amp;quot;&lt;/code&gt;时。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;清除回退栈&#34;&gt;清除回退栈&lt;/h4&gt;
&lt;p&gt;默认情况下，App 置于后台一段时间后，系统会清除该 App 任务栈内除了 Root Activity 外所有的 Activity。当 App 再次回到前台时(回到该任务栈)时，只有 Root Activity 被恢复。Activity 有 3 种控制该特性的属性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;alwaysRetainTaskState&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;当任务栈的 Root Activity 的该属性设为 &lt;code&gt;&amp;quot;true&amp;quot;&lt;/code&gt; 时，系统不会再回收任务栈内的其他 Activity，所有 Activity 都会在栈内长时间保留。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;clearTaskOnLaunch&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;当任务栈的 Root Activity 的该属性设为 &lt;code&gt;&amp;quot;true&amp;quot;&lt;/code&gt; 时，系统在会在离开该任务栈时就清除所有 Activity。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;finishOnTaskLaunch&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;与 &lt;code&gt;clearTaskOnLaunch&lt;/code&gt; 相似，不过该属性仅适用于单一 Activity，不是整个任务栈。当某 Activity 的该属性设为 &lt;code&gt;&amp;quot;true&amp;quot;&lt;/code&gt; 时，系统会在离开该任务栈时立即清除该 Activity。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;开启任务&#34;&gt;开启任务&lt;/h4&gt;
&lt;p&gt;一般来说 App 的入口 Activity 的 intent-filter 会设置成这样：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;activity&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;intent-filter&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;action&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;android:name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;android.intent.action.MAIN&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;category&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;android:name=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;android.intent.category.LAUNCHER&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/intent-filter&amp;gt;&lt;/span&gt;
    ...
&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/activity&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这种配置会在 Launcher App 中显示该 Activity 对应的的 icon 和 label，从而为用户提供启动 Activity 或从别的任务回到该任务的入口。&lt;/p&gt;
&lt;p&gt;正如前面介绍通过 &lt;code&gt;FLAG_ACTIVITY_NEW_TASK&lt;/code&gt; 创建新的任务，当用户按下 &lt;em&gt;HOME&lt;/em&gt; 键离开该任务时，必须有方法供用户返回该任务，这种方法就是 activity launcher。因此对于可以启动新任务的2种启动模式, &lt;code&gt;singleTask&lt;/code&gt; 和 &lt;code&gt;singleInstance&lt;/code&gt;，应该仅在 Activity 的 intent filter 有 &lt;a href=&#34;https://developer.android.com/reference/android/content/Intent#ACTION_MAIN&#34;&gt;ACTION_MAIN&lt;/a&gt; 和 &lt;a href=&#34;https://developer.android.com/reference/android/content/Intent#CATEGORY_LAUNCHER&#34;&gt;CATEGORY_LAUNCHER&lt;/a&gt; 修饰时使用。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Handler in Action</title>
      <link>https://zacash.cn/post/handler-in-action/</link>
      <pubDate>Tue, 14 Apr 2020 21:53:54 +0800</pubDate>
      
      <guid>https://zacash.cn/post/handler-in-action/</guid>
      <description>&lt;h3 id=&#34;memory-leaks&#34;&gt;Memory Leaks&lt;/h3&gt;
&lt;h4 id=&#34;11-背景&#34;&gt;1.1 背景&lt;/h4&gt;
&lt;p&gt;1.Handler 在使用下面这种实现方式处理消息时:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;MainActivity&lt;/span&gt; : Activity() {

    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mLeakedHandler = &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;: &lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Handler&lt;/span&gt;() {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handleMessage&lt;/span&gt;(msg: Message) {
            &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.handleMessage(msg)
        }
    }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;http://tools.android.com/tips/lint-checks&#34;&gt;Android Lint&lt;/a&gt; 会发出这样的警告: &lt;code&gt;This Handler class should be static or leaks might occur(anonymous android.os.Handler)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;2.我们在 Handler 构造方法里同样可以看到：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Handler&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@Nullable&lt;/span&gt; Callback callback&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; async&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;FIND_POTENTIAL_LEAKS&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; Class&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;?&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;extends&lt;/span&gt; Handler&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; klass &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; getClass&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;((&lt;/span&gt;klass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isAnonymousClass&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; klass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isMemberClass&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; klass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isLocalClass&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;klass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getModifiers&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; Modifier&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;STATIC&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; 0&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            Log&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;w&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;TAG&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;The following Handler class should be static or leaks might occur: &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
                klass&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getCanonicalName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;());&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这里会检测 Handler 的实现类是否为匿名类/成员类/局部类之一，然后再检测该实现类未使用 &lt;code&gt;static&lt;/code&gt; 关键字修饰，未使用的话便会有内存泄漏的警告。&lt;/p&gt;
&lt;p&gt;那么内存泄漏是如何产生的呢，为何加 static 就可以解决泄漏问题，实现是怎样的呢。&lt;/p&gt;
&lt;h4 id=&#34;12-handler-如何产生内存泄漏&#34;&gt;1.2 Handler 如何产生内存泄漏&lt;/h4&gt;
&lt;p&gt;在继续讨论之前我们先达成如下共识：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;进入 MessageQueue 队列的 msg 对象，其 msg.target 便是对应的 Handler 对象，当 Looper 执行到该 msg 时，会调用 &lt;code&gt;Handler.handleMessage(Message)&lt;/code&gt; 处理消息。&lt;/li&gt;
&lt;li&gt;在 Java 中，非静态（Non-Static）内部类（InnerClass）或匿名类（AnonymousClass）会隐式的持有外部类的引用，同理，静态内部类就不会。&lt;/li&gt;
&lt;li&gt;我们在堆中创建内存而忘记删除它，就会导致了&lt;a href=&#34;https://www.geeksforgeeks.org/what-is-memory-leak-how-can-we-avoid/&#34;&gt;内存泄漏&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;可以看如下的实现：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;MainActivity&lt;/span&gt; : AppCompatActivity() {

    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mHandler = &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;: &lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Handler&lt;/span&gt;() {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handleMessage&lt;/span&gt;(msg: Message) {
            &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.handleMessage(msg)
        }
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mJob = Runnable { &lt;span style=&#34;color:#75715e&#34;&gt;/*do something*/&lt;/span&gt; }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onCreate&lt;/span&gt;(savedInstanceState: Bundle?) {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        mHandler.postDelayed(mJob, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt; * &lt;span style=&#34;color:#ae81ff&#34;&gt;60&lt;/span&gt; * &lt;span style=&#34;color:#ae81ff&#34;&gt;1000L&lt;/span&gt;)
  
        finish()
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上面的代码中，MainActivity 在 mHandler postDelay 任务后便立即销毁，此时主线程中的 mHandler 仍然隐式的持有外部 MainActivity 的引用，该引用会直到 &lt;code&gt;Handler.handleMessage(Message)&lt;/code&gt; 在 5min 后执行后消失，也就是 MainActivity 销毁后并不会被及时的 GC，MainActivity 内的资源得不到释放，从而导致内存泄露。&lt;/p&gt;
&lt;h4 id=&#34;13-如何避免内存泄露&#34;&gt;1.3 如何避免内存泄露&lt;/h4&gt;
&lt;p&gt;为了避免内存泄露我们可以使用弱引用：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;MainActivity&lt;/span&gt; : AppCompatActivity() {

    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;OkHandler&lt;/span&gt;(activity: Activity) : Handler() {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mActivity: WeakReference&amp;lt;Activity&amp;gt; = WeakReference(activity)

        &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handleMessage&lt;/span&gt;(msg: Message) {
            &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; activity = mActivity.&lt;span style=&#34;color:#66d9ef&#34;&gt;get&lt;/span&gt;()
            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (activity != &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !activity.isFinishing) {
                &lt;span style=&#34;color:#75715e&#34;&gt;// execute task
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            }
        }
    }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mJob = Runnable { &lt;span style=&#34;color:#75715e&#34;&gt;/*do something*/&lt;/span&gt; }

    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mHandler = OkHandler(&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;)

    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;onCreate&lt;/span&gt;(savedInstanceState: Bundle?) {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        mHandler.postDelay(mJob, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt; * &lt;span style=&#34;color:#ae81ff&#34;&gt;60&lt;/span&gt; * &lt;span style=&#34;color:#ae81ff&#34;&gt;1000L&lt;/span&gt;)

        finish()
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>Handler in Code</title>
      <link>https://zacash.cn/post/handler-in-code/</link>
      <pubDate>Sun, 12 Apr 2020 20:36:33 +0800</pubDate>
      
      <guid>https://zacash.cn/post/handler-in-code/</guid>
      <description>&lt;h3 id=&#34;handler-的创建&#34;&gt;Handler 的创建&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;在主线程(UI Thread)中：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;MainActivity&lt;/span&gt; : Activity {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; mLeakedHandler = &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;: &lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Handler&lt;/span&gt;() {
        &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handleMessage&lt;/span&gt;(msg: Message) {
            &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.handleMessage(msg)
        }
    }
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;在子线程中：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-kotlin&#34; data-lang=&#34;kotlin&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; thread = &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;: &lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Thread&lt;/span&gt;() {
    &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;run&lt;/span&gt;() {
        Looper.prepare()
        &lt;span style=&#34;color:#66d9ef&#34;&gt;val&lt;/span&gt; handler = &lt;span style=&#34;color:#66d9ef&#34;&gt;object&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;: &lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Handler&lt;/span&gt;() {
            &lt;span style=&#34;color:#66d9ef&#34;&gt;override&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;fun&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handleMessage&lt;/span&gt;(msg: Message) {
                &lt;span style=&#34;color:#66d9ef&#34;&gt;super&lt;/span&gt;.handleMessage(msg)
            }
        }
        Looper.loop()
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;为什么在子线程创建-handler-需要准备-looper而主线程却不用&#34;&gt;为什么在子线程创建 Handler 需要准备 Looper，而主线程却不用&lt;/h4&gt;
&lt;p&gt;因为 ActivityThread 中的 &lt;code&gt;main()&lt;/code&gt; 方法已经为我们初始化了 Looper&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;String&lt;span style=&#34;color:#f92672&#34;&gt;[]&lt;/span&gt; args&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;

    &lt;span style=&#34;color:#75715e&#34;&gt;// Install selective syscall interception
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    AndroidOs&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;install&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;

    Looper&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;prepareMainLooper&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
    ActivityThread thread &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; ActivityThread&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    thread&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;attach&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; startSeq&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;sMainThreadHandler &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        sMainThreadHandler &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; thread&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getHandler&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        Looper&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;myLooper&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setMessageLogging&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt;
                LogPrinter&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Log&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;DEBUG&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ActivityThread&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;));&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    Looper&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;loop&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; RuntimeException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Main thread loop unexpectedly exited&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;handler-和-looper&#34;&gt;Handler 和 Looper&lt;/h3&gt;
&lt;h4 id=&#34;为什么使用-handler-就需要显式的调用-looperprepare-和-looperloop-呢&#34;&gt;为什么使用 Handler 就需要显式的调用 &lt;code&gt;Looper.prepare()&lt;/code&gt; 和 &lt;code&gt;Looper.loop()&lt;/code&gt; 呢&lt;/h4&gt;
&lt;p&gt;我们可以通过观察 Handler 的构造方法理解：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Handler&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@Nullable&lt;/span&gt; Callback callback&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; async&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;

    mLooper &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Looper&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;myLooper&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mLooper &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; RuntimeException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Can&amp;#39;t create handler inside thread &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; Thread&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;currentThread&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; that has not called Looper.prepare()&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    mQueue &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mLooper&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mQueue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    mCallback &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; callback&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    mAsynchronous &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; async&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Looper.myLooper()&lt;/code&gt; 的实现则是：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;@Nullable&lt;/span&gt; Looper &lt;span style=&#34;color:#a6e22e&#34;&gt;myLooper&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; sThreadLocal&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;那么 sThreadLocal 在哪里 set 的呢？答案是 &lt;code&gt;Looper.prepare()&lt;/code&gt; 方法:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;prepare&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; quitAllowed&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;sThreadLocal&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; RuntimeException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Only one Looper may be created per thread&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    sThreadLocal&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;set&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; Looper&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;quitAllowed&lt;span style=&#34;color:#f92672&#34;&gt;));&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以看到 Handler 和 Looper 是绑定的关系，每个 Handler 只会存在一个线程和 Looper，Looper 内的 ThreadLocal 标识对应的线程。&lt;/p&gt;
&lt;h3 id=&#34;handler-的使用&#34;&gt;Handler 的使用&lt;/h3&gt;
&lt;p&gt;根据官方文档的介绍，Handler 通常有2种用法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Schedule to be executed at some point in the future:
Schedule Message 和 Runnable 比较容易理解，Handler 提供了如 &lt;code&gt;sendMessageAtTime(Message, long)&lt;/code&gt; 和 &lt;code&gt;postAtTime(Runnable, long)&lt;/code&gt; 方法，可以设定在未来某个时刻执行任务。&lt;/li&gt;
&lt;li&gt;Enqueue an action to be performed on a different thread than your own:
在别的线程执行任务，我们通常的应用就是在子线程处理耗时任务后，我们可以通过 &lt;code&gt;Handler(getMainLooper())&lt;/code&gt; 来执行更新 UI 的操作。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;handler-和-messagequeue&#34;&gt;Handler 和 MessageQueue&lt;/h3&gt;
&lt;p&gt;观察源码可以发现 handler 的 &lt;code&gt;sendMessage(msg)&lt;/code&gt;、&lt;code&gt;sendMessageDelayed(msg, timeMillis)&lt;/code&gt;、&lt;code&gt;post(runnable)&lt;/code&gt; 方法最后都是通过调用 &lt;code&gt;sendMessageAtTime(msg, uptimeMillis)&lt;/code&gt; 实现：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sendMessageAtTime&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@NonNull&lt;/span&gt; Message msg&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;long&lt;/span&gt; uptimeMillis&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    MessageQueue queue &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mQueue&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;queue &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        RuntimeException e &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; RuntimeException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; sendMessageAtTime() called with no mQueue&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
        Log&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;w&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Looper&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; e&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(),&lt;/span&gt; e&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; enqueueMessage&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;queue&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; msg&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; uptimeMillis&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这里 &lt;code&gt;Handler.mQueue&lt;/code&gt; 是在 Handler 构造方法里通过 &lt;code&gt;mLooper.mQueue&lt;/code&gt; 获取，而 &lt;code&gt;Looper.mQueue&lt;/code&gt; 是在 Looper 初始化时创建:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// android/os/Handler.java
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Handler&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@Nullable&lt;/span&gt; Callback callback&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; async&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
    mLooper &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Looper&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;myLooper&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mLooper &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; RuntimeException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Can&amp;#39;t create handler inside thread &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; Thread&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;currentThread&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt;
                    &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; that has not called Looper.prepare()&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    mQueue &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mLooper&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mQueue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    mCallback &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; callback&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    mAsynchronous &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; async&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;// android/os/Looper.java
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Looper&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; quitAllowed&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    mQueue &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; MessageQueue&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;quitAllowed&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    mThread &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Thread&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;currentThread&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以看到像官方文档描述的那样，每个 Handler 实例都关联着一条线程以及这条线程的消息队列(Each Handler instance is associated with a single thread and that thread&amp;rsquo;s message queue)。&lt;/p&gt;
&lt;h4 id=&#34;消息如何入列&#34;&gt;消息如何入列&lt;/h4&gt;
&lt;p&gt;在 &lt;code&gt;sendMessageAtTime()&lt;/code&gt; 方法最后返回了 &lt;code&gt;Handler.enqueueMessage()&lt;/code&gt; 的值：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;enqueueMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@NonNull&lt;/span&gt; MessageQueue queue&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;@NonNull&lt;/span&gt; Message msg&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;long&lt;/span&gt; uptimeMillis&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;target&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;workSourceUid&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ThreadLocalWorkSource&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getUid&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mAsynchronous&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setAsynchronous&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; queue&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;enqueueMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; uptimeMillis&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Handler.enqueueMessage()&lt;/code&gt; 调用的 &lt;code&gt;MessageQueue.enqueueMessage()&lt;/code&gt; 实现如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;enqueueMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Message msg&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;long&lt;/span&gt; when&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;target&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; IllegalArgumentException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Message must have a target.&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isInUse&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; IllegalStateException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; This message is already in use.&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#66d9ef&#34;&gt;synchronized&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mQuitting&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            IllegalStateException e &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; IllegalStateException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;
                    msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;target&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; sending message to a Handler on a dead thread&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            Log&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;w&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;TAG&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; e&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;getMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(),&lt;/span&gt; e&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;recycle&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;markInUse&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
        msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;when&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; when&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        Message p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mMessages&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;boolean&lt;/span&gt; needWake&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; when &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; 0 &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; when &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;when&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#75715e&#34;&gt;// New head, wake up the event queue if blocked.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            mMessages &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; msg&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            needWake &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mBlocked&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#75715e&#34;&gt;// Inserted within the middle of the queue.  Usually we don&amp;#39;t have to wake
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// up the event queue unless there is a barrier at the head of the queue
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#75715e&#34;&gt;// and the message is the earliest asynchronous message in the queue.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            needWake &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mBlocked &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;target&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isAsynchronous&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
            Message prev&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(;;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                prev &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; when &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;when&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;needWake &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isAsynchronous&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                    needWake &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
                &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
            msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;// invariant: p == prev.next
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            prev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; msg&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#75715e&#34;&gt;// We can assume mPtr != 0 because mQuitting is false.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;needWake&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            nativeWake&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mPtr&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们分开来看，这里 &lt;code&gt;msg.target&lt;/code&gt; 即消息对应的 handler, 在 &lt;code&gt;Handler.enqueueMessage()&lt;/code&gt; 方法有赋值。&lt;/p&gt;
&lt;p&gt;MessageQueue 并没有队列的数据结构，而是以单链表的形式存储 msg，&lt;code&gt;mMessages&lt;/code&gt; 为当前链表头部的消息，我们称为 head_msg，当前传入的消息称为 current_msg，&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; when &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; 0 &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; when &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;when&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// New head, wake up the event queue if blocked.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    mMessages &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; msg&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    needWake &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mBlocked&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;if&lt;/code&gt; 的判断是，如果:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1).当前队列没有 head_msg&lt;/li&gt;
&lt;li&gt;2).current_msg 是需要立即执行&lt;/li&gt;
&lt;li&gt;3).current_msg 的执行时间在 head_msg 执行时间之前&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;则将 head_msg 标记为 current_msg 的下一条消息，current_msg 标记为头部消息，并且唤醒当前阻塞的队列。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;// Inserted within the middle of the queue.  Usually we don&amp;#39;t have to wake
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// up the event queue unless there is a barrier at the head of the queue
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// and the message is the earliest asynchronous message in the queue.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    needWake &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; mBlocked &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;target&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isAsynchronous&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    Message prev&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(;;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        prev &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; when &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;when&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;needWake &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;isAsynchronous&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            needWake &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;// invariant: p == prev.next
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    prev&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; msg&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;else&lt;/code&gt; 内的逻辑是，根据 current_msg 的执行时间在消息队列中找到对应的位置入列。&lt;/p&gt;
&lt;h4 id=&#34;何时执行入列的消息&#34;&gt;何时执行入列的消息&lt;/h4&gt;
&lt;p&gt;答案就是在子线程使用 handler 时显式调用的 &lt;code&gt;Looper.loop()&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// android/os/Looper.java
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;loop&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; Looper me &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; myLooper&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;me &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; RuntimeException&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;No Looper; Looper.prepare() wasn&amp;#39;t called on this thread.&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;final&lt;/span&gt; MessageQueue queue &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; me&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mQueue&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(;;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        Message msg &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; queue&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;// might block
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#75715e&#34;&gt;// No message indicates that the message queue is quitting.
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;target&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;dispatchMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;catch&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Exception exception&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; exception&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;finally&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
        msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;recycleUnchecked&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Looper.loop()&lt;/code&gt; 的实现就是在无限循环中不断从消息队列中取出 msg，并在 &lt;code&gt;msg.target&lt;/code&gt;即 handler 中 &lt;code&gt;dispatchMessage&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dispatchMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@NonNull&lt;/span&gt; Message msg&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;callback&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        handleCallback&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mCallback &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;mCallback&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;handleMessage&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;))&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
        handleMessage&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;msg&lt;span style=&#34;color:#f92672&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;msg.callback&lt;/code&gt; 对应的是 &lt;code&gt;Handler.post(runnable)&lt;/code&gt; 传递的 Runnable 对象，而 &lt;code&gt;mCallback.handleMessage(msg)&lt;/code&gt; 或 &lt;code&gt;handleMessage(msg)&lt;/code&gt; 则是实例话 Handler 对象时复写的方法。&lt;/p&gt;
&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;
&lt;p&gt;Handler 帮助我们处理 Message 和 Runnable 对象，每个 Handler 实例都关联着一个线程以及这个线程的 MessageQueue。当你创建一个新的 Handler 对象时，它将与当前所在的线程(UI/Work Thread)和 MessageQueue 绑定在一起，通过 Handler 发出的 Message 或者 Runnable(msg.callback) 会根据执行时间插入 MessageQueue，Looper 会持续不断的从 MessageQueue 取出可执行的 Message 通过 Handler.handleMessage(msg) 处理。&lt;/p&gt;
&lt;p&gt;如下图所示：&lt;img src=&#34;https://i1.wp.com/tutorial.eyehunts.com/wp-content/uploads/2018/08/Android-Handler-Background-Thread-Communicate-with-UI-thread-1.png?resize=1024%2C621&amp;amp;ssl=1&#34; alt=&#34;handler&#34;&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Hugo Basic</title>
      <link>https://zacash.cn/post/hugo-basic/</link>
      <pubDate>Sat, 04 Apr 2020 09:25:04 +0800</pubDate>
      
      <guid>https://zacash.cn/post/hugo-basic/</guid>
      <description>&lt;h2 id=&#34;add-new-content&#34;&gt;Add new content&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;hugo new posts/article-name.md&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&#34;article-meta-info&#34;&gt;Article meta info&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-md&#34; data-lang=&#34;md&#34;&gt;---
title: &amp;#34;New Article&amp;#34;
date: 2020-04-04T09:25:04+08:00
description: &amp;#34;Hugo 的简单用法&amp;#34;
tags: [&amp;#34;hugo&amp;#34;, &amp;#34;pages&amp;#34;]
categories: [&amp;#34;hugo&amp;#34;]
draft: true
---
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;start-server-with-drafts-enabled&#34;&gt;Start server with drafts enabled&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;hugo server -D&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&#34;customize-the-theme&#34;&gt;Customize the theme&lt;/h2&gt;
&lt;p&gt;Open up &lt;code&gt;config.toml&lt;/code&gt; in a text editor:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;baseURL = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://example.org/&amp;#34;&lt;/span&gt;
languageCode = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;en-us&amp;#34;&lt;/span&gt;
title = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;My New Hugo Site&amp;#34;&lt;/span&gt;
theme = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ananke&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;build-static-pages&#34;&gt;Build static pages&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;hugo -D&lt;/code&gt; output will be in &lt;code&gt;./public/&lt;/code&gt; directory by default (&lt;code&gt;-d/--destination&lt;/code&gt; flag to change it, or set &lt;code&gt;publishdir&lt;/code&gt; in the config file)&lt;/p&gt;
&lt;h2 id=&#34;publish-article&#34;&gt;Publish article&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;build web site: &lt;code&gt;hugo -D&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;deploy web site: &lt;code&gt;./deploy.sh &#39;comments&#39;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>Check State Loss</title>
      <link>https://zacash.cn/post/check-state-loss/</link>
      <pubDate>Tue, 11 Feb 2020 16:30:26 +0800</pubDate>
      
      <guid>https://zacash.cn/post/check-state-loss/</guid>
      <description>&lt;h4 id=&#34;背景&#34;&gt;背景&lt;/h4&gt;
&lt;p&gt;最近做的一个 DialogFragment 在少数设备上会偶发闪退，Fabric 上的 Stacktrace 信息如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;Fatal Exception&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; java&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;lang&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;IllegalStateException&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; Can not perform &lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt; action after onSaveInstanceState
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;FragmentManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;checkStateLoss&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;FragmentManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;enqueueAction&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;BackStackRecord&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;commitInternal&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;BackStackRecord&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;commit&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;DialogFragment&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;show&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;）&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;看起来是弹窗在 show 的时候，发生了 state loss，粗略 copy 了下 StackOverflow 上的回答，做了如下修改：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;fun &lt;span style=&#34;color:#a6e22e&#34;&gt;show&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;manager&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; FragmentManager&lt;span style=&#34;color:#f92672&#34;&gt;?)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
 &lt;span style=&#34;color:#66d9ef&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
   val ft &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; manager&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;beginTransaction&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt;
   ft&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;tag of dialog&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
   ft&lt;span style=&#34;color:#f92672&#34;&gt;?.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;commitAllowingStateLoss&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;()&lt;/span&gt;
 &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;catch&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;e&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; Exception&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;

 &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;重写了 show 方法，允许 state loss，并加了异常捕捉，后续观察 Fabric， show 的时候的确没再出现异常情况，但 dismiss 的时候还是有闪退出现，异常信息如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-java&#34; data-lang=&#34;java&#34;&gt;Fatal Exception&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; java&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;lang&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;IllegalStateException&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; Can not perform &lt;span style=&#34;color:#66d9ef&#34;&gt;this&lt;/span&gt; action after onSaveInstanceState
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;FragmentManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;checkStateLoss&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;FragmentManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;enqueueAction&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;BackStackRecord&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;commitInternal&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;BackStackRecord&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;commit&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
       at android&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;support&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;v4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;DialogFragment&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;dismiss&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SourceFile&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;）&lt;/span&gt;  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以看到与 show 出现的闪退如出一辙，只是闪退触发的位置换成了 dismiss，按照之前对 show 的修改，是不是也可以把 dismiss 方法也改下呢，实际上还真有 &lt;code&gt;dismissAllowingStateLoss()&lt;/code&gt; 方法。。。但是真的可以这样写么？是什么原因导致的 state loss？如何才能有效避免这种情况呢？&lt;/p&gt;
&lt;p&gt;仔细看了下 Stack Overflow 问题下的评论，发现 &lt;a href=&#34;https://twitter.com/alexjlockwood&#34;&gt;Alex Lockwood&lt;/a&gt; 写的&lt;a href=&#34;https://www.androiddesignpatterns.com/2013/08/fragment-transaction-commit-state-loss.html&#34;&gt;一篇文章&lt;/a&gt;分析的很全面，下面对重点内容翻译一下。&lt;/p&gt;
&lt;h4 id=&#34;为什么会抛异常&#34;&gt;为什么会抛异常&lt;/h4&gt;
&lt;p&gt;简单来说，就是你在 Activity state saved 后，仍旧 commit 一个 FragmentTransaction，从而导致出现了所谓的 &lt;code&gt;Activity state loss&lt;/code&gt; 现象。所以 &lt;code&gt;onSaveInstanceState()&lt;/code&gt; 时发生了什么？&lt;/p&gt;
&lt;h5 id=&#34;onsaveinstancestate&#34;&gt;onSaveInstanceState&lt;/h5&gt;
&lt;p&gt;Android 系统可以随时终止进程以释放内存，因此置于后台的 Activity 随时可能会被清理。Android framework 提供给每个 Activity 在被系统销毁前调用 &lt;code&gt;onSaveInstanceState&lt;/code&gt; 以保存其状态(state)的机会，在随后恢复(restore)被保存的状态时，用户会感觉在无缝切换前/后台Activity，而不会察觉 Activity 会系统清理过。&lt;/p&gt;
&lt;p&gt;当调用 &lt;code&gt;onSaveInstanceState&lt;/code&gt; 方法时，Android Framework 将为 Acitvity 提供一个 Bundle 对象保存其状态，Activity 将记录 dialogs, fragments, views 的状态。在这个方法返回时，系统通过 Binder 接口将 Bundle 对象打包(parcel)到 System Server 进程。随后当系统决定重建(recreate) Activity 时，它将之前保存的 Bundle 发回 App，来恢复 Activity 旧的状态。&lt;/p&gt;
&lt;p&gt;所以为什么回抛异常？原因就是在 &lt;code&gt;onSaveInstanceState&lt;/code&gt; 调用后，你调用了 &lt;code&gt;FragmentTransaction#commit()&lt;/code&gt;，因此 &lt;code&gt;onSaveInstanceState&lt;/code&gt; 方法返回的 &lt;code&gt;Bundle&lt;/code&gt; 对象并不包含该事务(transaction)。在用户的角度来看，事务被忽略，UI 状态丢失，Android 为了避免这种情况,只要发生状态丢失(state loss)便立即抛出 &lt;code&gt;IllegalStateException&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&#34;何时抛出异常&#34;&gt;何时抛出异常&lt;/h4&gt;
&lt;p&gt;从 Honeycomb 开始，&lt;code&gt;onSaveInstanceState()&lt;/code&gt; 在生命周期 &lt;code&gt;onStop()&lt;/code&gt; 方法之前调用，而不是 &lt;code&gt;pre-Honeycomb&lt;/code&gt;时的 &lt;code&gt;onPause()&lt;/code&gt; 之前。&lt;/p&gt;
&lt;h4 id=&#34;如何避免异常&#34;&gt;如何避免异常&lt;/h4&gt;
&lt;p&gt;这里有一些关于在 App 中使用 &lt;code&gt;FragmentTransaction&lt;/code&gt; 的建议：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt; 在 Activity 的生命周期方法 &lt;em&gt;提交事务(commit transaction)&lt;/em&gt;：
当你在 &lt;code&gt;onCreate()&lt;/code&gt; 方法 commit 事务可能从来不会碰到问题，但当你在 &lt;code&gt;onActivityResult()&lt;/code&gt;、&lt;code&gt;onStart()&lt;/code&gt;、&lt;code&gt;onResume&lt;/code&gt; commit 时，事情变得有趣了起来。比如，你不应该在 &lt;code&gt;FragmentActivity#onResume()&lt;/code&gt; 方法里 commit 事务，因为在&lt;a href=&#34;http://developer.android.com/reference/android/support/v4/app/FragmentActivity.html#onResume()&#34;&gt;某些情况&lt;/a&gt;下，Activity 会在恢复状态(restore state)之前调用 &lt;code&gt;onResume()&lt;/code&gt; 方法。如果你的 App 需要在 &lt;code&gt;onCreate()&lt;/code&gt; 方法以外 commit 事务，尝试在 &lt;code&gt;FragmentActivity#onResumeFragments()&lt;/code&gt; 或 &lt;code&gt;Activity#onPostResume()&lt;/code&gt; 方法内 commit，这两个方法会确保在 Activity restore state 后调用，因此避免了 state loss 的可能。对于这个例子的描述，可以参考 StackOverflow 上这个&lt;a href=&#34;http://stackoverflow.com/q/16265733/844882&#34;&gt;回答&lt;/a&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;避免&lt;/strong&gt; 在异步回调方法中操作事务:
主要原因是，在异步回调方法执行时，并不了解 Activity 当前的生命周期状态，因此很可能在 &lt;code&gt;onStop()&lt;/code&gt; 调用时 commit 事务，从而抛出异常。这种情况可以参考 StackOverflow 上&lt;a href=&#34;http://stackoverflow.com/q/8040280/844882&#34;&gt;这个回答&lt;/a&gt;和&lt;a href=&#34;http://stackoverflow.com/q/7992496/844882&#34;&gt;这个回答&lt;/a&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;commitAllowingStateLoss()&lt;/code&gt; 仅作为最后的手段：
&lt;code&gt;commitAllowingStateLoss()&lt;/code&gt; 与 &lt;code&gt;commit()&lt;/code&gt; 方法唯一的区别便是该方法在状态丢失时不会抛异常。一般情况下不要使用该方法，一种更好的方式，便是确保在 Activity save state 之前 commit 事务。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;最后&#34;&gt;最后&lt;/h4&gt;
&lt;p&gt;回归到我的 DialogFragment 为何出现异常，原因是我 commit transaction 位置是在 &lt;code&gt;FragmentActivity#onResume()&lt;/code&gt;方法内:-)&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title></title>
      <link>https://zacash.cn/post/when-to-use-lazy-or-lateinit/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>https://zacash.cn/post/when-to-use-lazy-or-lateinit/</guid>
      <description></description>
    </item>
    
  </channel>
</rss>